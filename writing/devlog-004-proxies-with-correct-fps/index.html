<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>
      DevLog 004: Proxies with correct FPS | Rickard Lindberg
    </title>

    <!-- Bootstrap -->
    <link href="../../static/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <meta name="keywords" content="programming, writing" />
    <meta name="description" content="Rickard Lindberg">
    <link rel="stylesheet" href="../../static/layout.css" type="text/css">
    <link rel="stylesheet" href="../../static/syntax.css" type="text/css">
    <link rel="alternate" href="../../atom.xml" type="application/atom+xml" title="Atom feed">
    <link rel="alternate" href="../../rss.xml" type="application/rss+xml" title="RSS feed">
    <link rel="me" href="https://hachyderm.io/@rickardlindberg">
  </head>
  <body>

    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../">rickardlindberg.me</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="../../">Home</a></li>
            <li><a href="../../writing/">Writing</a></li>
            <li><a href="../../writing/newsletter/">Newsletter</a></li>
            <li><a href="../../projects/">Projects</a></li>
            <li><a href="../../contact/">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <h1>DevLog 004: Proxies with correct FPS</h1>

<p><em>Published on 30 July 2023.</em></p>

<p>In this episode we will continue work on the <a href="../../projects/rlvideo/">video editor</a>. I have some footage that I would like to edit. Wouldn’t it be cool if I can do that in my own video editor? I will use that as a guide for the development. What is stopping me from using my video editor today? Fix that and move on to the next thing.</p>
<p>In this episode we will fix an issue with proxy clips sometimes having the incorrect FPS.</p>
<h2 id="why-devlogs">Why DevLogs?</h2>
<p>I do them for various reasons. Here are the ones that I can think of now.</p>
<ul>
<li><p>I think there is value in documenting the work that I do.</p></li>
<li><p>People reading these DevLogs might pick up something that I do and incorporate into their workflow.</p></li>
<li><p>Clear thinking is clear writing and vice versa. Writing helps me think more clearly about topics. Sometimes, by writing about a problem, I think I can reach a solution faster even though writing takes time.</p></li>
<li><p>I want to practice writing.</p></li>
</ul>
<h2 id="the-problem-with-proxies-and-fps">The problem with proxies and FPS</h2>
<p>For most of my videos, I use a frame rate of 25. That is 25 frames per second (FPS). I have coded that as a default in the video editor.</p>
<p>However, sometimes I shoot footage in a higher frame rate and slow it down in post.</p>
<p>Here is an example:</p>
<pre class="shell"><code>$ ffprobe GX010802.MP4 2&gt;&amp;1 | grep fps
  Stream #0:0(eng): Video: hevc (Main) (hvc1 / 0x31637668), yuvj420p(pc, bt709), 2704x1520 [SAR 1:1 DAR 169:95], 97187 kb/s, 100 fps, 100 tbr, 90k tbn, 100 tbc (default)</code></pre>
<p>You can see there in the middle that is says <code>100 fps</code>.</p>
<p>When I drop this clip on a 25 FPS timeline, only every 4th frame will be used from that clip and the rest are discarded. However, if I slow down the clip to 25% speed, the runtime will be 4 times longer and all the frames will be used.</p>
<p>The problem is that the video editor uses proxy clips for preview. A proxy clip is typically a lower resolution version of the original clip to allow real time editing on a slower computer.</p>
<p>And proxy clips are currently generated with the same frame rate as the project (which is 25).</p>
<p>Here is what <code>ffprobe</code> says about our proxy clip:</p>
<pre class="shell"><code>$ ffprobe /tmp/de63dcd626503cbde6f3da76b0af3e8c.mkv 2&gt;&amp;1 | grep fps
  Stream #0:0: Video: mjpeg (Baseline), yuvj420p(pc, bt470bg/bt709/bt709), 960x540 [SAR 1:1 DAR 16:9], 25 fps, 25 tbr, 1k tbn, 1k tbc (default)</code></pre>
<h2 id="proxy-generation-today">Proxy generation today</h2>
<p>With some details removed, here is how proxies are generated today:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>producer <span class="op">=</span> mlt.Producer(profile, CLIP_PATH)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>consumer <span class="op">=</span> mlt.Consumer(proxy_profile, <span class="st">&quot;avformat&quot;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>consumer.<span class="bu">set</span>(<span class="st">&quot;target&quot;</span>, PROXY_PATH)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>consumer.<span class="bu">set</span>(<span class="st">&quot;vcodec&quot;</span>, <span class="st">&quot;mjpeg&quot;</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>consumer.<span class="bu">set</span>(<span class="st">&quot;acodec&quot;</span>, <span class="st">&quot;pcm_s16le&quot;</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>consumer.<span class="bu">set</span>(<span class="st">&quot;qscale&quot;</span>, <span class="st">&quot;3&quot;</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>consumer.<span class="ex">connect</span>(producer)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>consumer.start()</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a><span class="cf">while</span> consumer.is_stopped() <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>    time.sleep(<span class="fl">0.5</span>)</span></code></pre></div>
<p>The <code>profile</code> and the <code>proxy_profile</code> differ only in that the <code>proxy_profile</code> has a lower resolution (width x height). They are otherwise identical.</p>
<p>What we need to do is to get the profile for a consumer and only change the size of it. We want the profile FPS to be the FPS of the clip.</p>
<h2 id="sidetracked">Sidetracked</h2>
<p>As I start writing some code, I notice something odd in the output of the tests:</p>
<pre><code>.............................[matroska,webm @ 0x5599e1354fc0] Could not find codec parameters for stream 0 (Video: mjpeg, none(pc, bt470bg/bt470bg/smpte170m), 720x576): unspecified pixel format
Consider increasing the value for the 'analyzeduration' (0) and 'probesize' (5000000) options
[matroska,webm @ 0x5599e0f51540] Could not find codec parameters for stream 0 (Video: mjpeg, none(pc, bt470bg/bt470bg/smpte170m), 720x576): unspecified pixel format
Consider increasing the value for the 'analyzeduration' (0) and 'probesize' (5000000) options
....................
----------------------------------------------------------------------
Ran 49 tests in 2.001s</code></pre>
<p>I <code>git stash</code> my current changes and see that the output is still there.</p>
<p>I increase the verbosity of the test runner to figure out which test is causing the output and I get this:</p>
<pre><code>Doctest: rlvideolib.domain.project.Project ... [matroska,webm @ 0x56544c299700] Could not find codec parameters for stream 0 (Video: mjpeg, none(pc, bt470bg/bt470bg/smpte170m), 720x576): unspecified pixel format
Consider increasing the value for the 'analyzeduration' (0) and 'probesize' (5000000) options
[matroska,webm @ 0x56544c4061c0] Could not find codec parameters for stream 0 (Video: mjpeg, none(pc, bt470bg/bt470bg/smpte170m), 720x576): unspecified pixel format
Consider increasing the value for the 'analyzeduration' (0) and 'probesize' (5000000) options</code></pre>
<p>The problem is that there is a sort of integration test that, when run, generates proxy clips, and the output is not captured in the test and instead redirected to the terminal.</p>
<p>I add the <code>capture_stdout_stderr</code> helper in the test, and the output now looks clean.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; with capture_stdout_stderr():</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="co">...     with project.new_transaction() as transaction:</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="co">...         ...</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>Let’s commit:</p>
<pre><code>$ ./make.py commit -m 'Capture stdout/stderr in Project test to not clutter the test output.'
.................................................
----------------------------------------------------------------------
Ran 49 tests in 1.990s

OK
[main 9846016] Capture stdout/stderr in Project test to not clutter the test output.
 1 file changed, 4 insertions(+), 3 deletions(-)</code></pre>
<p>Sometimes when I encounter a small problem when working on something, I prefer to <code>git stash</code> my changes, fix the small problem, and then get back to what I was working on with <code>git stash pop</code>.</p>
<p>If the problem turns out to be not so small, I might write a note about it instead.</p>
<h2 id="back-to-the-problem">Back to the problem</h2>
<p>I create this function to get a native producer and profile:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">def</span> mlt_producer_with_native_profile(path):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="co">    &gt;&gt;&gt; _ = mlt.Factory().init()</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="co">    &gt;&gt;&gt; producer, profile = mlt_producer_with_native_profile(&quot;resources/one.mp4&quot;)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a><span class="co">    &gt;&gt;&gt; profile.fps()</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="co">    25.0</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>    profile <span class="op">=</span> mlt.Profile()</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>    producer <span class="op">=</span> mlt.Producer(profile, path)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>    profile.from_producer(producer)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>    <span class="co"># Re-open the producer with the new profile to ensure it gets all the</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a>    <span class="co"># properties from it and does not retain properties from the old profile.</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a>    producer <span class="op">=</span> mlt.Producer(profile, path)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a>    <span class="cf">return</span> (producer, profile)</span></code></pre></div>
<p>I don’t have any clips in the resources folder that are other than 25 FPS, but this at leas shows that my code doesn’t crash.</p>
<p>I try to use it when generating proxies. The tests pass after my modification, so I try to run the application with my 100 FPS test clip and get this:</p>
<pre><code>$ rm /tmp/*.mkv; rlvideo GX010802.MP4
...
  File &quot;/home/rick/rlvideo/rlvideolib/domain/source.py&quot;, line 59, in load_proxy
    assert self.length == native_producer.get_playtime()</code></pre>
<p>This reveals a problem to me. In the Python structures for a <code>Source</code> we store its length. My intention was to store the number of frames in the file so that we can check that we make valid cuts:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">class</span> FileSource(namedtuple(<span class="st">&quot;FileSource&quot;</span>, <span class="st">&quot;id,path,length&quot;</span>)):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>    ...</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>    <span class="kw">def</span> create_cut(<span class="va">self</span>, start, end):</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>        <span class="cf">if</span> start <span class="op">&lt;</span> <span class="dv">0</span> <span class="kw">or</span> end <span class="op">&gt;</span> <span class="va">self</span>.length:</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>            <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">&quot;Invalid cut.&quot;</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>        ...</span></code></pre></div>
<p>But I think the <code>producer.get_playtime()</code> is not giving frames, but rather frames at the current frame rate. A quick test confirms that this is the case:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; profile = mlt.Profile()</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; profile.fps()</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a><span class="co">25.0</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; producer = mlt.Producer(profile, &quot;resources/one.mp4&quot;)</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; producer.get_playtime()</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a><span class="co">15</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; profile.set_frame_rate(50, 1)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; profile.fps()</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a><span class="co">50.0</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; producer = mlt.Producer(profile, &quot;resources/one.mp4&quot;)</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; producer.get_playtime()</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a><span class="co">31</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>What to do?</p>
<p>I think it’s time for another <code>git stash</code> and clarify length.</p>
<h2 id="clarify-length">Clarify length</h2>
<p>I want to rename <code>FileSource.length</code> to <code>FileSource.number_of_frames_at_project_fps</code>. That is a really long name, but it is more clear about what it represents. I value that more now. After the refactoring, I might uncover other issues. Let’s see.</p>
<pre><code>$ ./make.py commit -m 'Rename FileSource.length to FileSource.number_of_frames_at_project_fps.'
.................................................
----------------------------------------------------------------------
Ran 49 tests in 1.994s

OK
[main 8baae0a] Rename FileSource.length to FileSource.number_of_frames_at_project_fps.
 2 files changed, 10 insertions(+), 10 deletions(-)</code></pre>
<p>The parameter is used in only one place outside <code>FileSource</code>:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="kw">class</span> Transaction:</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>    ...</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>    <span class="kw">def</span> add_clip(<span class="va">self</span>, path, <span class="bu">id</span><span class="op">=</span><span class="va">None</span>):</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>        producer <span class="op">=</span> mlt.Producer(<span class="va">self</span>.project.profile, path)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>        source <span class="op">=</span> FileSource(<span class="bu">id</span><span class="op">=</span><span class="bu">id</span>, path<span class="op">=</span>path, number_of_frames_at_project_fps<span class="op">=</span>producer.get_playtime())</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">self</span>.add_source(source, source.number_of_frames_at_project_fps)</span></code></pre></div>
<p>I find it a little unclear the connection between a producer, its playtime, and the number of frames. Let’s see if we can make a helper to clarify this:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="kw">def</span> add_clip(<span class="va">self</span>, path, <span class="bu">id</span><span class="op">=</span><span class="va">None</span>):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>    source <span class="op">=</span> FileSource(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>        <span class="bu">id</span><span class="op">=</span><span class="bu">id</span>,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>        path<span class="op">=</span>path,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>        number_of_frames_at_project_fps<span class="op">=</span>FileInfo(</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>            path</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a>        ).get_number_of_frames(<span class="va">self</span>.project.profile)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a>    )</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a>    <span class="cf">return</span> <span class="va">self</span>.add_source(source, source.number_of_frames_at_project_fps)</span></code></pre></div>
<p>And here is <code>FileInfo</code>:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a><span class="kw">class</span> FileInfo:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, path):</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true"></a>        <span class="va">self</span>.path <span class="op">=</span> path</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true"></a>    <span class="kw">def</span> get_number_of_frames(<span class="va">self</span>, profile):</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true"></a>        <span class="cf">return</span> mlt.Producer(profile, <span class="va">self</span>.path).get_playtime()</span></code></pre></div>
<p>This makes it a little more clear that the number of frames in a file depends on the profile.</p>
<pre><code>$ ./make.py commit -m 'Extract FileInfo.'
.................................................
----------------------------------------------------------------------
Ran 49 tests in 1.982s

OK
[main fd89715] Extract FileInfo.
 1 file changed, 15 insertions(+), 2 deletions(-)</code></pre>
<h2 id="change-project-fps-after">Change project FPS after?</h2>
<p>This brings up the question if we can change the project frame rate after we have added some clips.</p>
<p>My guess is not.</p>
<p>I remember reading that you should never do this in Kdenlive. Then weird things will happen.</p>
<p>I suppose we could try to re-calculate all positions and lengths when we change the frame rate. Or have the unit of measurement be time instead. But I think that will be hard since that is not what MLT works with, and also, it make sense to work in terms of frames.</p>
<p>I add a note in the source code about this and move on. This is probably fine.</p>
<h2 id="back">Back</h2>
<p>I <code>git stash pop</code> my earlier changes. Because of the rename, I have to resolve conflicts, but it goes well.</p>
<p>I then spot this:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a>native_producer, native_profile <span class="op">=</span> mlt_producer_with_native_profile(<span class="va">self</span>.path)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a><span class="cf">assert</span> <span class="va">self</span>.number_of_frames_at_project_fps <span class="op">==</span> native_producer.get_playtime()</span></code></pre></div>
<p>With our new knowledge, this is obviously wrong. And the new name helps us see that. The native profile has the FPS of the clip whereas the project profile has the FPS of the project. Those might not be the same, so therefore the assertion is not always going to work.</p>
<p>I see some more usages for <code>FileInfo</code>, so I yet again stash my changes and update <code>FileInfo</code> to this:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="kw">class</span> FileInfo:</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, path):</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a>        <span class="va">self</span>.path <span class="op">=</span> path</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true"></a>    <span class="kw">def</span> get_number_of_frames(<span class="va">self</span>, profile):</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true"></a>        <span class="cf">return</span> <span class="va">self</span>.get_mlt_producer(profile).get_playtime()</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true"></a>    <span class="kw">def</span> get_mlt_producer(<span class="va">self</span>, profile):</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true"></a>        <span class="cf">return</span> mlt.Producer(profile, <span class="va">self</span>.path)</span></code></pre></div>
<p>Commit:</p>
<pre class="shell"><code>$ ./make.py commit -m 'Allow clearer code by extending FileInfo.'
.................................................
----------------------------------------------------------------------
Ran 49 tests in 1.996s

OK
[main acb6702] Allow clearer code by extending FileInfo.
 4 files changed, 18 insertions(+), 11 deletions(-)
 create mode 100644 rlvideolib/mlthelpers.py</code></pre>
<h2 id="break">Break</h2>
<p>I’m having a hard time reasoning about proxy generation code. I decide it’s time for a break.</p>
<h2 id="another-strategy">Another strategy</h2>
<p>So far we have made no actual progress on improving proxy generation, but we have cleaned up the code in related areas and gained some new knowledge.</p>
<p>Since I was not able to fix the proxy generation in a small step, I decide to change approach and take much smaller steps.</p>
<p>Let’s see if we can refactor the <code>load_proxy</code> method and perhaps we might see more clearly how to modify it.</p>
<p>For reference, this is what it looks now:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="kw">def</span> load_proxy(<span class="va">self</span>, profile, proxy_profile, progress):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a>    producer <span class="op">=</span> mlt.Producer(profile, <span class="va">self</span>.path)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>    <span class="cf">assert</span> <span class="va">self</span>.number_of_frames_at_project_fps <span class="op">==</span> producer.get_playtime()</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>    chechsum <span class="op">=</span> md5(<span class="va">self</span>.path)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>    proxy_path <span class="op">=</span> <span class="ss">f&quot;/tmp/</span><span class="sc">{</span>chechsum<span class="sc">}</span><span class="ss">.mkv&quot;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>    proxy_tmp_path <span class="op">=</span> <span class="ss">f&quot;/tmp/</span><span class="sc">{</span>chechsum<span class="sc">}</span><span class="ss">.tmp.mkv&quot;</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(proxy_path):</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a>        consumer <span class="op">=</span> mlt.Consumer(proxy_profile, <span class="st">&quot;avformat&quot;</span>)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>        consumer.<span class="bu">set</span>(<span class="st">&quot;target&quot;</span>, proxy_tmp_path)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>        consumer.<span class="bu">set</span>(<span class="st">&quot;vcodec&quot;</span>, <span class="st">&quot;mjpeg&quot;</span>)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>        consumer.<span class="bu">set</span>(<span class="st">&quot;acodec&quot;</span>, <span class="st">&quot;pcm_s16le&quot;</span>)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a>        consumer.<span class="bu">set</span>(<span class="st">&quot;qscale&quot;</span>, <span class="st">&quot;3&quot;</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a>        consumer.<span class="ex">connect</span>(producer)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a>        consumer.start()</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true"></a>        <span class="cf">while</span> consumer.is_stopped() <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true"></a>            progress(producer.position()<span class="op">/</span>producer.get_playtime())</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true"></a>            time.sleep(<span class="fl">0.5</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true"></a>        os.rename(proxy_tmp_path, proxy_path)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true"></a>    producer <span class="op">=</span> mlt.Producer(profile, proxy_path)</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true"></a>    <span class="cf">assert</span> <span class="va">self</span>.number_of_frames_at_project_fps <span class="op">==</span> producer.get_playtime()</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true"></a>    <span class="cf">return</span> producer</span></code></pre></div>
<p>Let’s try to extract <code>get_file_info</code> (which can then also be used in another place):</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="kw">def</span> get_file_info(<span class="va">self</span>, profile):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>    file_info <span class="op">=</span> FileInfo(<span class="va">self</span>.path)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>    <span class="cf">assert</span> <span class="va">self</span>.number_of_frames_at_project_fps <span class="op">==</span> file_info.get_number_of_frames(profile)</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a>    <span class="cf">return</span> file_info</span></code></pre></div>
<p>In <code>load_proxy</code> we can use it like this:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true"></a><span class="st">-        producer = mlt.Producer(profile, self.path)</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true"></a><span class="st">-        assert self.number_of_frames_at_project_fps == producer.get_playtime()</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true"></a><span class="va">+        file_info = self.get_file_info(profile)</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true"></a>         chechsum = md5(self.path)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true"></a>         proxy_path = f&quot;/tmp/{chechsum}.mkv&quot;</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true"></a>         proxy_tmp_path = f&quot;/tmp/{chechsum}.tmp.mkv&quot;</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true"></a>         if not os.path.exists(proxy_path):</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true"></a><span class="va">+            producer = file_info.get_mlt_producer(profile)</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true"></a>             consumer = mlt.Consumer(proxy_profile, &quot;avformat&quot;)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true"></a>             consumer.set(&quot;target&quot;, proxy_tmp_path)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true"></a>             consumer.set(&quot;vcodec&quot;, &quot;mjpeg&quot;)</span></code></pre></div>
<p>This ensures that the file has the same length as we have recorded.</p>
<p>Let’s extract <code>run_consumer</code>:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="kw">def</span> run_consumer(consumer, producer, progress):</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a>    consumer.<span class="ex">connect</span>(producer)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a>    consumer.start()</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true"></a>    <span class="cf">while</span> consumer.is_stopped() <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true"></a>        progress(producer.position()<span class="op">/</span>producer.get_playtime())</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true"></a>        time.sleep(<span class="fl">0.5</span>)</span></code></pre></div>
<p>I forgot to commit last refactoring. Let’s do that now:</p>
<pre><code>$ ./make.py commit -m 'Extract get_file_info and run_consumer.'
.................................................
----------------------------------------------------------------------
Ran 49 tests in 1.983s

OK
[main 49df31e] Extract get_file_info and run_consumer.
 2 files changed, 20 insertions(+), 11 deletions(-)</code></pre>
<p>There is a test for proxy generation, but it does not run fully if the proxy file already exists. I add a testing flag that we can set to True in tests. I’m not sure I like this, but it will help us when refactoring this method:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="kw">def</span> load_proxy(<span class="va">self</span>, profile, proxy_profile, progress, testing<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a>    ...</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a>    proxy_tmp_path <span class="op">=</span> <span class="ss">f&quot;/tmp/</span><span class="sc">{</span>chechsum<span class="sc">}</span><span class="ss">.tmp.mkv&quot;</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(proxy_path) <span class="kw">or</span> testing:</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true"></a>        producer <span class="op">=</span> file_info.get_mlt_producer(profile)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true"></a>        ...</span></code></pre></div>
<h2 id="break-1">Break</h2>
<p>I keep trying to clean up the proxy loading code but I just can’t seem to find the right abstractions. Furthermore, I get segfaults and all kinds of strange behavior from MLT. This demotivates me. I force myself to take a break.</p>
<h2 id="revert">Revert</h2>
<p>Since MLT is giving me all kinds of weird behavior, I think that perhaps the <code>get_file_info</code> abstraction was wrong. Maybe it creates more trouble at the moment. Let’s see if we can inline some of it instead.</p>
<p>We get this:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true"></a><span class="dt">@@ -65,12 +65,11 @@ class FileSource(namedtuple(&quot;FileSource&quot;, &quot;id,path,number_of_frames_at_project_f</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true"></a>         &quot;&quot;&quot;</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true"></a>         # TODO: generate proxy with same profile as source clip (same colorspace, etc,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true"></a>         # but with smaller size)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true"></a><span class="st">-        file_info = self.get_file_info(profile)</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true"></a><span class="va">+        producer = self.validate_producer(mlt.Producer(profile, self.path))</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true"></a>         chechsum = md5(self.path)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true"></a>         proxy_path = f&quot;/tmp/{chechsum}.mkv&quot;</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true"></a>         proxy_tmp_path = f&quot;/tmp/{chechsum}.tmp.mkv&quot;</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true"></a>         if not os.path.exists(proxy_path) or testing:</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true"></a><span class="st">-            producer = file_info.get_mlt_producer(profile)</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true"></a>             consumer = mlt.Consumer(proxy_profile, &quot;avformat&quot;)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true"></a>             consumer.set(&quot;target&quot;, proxy_tmp_path)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true"></a>             consumer.set(&quot;vcodec&quot;, &quot;mjpeg&quot;)</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true"></a><span class="dt">@@ -78,14 +77,11 @@ class FileSource(namedtuple(&quot;FileSource&quot;, &quot;id,path,number_of_frames_at_project_f</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true"></a>             consumer.set(&quot;qscale&quot;, &quot;3&quot;)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true"></a>             run_consumer(consumer, producer, progress)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true"></a>             os.rename(proxy_tmp_path, proxy_path)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true"></a><span class="st">-        producer = mlt.Producer(profile, proxy_path)</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true"></a><span class="st">-        assert self.number_of_frames_at_project_fps == producer.get_playtime()</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true"></a><span class="st">-        return producer</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true"></a><span class="va">+        return self.validate_producer(mlt.Producer(profile, proxy_path))</span></span></code></pre></div>
<p>Where <code>validate_producer</code> is this:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="kw">def</span> validate_producer(<span class="va">self</span>, producer):</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a>    <span class="cf">assert</span> producer.get_playtime() <span class="op">==</span> <span class="va">self</span>.number_of_frames_at_project_fps</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a>    <span class="cf">return</span> producer</span></code></pre></div>
<p>Commit:</p>
<pre><code>$ ./make.py commit -m 'Inline some of FileInfo.'
.................................................
----------------------------------------------------------------------
Ran 49 tests in 2.493s

OK
[main c47ea68] Inline some of FileInfo.
 2 files changed, 7 insertions(+), 14 deletions(-)</code></pre>
<p>Then finally I can make this relatively small change:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a><span class="dt">@@ -70,7 +70,12 @@ class FileSource(namedtuple(&quot;FileSource&quot;, &quot;id,path,number_of_frames_at_project_f</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a>         proxy_path = f&quot;/tmp/{chechsum}.mkv&quot;</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true"></a>         proxy_tmp_path = f&quot;/tmp/{chechsum}.tmp.mkv&quot;</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true"></a>         if not os.path.exists(proxy_path) or testing:</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true"></a><span class="st">-            consumer = mlt.Consumer(proxy_profile, &quot;avformat&quot;)</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true"></a><span class="va">+            p = mlt.Profile()</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true"></a><span class="va">+            p.from_producer(producer)</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true"></a><span class="va">+            p.set_width(proxy_profile.width())</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true"></a><span class="va">+            p.set_height(proxy_profile.height())</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true"></a><span class="va">+            producer = mlt.Producer(p, self.path)</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true"></a><span class="va">+            consumer = mlt.Consumer(p, &quot;avformat&quot;)</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true"></a>             consumer.set(&quot;target&quot;, proxy_tmp_path)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true"></a>             consumer.set(&quot;vcodec&quot;, &quot;mjpeg&quot;)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true"></a>             consumer.set(&quot;acodec&quot;, &quot;pcm_s16le&quot;)</span></code></pre></div>
<p>With this, proxy clips now retain their FPS:</p>
<pre><code>$ ffprobe /tmp/de63dcd626503cbde6f3da76b0af3e8c.mkv 2&gt;&amp;1 | grep fps
  Stream #0:0: Video: mjpeg (Baseline), yuvj420p(pc, bt470bg/bt709/bt709), 960x540 [SAR 1:1 DAR 16:9], 100 fps, 100 tbr, 1k tbn, 1k tbc (default)</code></pre>
<p>It seems to work fine in the application as well.</p>
<p>Let’s commit this:</p>
<pre><code>$ ./make.py commit -m 'Produce proxy clips with native profile to preserve FPS.'
.................................................
----------------------------------------------------------------------
Ran 49 tests in 2.560s

OK
[main b69cfb7] Produce proxy clips with native profile to preserve FPS.
 1 file changed, 6 insertions(+), 3 deletions(-)</code></pre>
<h2 id="summary">Summary</h2>
<p>This session turned out to be rather painful. Every time I do something that involves MLT, things get painful. That tells med to isolate as much of the MLT code as possible. It also tells me that I need to learn MLT better to understand issues.</p>
<p>But segfaults worry me a bit. When working in Python, we should really not be getting segfaults. Is there something wrong in the Python binding for MLT?</p>
<p>I’m sure we have to revisit proxy generation at some point. But I’m done for now.</p>

      <div class="jumbotron">
<div class="row">
<div class="col-md-12">

<p>What is Rickard working on and thinking about <strong>right
now</strong>?</p>

<p>Every month I write a <em>newsletter</em> about just that. You will get
updates about my <em>current projects</em> and <em>thoughts about
programming</em>, and also get a chance to hit reply and <em>interact</em> with
me. Subscribe to it below.</p>

</div>
</div>
<div class="row">
<div class="col-md-12">
<iframe scrolling="no" style="width:100%!important;height:220px;border:1px #ccc solid !important" src="https://buttondown.email/rickardlindberg?as_embed=true"></iframe>
</div>
</div>
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../../static/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>
