<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>
      Doctest fails in Python 3 with wxPython | Rickard Lindberg
    </title>

    <!-- Bootstrap -->
    <link href="../../static/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <meta name="keywords" content="programming, writing" />
    <meta name="description" content="Rickard Lindberg">
    <link rel="stylesheet" href="../../static/layout.css" type="text/css">
    <link rel="stylesheet" href="../../static/syntax.css" type="text/css">
    <link rel="alternate" href="../../atom.xml" type="application/atom+xml" title="Atom feed">
    <link rel="alternate" href="../../rss.xml" type="application/rss+xml" title="RSS feed">
    <link rel="me" href="https://hachyderm.io/@rickardlindberg">
  </head>
  <body>

    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../">rickardlindberg.me</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="../../">Home</a></li>
            <li><a href="../../writing/">Writing</a></li>
            <li><a href="../../writing/newsletter/">Newsletter</a></li>
            <li><a href="../../projects/">Projects</a></li>
            <li><a href="../../contact/">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <h1>Doctest fails in Python 3 with wxPython</h1>

<p><em>Published on 31 August 2019.</em></p>


<p>When working on porting <a href="../../projects/timeline/">Timeline</a> to Python 3, I ran into a problem where a <a href="https://docs.python.org/3/library/doctest.html">doctest</a> failed under certain circumstances. I managed to create a small example that reproduces the failure. I describe the example below and show how I solved the test failure.</p>
<p>The example consists of a test runner and two test cases. The test runner is a slimmed down version of the one used in Timeline:</p>
<pre><code>1.  testrunner.py</code></pre>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="im">import</span> doctest</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="im">import</span> sys</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="im">import</span> unittest</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a><span class="kw">def</span> load_test_cases_from_module_name(suite, module_name):</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    <span class="bu">__import__</span>(module_name)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>    module <span class="op">=</span> sys.modules[module_name]</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>    module_suite <span class="op">=</span> unittest.defaultTestLoader.loadTestsFromModule(module)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>    suite.addTest(module_suite)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="kw">def</span> load_doc_tests_from_module_name(suite, module_name):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>    <span class="bu">__import__</span>(module_name)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>    module <span class="op">=</span> sys.modules[module_name]</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>    <span class="cf">try</span>:</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>        module_suite <span class="op">=</span> doctest.DocTestSuite(module)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>    <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>        <span class="co"># No tests found</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a>        <span class="cf">pass</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a>    <span class="cf">else</span>:</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a>        suite.addTest(module_suite)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a>    suite <span class="op">=</span> unittest.TestSuite()</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a>    load_test_cases_from_module_name(suite, <span class="st">&quot;test_wx&quot;</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a>    load_doc_tests_from_module_name(suite, <span class="st">&quot;test_doc&quot;</span>)</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a>    <span class="bu">print</span>(unittest.TextTestRunner().run(suite))</span></code></pre></div>
<p>It creates a test suite with test cases from two modules: one with a unit test and one with a doctests. It then runs the tests.</p>
<p>The first test is a unit test that needs an instance of <code>wx.App</code>:</p>
<pre><code>1.  test\_wx.py</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="im">import</span> contextlib</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="im">import</span> unittest</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="im">import</span> wx</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a><span class="kw">class</span> WxTest(unittest.TestCase):</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>    <span class="kw">def</span> test_wx(<span class="va">self</span>):</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>        <span class="cf">with</span> <span class="va">self</span>.wxapp() <span class="im">as</span> app:</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>            <span class="co"># Test something that requires a wx.App</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>            <span class="cf">pass</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>    <span class="at">@contextlib.contextmanager</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>    <span class="kw">def</span> wxapp(<span class="va">self</span>):</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>        app <span class="op">=</span> wx.App()</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>        <span class="cf">try</span>:</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>            <span class="cf">yield</span> app</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>        <span class="cf">finally</span>:</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>            app.Destroy()</span></code></pre></div>
<p>This example doesn't test anything, but is enough to reproduce the failure.</p>
<p>The second test is a doctest that asserts that a function prints a string:</p>
<pre><code>1.  test\_doc.py</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; print_fun_stuff()</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="co">This is fun!</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a><span class="kw">def</span> print_fun_stuff():</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;This is fun!&quot;</span>)</span></code></pre></div>
<p>When I run this example, I get the failure:</p>
<pre class="text"><code>$ python3 testrunner.py
.This is fun!
F
======================================================================
FAIL: test_doc ()
Doctest: test_doc
----------------------------------------------------------------------
Traceback (most recent call last):
  File &quot;/usr/lib64/python3.7/doctest.py&quot;, line 2196, in runTest
    raise self.failureException(self.format_failure(new.getvalue()))
AssertionError: Failed doctest test for test_doc
  File &quot;test_doc.py&quot;, line 0, in test_doc

----------------------------------------------------------------------
File &quot;test_doc.py&quot;, line 2, in test_doc
Failed example:
    print_fun_stuff()
Expected:
    This is fun!
Got nothing


----------------------------------------------------------------------
Ran 2 tests in 0.074s

FAILED (failures=1)
&lt;unittest.runner.TextTestResult run=2 errors=0 failures=1&gt;</code></pre>
<p>What appears to happen is that the expected string in the doctest is written to the console (or perhaps stderr) instead of being captured by doctest. When I run the doctest in isolation, it passes, so there is nothing wrong with the test itself. It is the sequence of these two tests that causes the problem.</p>
<p>My guess is that something in the wx test interferes with the doctest. Perhaps instantiating a <code>wx.App</code> has some effects on streams and redirection. But shouldn't the <code>app.Destroy()</code> call reset any such effects? It would seem reasonable. But what if the <code>wx.App</code> is not completely destroyed when the doctest is run? To test this, I modify the example to force a garbage collection after the <code>app.Destroy()</code> call like this:</p>
<pre class="text"><code>import gc; gc.collect()</code></pre>
<p>This gets rid of the failure and the tests pass consistently. This is also the solution that I adopted for Timeline.</p>
<p>The machine I run the example on is running Fedora 30, Python 3.7.3, and wxPython 4.0.4:</p>
<pre class="text"><code>$ uname -a
Linux localhost.localdomain 5.0.9-301.fc30.x86_64 #1 SMP Tue Apr 23 23:57:35
UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
$ python3
Python 3.7.3 (default, Mar 27 2019, 13:36:35)
[GCC 9.0.1 20190227 (Red Hat 9.0.1-0.8)] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import wx
&gt;&gt;&gt; wx.version()
'4.0.4 gtk3 (phoenix) wxWidgets 3.0.4'</code></pre>
<p>But the example doesn't always fail. On the Fedora 30 machine, it fails most of the time, but sometimes it succeeds. When I run the example on a machine that is running Fedora 26, Python 3.6.5, and wxPython 4.0.1, it always succeeds:</p>
<pre class="text"><code>$ uname -a
Linux x220 4.16.11-100.fc26.x86_64 #1 SMP Tue May 22 20:02:12 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
rick@x220 | ~/rickardlindberg.me/writing/draft-timeline-doctest-wxpython
$ python3
Python 3.6.5 (default, Apr  4 2018, 15:09:05)
[GCC 7.3.1 20180130 (Red Hat 7.3.1-2)] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import wx
&gt;&gt;&gt; wx.version()
'4.0.1 gtk3 (phoenix)'</code></pre>
<p>Also, if I change the test so that it doesn't use a context manager, it always succeeds:</p>
<pre class="text"><code>def test_wx(self):
    app = wx.App()
    try:
        # Test something that requires a wx.App
        pass
    finally:
        app.Destroy()</code></pre>
<p>Perhaps the context manager has some effect on when objects are garbage collected.</p>
<p>If you have any idea why this example sometimes fails, I would be interested to know. It seems illogical that a forced garbage collection should be needed to get a correct program.</p>

      <div class="jumbotron">
<div class="row">
<div class="col-md-12">

<p>What is Rickard working on and thinking about <strong>right
now</strong>?</p>

<p>Every month I write a <em>newsletter</em> about just that. You will get
updates about my <em>current projects</em> and <em>thoughts about
programming</em>, and also get a chance to hit reply and <em>interact</em> with
me. Subscribe to it below.</p>

</div>
</div>
<div class="row">
<div class="col-md-12">
<iframe scrolling="no" style="width:100%!important;height:220px;border:1px #ccc solid !important" src="https://buttondown.email/rickardlindberg?as_embed=true"></iframe>
</div>
</div>
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../../static/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>
