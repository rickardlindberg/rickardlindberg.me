<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>
      DevLog 001: J-cuts and L-cuts in my video editor? | Rickard Lindberg
    </title>

    <!-- Bootstrap -->
    <link href="../../static/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <meta name="keywords" content="programming, writing" />
    <meta name="description" content="Rickard Lindberg">
    <link rel="stylesheet" href="../../static/layout.css" type="text/css">
    <link rel="stylesheet" href="../../static/syntax.css" type="text/css">
    <link rel="alternate" href="../../atom.xml" type="application/atom+xml" title="Atom feed">
    <link rel="alternate" href="../../rss.xml" type="application/rss+xml" title="RSS feed">
    <link rel="me" href="https://hachyderm.io/@rickardlindberg">
  </head>
  <body>

    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../">rickardlindberg.me</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="../../">Home</a></li>
            <li><a href="../../writing/">Writing</a></li>
            <li><a href="../../writing/newsletter/">Newsletter</a></li>
            <li><a href="../../projects/">Projects</a></li>
            <li><a href="../../contact/">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <h1>DevLog 001: J-cuts and L-cuts in my video editor?</h1>

<p><em>Published on 28 July 2023.</em></p>

<h2 id="about-devlogs">About DevLogs</h2>
<p>DevLogs is an experiment to try to document development that I do on various projects. I will try to write what is going on in my head as I do various development tasks.</p>
<h2 id="todays-problem">Today’s problem</h2>
<p>In my video editor, there is a problem with overlapping clips. How they overlap appears to be almost random.</p>
<p>In this edit, the <code>two.mp4</code> clip is rendered below:</p>
<p>
<center>
<img src="edit1.png" title="fig:" alt="Alternative text." />
</center>
</p>
<p>If we edit the <code>one.mp4</code> clip, then the two switch order.</p>
<p>
<center>
<img src="edit2.png" title="fig:" alt="Alternative text." />
</center>
</p>
<p>So the order depends on the modification times of clips.</p>
<p>That is not very good.</p>
<h2 id="plan">Plan</h2>
<p>My idea for how to solve this is that each clip can specify how it should be cut into the previous one.</p>
<p>I imagine a library of cuts such as:</p>
<ul>
<li>over</li>
<li>under</li>
<li>j-cut</li>
<li>l-cut</li>
<li>overlay (with priority)</li>
<li>background (with priority)</li>
</ul>
<p>To make progress on this, we can probably assume a default cut (maybe under) and make sure it works. Then we can extend the library of cuts.</p>
<h2 id="writing-a-test">Writing a test</h2>
<p>The relevant code for this is mostly here:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">def</span> extract_mix_section(<span class="va">self</span>, region):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="co">    &gt;&gt;&gt; cuts = Cuts.from_list([</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a><span class="co">    ...     Cut.test_instance(name=&quot;A&quot;, start=0, end=8, position=1),</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="co">    ...     Cut.test_instance(name=&quot;B&quot;, start=0, end=8, position=5),</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="co">    ... ])</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a><span class="co">    &gt;&gt;&gt; cuts.to_ascii_canvas()</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a><span class="co">    | &lt;-A0---&gt;    |</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a><span class="co">    |     &lt;-B0---&gt;|</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a><span class="co">    &gt;&gt;&gt; cuts.extract_mix_section(Region(start=0, end=15)).to_ascii_canvas()</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a><span class="co">    %&lt;-A0---&gt;%%%%%%</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a><span class="co">    %%%%%&lt;-B0---&gt;%%</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>    <span class="co"># </span><span class="al">TODO</span><span class="co">: sort based on cut (j-cut, l-cut, overlay, background).</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>    playlists <span class="op">=</span> []</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>    <span class="cf">for</span> cut <span class="kw">in</span> <span class="va">self</span>.create_cut(region).cut_map.values():</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a>        playlists.append(Cuts.empty().add(cut).extract_playlist_section(region))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a>    <span class="cf">return</span> MixSection(length<span class="op">=</span>region.length, playlists<span class="op">=</span>playlists)</span></code></pre></div>
<p>Let’s write a test that shows the current behavior first:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; region = Region(start=0, end=15)</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; a_cut = Cut.test_instance(name=&quot;A&quot;, start=0, end=8, position=1)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; b_cut = Cut.test_instance(name=&quot;B&quot;, start=0, end=8, position=5)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; Cuts.from_list([</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="co">...     a_cut,</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="co">...     b_cut,</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="co">... ]).extract_mix_section(region).to_ascii_canvas()</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="co">%&lt;-A0---&gt;%%%%%%</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a><span class="co">%%%%%&lt;-B0---&gt;%%</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; Cuts.from_list([</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a><span class="co">...     b_cut,</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a><span class="co">...     a_cut,</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a><span class="co">... ]).extract_mix_section(region).to_ascii_canvas()</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a><span class="co">%%%%%&lt;-B0---&gt;%%</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a><span class="co">%&lt;-A0---&gt;%%%%%%</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>So depending on the order in which cuts are added, they mix differently. This is exactly the behavior that we want to change. We want them to mix the same no matter what order they are added in.</p>
<p>Let’s commit this as a baseline:</p>
<pre class="shell"><code>$ ./make.py commit -m 'Pinpoint current behavior of mixing cuts.'</code></pre>
<p>The <code>./make.py commit</code> script is a wrapper around <code>git commit</code> that also runs the tests and makes sure there are no untracked files. A real handy tool to make sure we don’t commit “bad” code.</p>
<h2 id="cut-the-same">Cut the same</h2>
<p>I modify the test above to assert that the same mix is created even when the cuts are in the reverse order.</p>
<p>I make it pass by sorting the clips by start time, making “later” clips appear below which would be the equivalent of having the cut on the second b clip set to “under”:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">def</span> sort_cuts(<span class="va">self</span>, cuts):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    <span class="cf">return</span> <span class="bu">sorted</span>(cuts, key<span class="op">=</span><span class="kw">lambda</span> cut: cut.get_source_cut().start)</span></code></pre></div>
<p>That works as intended in the application as well. Let’s commit:</p>
<pre class="shell"><code>$ ./make.py commit -m 'Always mix cuts below previous cut.'</code></pre>
<h2 id="clips-with-the-same-start">Clips with the same start</h2>
<p>If two cuts have the same start, the sorting will have no effect and we still have the same problem.</p>
<p>First of all, I don’t think this scenario will be that common in a real situation.</p>
<p>I’m thinking we can handle it with a warning. If such situation appears, the user has to resolve the issue by hinting how the mix should be done.</p>
<p>We can also take the end position into account. Then only cuts with the same start and end has the problem. In which case the user must explicitly tell which should be on top somehow.</p>
<h2 id="summary">Summary</h2>
<p>We made progress towards mixing cuts in a better way. Next step in this area I think is to allow the type of cut to be specified per clip and take that into account when sorting cuts. I think it should be quite easy to write tests for this and we should be able to move steady and carefully using TDD.</p>

      <div class="jumbotron">
<div class="row">
<div class="col-md-12">

<p>What is Rickard working on and thinking about <strong>right
now</strong>?</p>

<p>Every month I write a <em>newsletter</em> about just that. You will get
updates about my <em>current projects</em> and <em>thoughts about
programming</em>, and also get a chance to hit reply and <em>interact</em> with
me. Subscribe to it below.</p>

</div>
</div>
<div class="row">
<div class="col-md-12">
<iframe scrolling="no" style="width:100%!important;height:220px;border:1px #ccc solid !important" src="https://buttondown.email/rickardlindberg?as_embed=true"></iframe>
</div>
</div>
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../../static/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>
