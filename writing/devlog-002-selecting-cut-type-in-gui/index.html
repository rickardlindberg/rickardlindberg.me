<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>
      DevLog 002: Change mix strategy for cuts in GUI | Rickard Lindberg
    </title>

    <!-- Bootstrap -->
    <link href="../../static/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <meta name="keywords" content="programming, writing" />
    <meta name="description" content="Rickard Lindberg">
    <link rel="stylesheet" href="../../static/layout.css" type="text/css">
    <link rel="stylesheet" href="../../static/syntax.css" type="text/css">
    <link rel="alternate" href="../../atom.xml" type="application/atom+xml" title="Atom feed">
    <link rel="alternate" href="../../rss.xml" type="application/rss+xml" title="RSS feed">
    <link rel="me" href="https://hachyderm.io/@rickardlindberg">
  </head>
  <body>

    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../">rickardlindberg.me</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="../../">Home</a></li>
            <li><a href="../../writing/">Writing</a></li>
            <li><a href="../../writing/newsletter/">Newsletter</a></li>
            <li><a href="../../projects/">Projects</a></li>
            <li><a href="../../contact/">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <h1>DevLog 002: Change mix strategy for cuts in GUI</h1>

<p><em>Published on 29 July 2023.</em></p>

<p>In the <a href="../../writing/devlog-001-jcut-lcut/">previous devlog</a> we worked on adding the concept of a cut type to a clip in the <a href="../../projects/rlvideo/">video editor</a>. That is, how should two overlapping clips be mixed together? Which one should be on top? Should it be a <a href="https://en.wikipedia.org/wiki/J_cut">J-cut</a>?</p>
<p>I’ve since added support for two types of cuts: over and under. So we can (programmatically) set this property on clips and they will render in the correct order.</p>
<p>The default cut is under so that later clips will be mixed under the previous clips:</p>
<p>
<center>
<img src="under.png" title="fig:" alt="Default under cut." />
</center>
</p>
<p>There is not yet a way to change this default from the GUI, so that’s what we will work on in this episode.</p>
<h2 id="aside-clips-and-cuts">Aside: clips and cuts</h2>
<p>When writing about this and when looking at the source code, I’m a bit confused by the terminology. I write about clips och cuts, but in the source code there is no concept of a clip, only a cut and a source.</p>
<p>A source represents a file on disk or some generator of frames. A cut represents a region of a source.</p>
<p>A cut has a property called <code>cut</code> which is how to mix this cut with the previous cut on the timeline. That confuses things further.</p>
<p>Let’s rename it to <code>mix_strategy</code> to lessen the confusion.</p>
<pre class="shell"><code>$ ./make.py commit -m 'Rename Cut.cut to Cut.mix_strategy.'
...............................................
----------------------------------------------------------------------
Ran 47 tests in 1.918s

OK
[main 425909a] Rename Cut.cut to Cut.mix_strategy.
 1 file changed, 11 insertions(+), 11 deletions(-)</code></pre>
<p>That’s better.</p>
<h2 id="two-possible-ways">Two possible ways</h2>
<p>I can think of two possible ways to set the mix strategy for a cut in the GUI. Either we can right click on a cut and have a context menu pop up where we can select the mix strategy. Or we can select a clip and have a “set mix strategy” operation applied to the selected clip.</p>
<p>Currently, there is no concept of a selected clip. You can’t select anything. But there is a concept of clicking and dragging a clip. Therefore I think a context menu is easier to get started with.</p>
<h2 id="reviewing-mouse-click-code">Reviewing mouse click code</h2>
<p>Let’s look at how click and drag is handled today.</p>
<p>I see this GTK event is connected:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>timeline.<span class="ex">connect</span>(<span class="st">&quot;button-press-event&quot;</span>, timeline_button)</span></code></pre></div>
<p>And <code>timeline_button</code> is defined like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="kw">def</span> timeline_button(widget, event):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>    <span class="va">self</span>.timeline.mouse_down(<span class="op">*</span>timeline.translate_coordinates(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>        main_window,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>        event.x,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>        event.y</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    ))</span></code></pre></div>
<p>This code does not seem to distinguish between left and right mouse button click. Interesting.</p>
<p>Does that mean that we can move a cut on the timeline by clicking and dragging with the right mouse button? I try it in the application. And it indeed works. That was really not my intention. Let’s see if we can fix that.</p>
<p>I add a debug print to see what properties of the event might indicate the button:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">def</span> timeline_button(widget, event):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="bu">dir</span>(event))</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    ...</span></code></pre></div>
<p>I find this:</p>
<pre class="text"><code>[..., 'button', ..., 'get_button', ...]</code></pre>
<p>Let’s try this:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">def</span> timeline_button(widget, event):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>    <span class="bu">print</span>(event.button)</span></code></pre></div>
<p>When I press the left button, it prints 1, and when I press the right button, it prints 3. There must be some constants for these. I search the GTK documentation and find <a href="https://docs.gtk.org/gdk3/struct.EventButton.html">this</a>:</p>
<blockquote>
<p>The button which was pressed or released, numbered from 1 to 5. Normally button 1 is the left mouse button, 2 is the middle button, and 3 is the right button.</p>
</blockquote>
<p>Maybe there are no constants?</p>
<p>Let’s codify our new knowledge like this:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="kw">def</span> timeline_button(widget, event):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>    <span class="cf">if</span> event.button <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>        <span class="va">self</span>.timeline.left_mouse_down(<span class="op">*</span>timeline.translate_coordinates(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>            main_window,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>            event.x,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>            event.y</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>        ))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>    <span class="cf">elif</span> event.button <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>        <span class="va">self</span>.timeline.right_mouse_down(<span class="op">*</span>timeline.translate_coordinates(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>            main_window,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>            event.x,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a>            event.y</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a>        ))</span></code></pre></div>
<p>We rename the previous <code>mouse_down</code> to <code>left_mouse_down</code> and add a new empty method for <code>right_mouse_down</code>.</p>
<pre class="shell"><code>$ ./make.py commit -m 'Timeline receives both left and right mouse down events.'
...............................................
----------------------------------------------------------------------
Ran 47 tests in 1.923s

OK
[main 0fc6fb1] Timeline receives both left and right mouse down events.
 1 file changed, 17 insertions(+), 7 deletions(-)</code></pre>
<h2 id="review">Review</h2>
<p>It’s a little unnclear to me what the translation of coordinates are doing. I think the coordinates received in the event are relative to the whole GTK window and the timeline expects coordinates relative to itself.</p>
<p>I don’t really want to focus on this now, but I add a TODO in the code that I should clarify this.</p>
<p>In this project I’ve tried to keep my “backlog” in the source code in the form of TODO comments. Some I will probably never get back to, and others will serve as a reminder. But so far I kind of like this approach.</p>
<h2 id="separation-of-timeline-and-gtk">Separation of timeline and GTK</h2>
<p>The timeline component is unaware of GTK. So when it receives the right mouse down event, it can find the cut that we clicked on, but it doesn’t have the ability to show a context menu, because it needs to use GTK for that.</p>
<p>This separation is intentional. I’ve tried to isolate GTK code to the outermost layer to keep the inner layers free from those details and make them easier to test.</p>
<p>But this presents a problem now.</p>
<p>The only solution that comes to mind if we want to maintain this separation is to create some kind of abstraction. Something like this:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">class</span> GtkGuiAbstraction:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>    <span class="kw">def</span> show_context_menu(<span class="va">self</span>, generic_menu_description):</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>        <span class="co"># Create GTK context menu from generic_menu_description</span></span></code></pre></div>
<p>And then pass that to the timeline so that it can do something like this:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">def</span> right_mouse_down(<span class="va">self</span>, x, y):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>    <span class="va">self</span>.gui.show_context_menu([</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>        MenuItem(label<span class="op">=</span><span class="st">&quot;over&quot;</span>, action<span class="op">=</span><span class="kw">lambda</span>: ...),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>        MenuItem(label<span class="op">=</span><span class="st">&quot;under&quot;</span>, action<span class="op">=</span><span class="kw">lambda</span>: ...),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>    ])</span></code></pre></div>
<p>I’m not sure what I think about this. On the one hand it feels like a complex extra layer. On the other hand I really want to isolate GTK code. My experience tells me that GUI code can easily leak in to every part of the application and it just makes everything more messy.</p>
<p>I will try to create the simplest possible solution of this design and see what it feels like.</p>
<h2 id="gtk-gui-abstraction">GTK GUI abstraction</h2>
<p>Let’s start with a test:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="kw">class</span> GtkGui:</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>    <span class="kw">def</span> show_context_menu(<span class="va">self</span>, menu):</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>        <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a><span class="co">        &gt;&gt;&gt; GtkGui().show_context_menu([</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a><span class="co">        ...     MenuItem(label=&quot;over&quot;, action=lambda: print(&quot;over&quot;)),</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a><span class="co">        ...     MenuItem(label=&quot;under&quot;, action=lambda: print(&quot;under&quot;)),</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a><span class="co">        ... ])</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a><span class="co">        &quot;&quot;&quot;</span></span></code></pre></div>
<p>This fails with</p>
<pre class="text"><code>NameError: name 'MenuItem' is not defined</code></pre>
<p>I define <code>MenuItem</code> and we are green:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="kw">class</span> MenuItem(namedtuple(<span class="st">&quot;MenuItem&quot;</span>, <span class="st">&quot;label,action&quot;</span>)):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>    <span class="cf">pass</span></span></code></pre></div>
<p>Let’s commit:</p>
<pre class="shell"><code>$ ./make.py commit -m 'The start of GtkGui and its show_context_menu method.'
................................................
----------------------------------------------------------------------
Ran 48 tests in 1.923s

OK
[main e64b93e] The start of GtkGui and its show_context_menu method.
 1 file changed, 13 insertions(+)</code></pre>
<p>The test so far does not assert anything. It just checks that the code does not crash. But that is enough to experiment with the GTK API. Let’s try to create the menu and the test will tell is if we use the GKT API wrong.</p>
<p>I try this:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>menu <span class="op">=</span> gtk.Menu()</span></code></pre></div>
<p>Test immediately fails:</p>
<pre class="text"><code>NameError: name 'gtk' is not defined</code></pre>
<p>Ah, it should be <code>Gtk</code> I see in the imports at the top of the file. Thank you test.</p>
<p>I search the web for examples how to show a context menu in GTK. After a bit of reading and trying, I end up with this:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="kw">def</span> show_context_menu(<span class="va">self</span>, menu):</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a><span class="co">    &gt;&gt;&gt; event = namedtuple(&quot;FakeEvent&quot;, &quot;button,time&quot;)(3, 0)</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a><span class="co">    &gt;&gt;&gt; GtkGui(event).show_context_menu([</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a><span class="co">    ...     MenuItem(label=&quot;over&quot;, action=lambda: print(&quot;over&quot;)),</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a><span class="co">    ...     MenuItem(label=&quot;under&quot;, action=lambda: print(&quot;under&quot;)),</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a><span class="co">    ... ])</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a>    <span class="kw">def</span> create_gtk_handler(menu_item):</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true"></a>        <span class="kw">def</span> handler(widget):</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true"></a>            menu_item.action()</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true"></a>        <span class="cf">return</span> handler</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true"></a>    gtk_menu <span class="op">=</span> Gtk.Menu()</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true"></a>    <span class="cf">for</span> menu_item <span class="kw">in</span> menu:</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true"></a>        gtk_menu_item <span class="op">=</span> Gtk.MenuItem(label<span class="op">=</span>menu_item.label)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true"></a>        gtk_menu_item.<span class="ex">connect</span>(<span class="st">&quot;activate&quot;</span>, create_gtk_handler(menu_item))</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true"></a>        gtk_menu_item.show()</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true"></a>        gtk_menu.append(gtk_menu_item)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true"></a>    gtk_menu.popup(<span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>, <span class="va">self</span>.event.button, <span class="va">self</span>.event.time)</span></code></pre></div>
<p>The <code>Gtk.Menu</code> seems to need an event to show itself according to examples. So I pass that along to <code>GtkGui</code> and use a fake one in the test. The event handler looks like this:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a><span class="kw">def</span> right_mouse_down(<span class="va">self</span>, x, y, gui):</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>    gui.show_context_menu([</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>        MenuItem(label<span class="op">=</span><span class="st">&quot;over&quot;</span>, action<span class="op">=</span><span class="kw">lambda</span>: <span class="bu">print</span>(<span class="st">&quot;over&quot;</span>)),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true"></a>        MenuItem(label<span class="op">=</span><span class="st">&quot;under&quot;</span>, action<span class="op">=</span><span class="kw">lambda</span>: <span class="bu">print</span>(<span class="st">&quot;under&quot;</span>)),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true"></a>    ])</span></code></pre></div>
<p>I decide to pass the <code>gui</code> along in the method call. That way, it can more easily be constructed with the right click event in the outer layer:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="cf">elif</span> event.button <span class="op">==</span> <span class="dv">3</span>:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a>    <span class="va">self</span>.timeline.right_mouse_down(<span class="op">*</span>timeline.translate_coordinates(</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>        main_window,</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>        event.x,</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>        event.y</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>    ), GtkGui(event))</span></code></pre></div>
<p>This works fine and when I click the menu items, the corresponding text is shown in the console:</p>
<p>
<center>
<img src="popup.png" title="fig:" alt="Context menu popup." />
</center>
</p>
<p>Let’s commit:</p>
<pre class="shell"><code>$ ./make.py commit -m 'Show a context menu when right clicking in timeline.'
................................................
----------------------------------------------------------------------
Ran 48 tests in 1.954s

OK
[main 4201621] Show a context menu when right clicking in timeline.
 1 file changed, 22 insertions(+), 4 deletions(-)</code></pre>
<h2 id="modify-cut">Modify cut</h2>
<p>I continue to modify <code>right_mouse_down</code> to this:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true"></a><span class="kw">def</span> right_mouse_down(<span class="va">self</span>, x, y, gui):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true"></a>    cut <span class="op">=</span> <span class="va">self</span>.rectangle_map.get(x, y)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(cut, Cut):</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true"></a>        gui.show_context_menu([</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true"></a>            MenuItem(label<span class="op">=</span><span class="st">&quot;over&quot;</span>, action<span class="op">=</span><span class="kw">lambda</span>: <span class="bu">print</span>(<span class="st">&quot;over&quot;</span>)),</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true"></a>            MenuItem(label<span class="op">=</span><span class="st">&quot;under&quot;</span>, action<span class="op">=</span><span class="kw">lambda</span>: <span class="bu">print</span>(<span class="st">&quot;under&quot;</span>)),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true"></a>        ])</span></code></pre></div>
<p>I want to show the context menu only if we right click on a cut. We can use the rectangle map for that.</p>
<p>All tests pass, but when I try this in the application, it fails with this:</p>
<pre class="text"><code>NameError: name 'Cut' is not defined</code></pre>
<p>I should have started with a test. Let’s move a little slower.</p>
<p>I add this line in a larger timeline test where we have some objects setup:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; timeline.right_mouse_down(5, 25, FakeGui(click_context_menu=&quot;over&quot;))</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>And here comes one benefit of the GUI abstraction: easier testing. In the test we can pass a <code>FakeGui</code> that will simulate that we click a context menu item. We implement it like this:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true"></a><span class="kw">class</span> FakeGui:</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, click_context_menu<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true"></a>        <span class="va">self</span>.click_context_menu <span class="op">=</span> click_context_menu</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true"></a>    <span class="kw">def</span> show_context_menu(<span class="va">self</span>, menu):</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true"></a>        <span class="cf">for</span> menu_item <span class="kw">in</span> menu:</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true"></a>            <span class="cf">if</span> menu.label <span class="op">==</span> <span class="va">self</span>.click_context_menu:</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true"></a>                menu.action()</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true"></a>                <span class="cf">return</span></span></code></pre></div>
<p>Now we get the same error about <code>Cut</code> not being defined. But this time, we get it when running the test suite. Success!</p>
<p>I import <code>Cut</code> and get an error that ‘list’ object has no attribute ‘label’. Ah. I made a mistake in the fake GUI. <code>label</code> and <code>action</code> should be accessed on the item, not the menu.</p>
<p>The current context menu just prints its label, so to make the test pass, let’s assert on that:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; timeline.right_mouse_down(5, 25, FakeGui(click_context_menu=&quot;over&quot;))</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true"></a><span class="co">over</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>And we are back to green. Let’s commit:</p>
<pre class="shell"><code>$ ./make.py commit -m 'Test right clicking a cut.'
................................................
----------------------------------------------------------------------
Ran 48 tests in 1.957s

OK
[main 7bf3e14] Test right clicking a cut.
 1 file changed, 33 insertions(+), 7 deletions(-)</code></pre>
<p>But we don’t want to print the menu item label. We want to change the <code>mix_strategy</code> of the clicked cut. Let’s assert on that instead:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; timeline.right_mouse_down(5, 25, FakeGui(click_context_menu=&quot;over&quot;))</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true"></a><span class="co">&gt;&gt;&gt; timeline.get_cut(cut_id).mix_strategy</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true"></a><span class="co">'over'</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true"></a><span class="co">&quot;&quot;&quot;</span></span></code></pre></div>
<p>This fails because <code>right_mouse_down</code> still prints its label. I remove the print and it now fails because <code>Timeline.get_cut</code> is not defined. I add it and get the correct failure:</p>
<pre class="text"><code>Failed example:
    timeline.get_cut(cut_id).mix_strategy
Differences (ndiff with -expected +actual):
    - 'over'
    + 'under'</code></pre>
<p>The original mix strategy is <code>over</code> and this test should have changed it to <code>under</code>, but it didn’t. Let’s fix that. As I try to get this test to pass, I get many test failures. The failures guide me what to do next. This method is not defined. Define it. This name does not exist. Fix spell error. I eventually end up with this:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true"></a><span class="kw">def</span> right_mouse_down(<span class="va">self</span>, x, y, gui):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true"></a>    cut <span class="op">=</span> <span class="va">self</span>.rectangle_map.get(x, y)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(cut, Cut):</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true"></a>        <span class="kw">def</span> mix_strategy_updater(value):</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true"></a>            <span class="kw">def</span> update():</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true"></a>                <span class="cf">with</span> <span class="va">self</span>.project.new_transaction() <span class="im">as</span> transaction:</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true"></a>                    transaction.modify(cut.<span class="bu">id</span>, <span class="kw">lambda</span> cut:</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true"></a>                        cut.with_mix_strategy(value))</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true"></a>            <span class="cf">return</span> update</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true"></a>        gui.show_context_menu([</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true"></a>            MenuItem(label<span class="op">=</span><span class="st">&quot;over&quot;</span>, action<span class="op">=</span>mix_strategy_updater(<span class="st">&quot;over&quot;</span>)),</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true"></a>            MenuItem(label<span class="op">=</span><span class="st">&quot;under&quot;</span>, action<span class="op">=</span>mix_strategy_updater(<span class="st">&quot;under&quot;</span>)),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true"></a>        ])</span></code></pre></div>
<p>This makes the test pass and also works beautifully in the application. Let’s commit:</p>
<pre class="shell"><code>$ ./make.py commit -m 'Can change mix strategy of clip with context menu.'
................................................
----------------------------------------------------------------------
Ran 48 tests in 1.956s

OK
[main 776171a] Can change mix strategy of clip with context menu.
 3 files changed, 26 insertions(+), 4 deletions(-)</code></pre>
<h2 id="summary">Summary</h2>
<p>We now have a way to change the mix strategy of a cut in the GUI. The application is a little more useful now.</p>
<p>Working with third party frameworks, like GTK, I find often slows you down. You need to learn the details of it and it is often difficult to write tests. Therefore I’m quite happy with the abstraction that we created. I want to keep as many classes as possible away from messy GTK code.</p>

      <div class="jumbotron">
<div class="row">
<div class="col-md-12">

<p>What is Rickard working on and thinking about <strong>right
now</strong>?</p>

<p>Every month I write a <em>newsletter</em> about just that. You will get
updates about my <em>current projects</em> and <em>thoughts about
programming</em>, and also get a chance to hit reply and <em>interact</em> with
me. Subscribe to it below.</p>

</div>
</div>
<div class="row">
<div class="col-md-12">
<iframe scrolling="no" style="width:100%!important;height:220px;border:1px #ccc solid !important" src="https://buttondown.email/rickardlindberg?as_embed=true"></iframe>
</div>
</div>
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../../static/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>
