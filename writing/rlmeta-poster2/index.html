<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>
      DRAFT: RLMeta Poster 2 | Rickard's personal homepage
    </title>

    <!-- Bootstrap -->
    <link href="../../static/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <meta name="keywords" content="programming, writing" />
    <meta name="description" content="Rickard's personal homepage.">
    <link rel="stylesheet" href="../../static/layout.css" type="text/css">
    <link rel="stylesheet" href="../../static/syntax.css" type="text/css">
    <link rel="alternate" href="../../atom.xml" type="application/atom+xml" title="Atom feed">
    <link rel="alternate" href="../../rss.xml" type="application/rss+xml" title="RSS feed">
  </head>
  <body>

    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../">rickardlindberg.me</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="../../">Home</a></li>
            <li><a href="../../writing/">Writing</a></li>
            <li><a href="../../writing/newsletter/">Newsletter</a></li>
            <li><a href="../../projects/">Projects</a></li>
            <li><a href="../../contact/">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <h1>DRAFT: RLMeta Poster 2</h1>

<p><em>Published on 18 January 2022.</em></p>

<ul>
<li><a href="#code-walk-through">Code walk through</a>
<ul>
<li><a href="#getting-rlmeta">Getting RLMeta</a></li>
<li><a href="#file-structure">File structure</a></li>
<li><a href="#exploring-rlmeta">Exploring RLMeta</a></li>
<li><a href="#compiling-rlmeta-itself">Compiling RLMeta itself</a></li>
<li><a href="#a-tour-of-the-main-function">A tour of the main function</a></li>
<li><a href="#following-a-compilation">Following a compilation</a></li>
<li><a href="#the-purpose-of-the-make-script">The purpose of the make script</a></li>
</ul></li>
<li><a href="#changes-from-the-previous-version">Changes from the previous version</a>
<ul>
<li><a href="#generate-labels-in-semantic-actions">Generate labels in semantic actions</a></li>
<li><a href="#remove-dependency-on-bash">Remove dependency on Bash</a></li>
<li><a href="#extract-assembler">Extract assembler</a></li>
<li><a href="#clearer-vm">Clearer VM</a></li>
<li><a href="#ability-to-run-a-rule-in-semantic-action">Ability to run a rule in semantic action</a></li>
<li><a href="#misc">Misc</a></li>
</ul></li>
<li><a href="#the-future">The future</a></li>
<li><a href="#code-listings-for-rlmeta">Code listings for RLMeta</a>
<ul>
<li><a href="#srcparser.rlmeta">src/parser.rlmeta</a></li>
<li><a href="#srccodegenerator.rlmeta">src/codegenerator.rlmeta</a></li>
<li><a href="#srcassembler.rlmeta">src/assembler.rlmeta</a></li>
<li><a href="#srcsupport.py">src/support.py</a></li>
<li><a href="#srcmain.py">src/main.py</a></li>
<li><a href="#make.py">make.py</a></li>
</ul></li>
</ul>
<p><strong>This is a work in progress that will change. Like to see it finished? Let me know by sending me an email.</strong></p>
<p>A while ago I created a <a href="../../writing/creating-rlmeta-poster/">poster</a> to showcase RLMeta. The version of RLMeta on the poster is based on the version from the <a href="../../writing/rlmeta-memoize-failures/">memoizing failures</a> article, but I made it smaller and more beautiful to better fit the poster. To be able to finish the poster, I had to stop making changes and put the source code on the poster. That was difficult because I felt the need for it to be perfect. Eventually I did stop polishing, and left a few items unresolved.</p>
<p>Almost immediately after I finished the poster, I started working on a second version. Initially, my plan was to make a second version of the poster. I started to fix the unresolved items and I was making progress. But somehow imperfections kept creeping in. It felt like a never ending game of chasing perfection. Thatâ€™s when I decided that a second poster was probably not going to be worth it. But I still liked the new version of RLMeta.</p>
<p>Instead, I decided to attempt to present the new version in the style of a code walk through. In other words, another way to showcase RLMeta that is also a bit more practical. Compared to the poster version, this version could also be more easily improved because rendering the blog post is automatic whereas creating the layout of a poster requires manual work every time the source code changes. I also wanted to experiment with the walk through format because I thought it could be something worth putting into the README of a project.</p>
<p>The rest of this blog post consists of the walk through of the new version of RLMeta and a section on the most important changes from the poster version and motivations for them.</p>
<h2 id="code-walk-through">Code walk through</h2>
<h3 id="getting-rlmeta">Getting RLMeta</h3>
<p>In order to follow along on this walk through, you need to download the version of RLMeta from here: <a href="rlmeta-poster-2.zip">rlmeta-poster-2.zip</a>.</p>
<h3 id="file-structure">File structure</h3>
<p>The zip file consists of the source code for the RLMeta compiler, a make script, and the compiler itself (<code>rlmeta.py</code>):</p>
<div class="highlight">
<pre><span></span>$ <span></span>tree --dirsfirst
<span></span>.
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ assembler.rlmeta
â”‚Â Â  â”œâ”€â”€ codegenerator.rlmeta
â”‚Â Â  â”œâ”€â”€ main.py
â”‚Â Â  â”œâ”€â”€ parser.rlmeta
â”‚Â Â  â””â”€â”€ support.py
â”œâ”€â”€ make.py
â””â”€â”€ rlmeta.py

1 directory, 7 files
</pre>
</div>
<p>The size of the source code is quite small:</p>
<div class="highlight">
<pre><span></span>$ <span></span>wc -l src/*
<span></span>   39 src/assembler.rlmeta
   57 src/codegenerator.rlmeta
   26 src/main.py
   60 src/parser.rlmeta
  237 src/support.py
  419 total
</pre>
</div>
<p>The compiler can be created from this source code only. We will see how later in this walk through.</p>
<h3 id="exploring-rlmeta">Exploring RLMeta</h3>
<p>Before we dive into how the RLMeta compiler is created, letâ€™s explore RLMeta by writing a small, but real, program in it.</p>
<p>What types of programs can we write in RLMeta?</p>
<p>In RLMeta, we write grammars. Grammars have rules that specify how to match objects from an input stream and specify what should happen when objects are matched.</p>
<p>Letâ€™s write a grammar that counts the number of objects in an input stream and produces a report:</p>
<div class="highlight">
<pre><span></span>$ <span></span>cat object_counter.rlmeta
<span></span>ObjectCounter {
    count <span class="nb">=</span> <span class="nc">.*</span><span class="nb">:</span>xs <span class="nb">-&gt;</span> { <span class="s">&quot;number of objects = &quot;</span> len(xs) }
}
</pre>
</div>
<p>The main function of the RLMeta compiler is to transform grammars into Python code. If invoked without arguments, the compiler reads a grammar from stdin and writes Python code to stdout:</p>
<div class="highlight">
<pre><span></span>$ <span></span>cat object_counter.rlmeta <span class="p">|</span> python rlmeta.py
<span></span><span class="k">class</span> <span class="nc">ObjectCounter</span><span class="p">(</span><span class="n">Grammar</span><span class="p">):</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'count'</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">PUSH_SCOPE</span><span class="p">,</span>
        <span class="n">LIST_START</span><span class="p">,</span>
        <span class="n">BACKTRACK</span><span class="p">,</span>
        <span class="mi">10</span><span class="p">,</span>
        <span class="n">MATCH</span><span class="p">,</span>
        <span class="s1">'any'</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">LIST_APPEND</span><span class="p">,</span>
        <span class="n">COMMIT</span><span class="p">,</span>
        <span class="mi">2</span><span class="p">,</span>
        <span class="n">LIST_END</span><span class="p">,</span>
        <span class="n">BIND</span><span class="p">,</span>
        <span class="s1">'xs'</span><span class="p">,</span>
        <span class="n">ACTION</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">join</span><span class="p">([</span><span class="s1">'number of objects = '</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">'len'</span><span class="p">)(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">(</span><span class="s1">'xs'</span><span class="p">))]),</span>
        <span class="n">POP_SCOPE</span><span class="p">,</span>
        <span class="n">RETURN</span>
    <span class="p">]</span>
</pre>
</div>
<p>This is equivalent to using the <code>--compile</code> command with a value of <code>-</code> which stands for stdin:</p>
<div class="highlight">
<pre><span></span>$ <span></span>cat object_counter.rlmeta <span class="p">|</span> python rlmeta.py --compile - <span class="p">|</span> head -n3
<span></span><span class="k">class</span> <span class="nc">ObjectCounter</span><span class="p">(</span><span class="n">Grammar</span><span class="p">):</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'count'</span><span class="p">:</span> <span class="mi">0</span>
</pre>
</div>
<p>And, the file can also be specified directly like this:</p>
<div class="highlight">
<pre><span></span>$ <span></span>python rlmeta.py --compile object_counter.rlmeta <span class="p">|</span> head -n3
<span></span><span class="k">class</span> <span class="nc">ObjectCounter</span><span class="p">(</span><span class="n">Grammar</span><span class="p">):</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'count'</span><span class="p">:</span> <span class="mi">0</span>
</pre>
</div>
<p>Donâ€™t worry about understanding the generated code. We will explore it more later. Just note that the generated class inherits from a class called <code>Grammar</code> and that it uses some constants like <code>PUSH_SCOPE</code> and <code>LIST_START</code>. These things are defined in a support library which can be generated by the RLMeta compiler with the <code>--support</code> command:</p>
<div class="highlight">
<pre><span></span>$ <span></span>python rlmeta.py --support <span class="p">|</span> grep <span class="s1">'^\(class\|def\)'</span>
<span></span><span class="k">class</span> <span class="nc">VM</span><span class="p">:</span>
<span class="k">def</span> <span class="nf">PUSH_SCOPE</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">POP_SCOPE</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">BACKTRACK</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">COMMIT</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">CALL</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">CALL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">pc</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">RETURN</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">MATCH</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">MATCH_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">MATCH_CALL_RULE</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">LIST_START</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">LIST_APPEND</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">LIST_END</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">BIND</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">ACTION</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">PUSH_STREAM</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">POP_STREAM</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">FAIL</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">FAIL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">fail_message</span><span class="p">):</span>
<span class="k">class</span> <span class="nc">SemanticAction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="k">class</span> <span class="nc">MatchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="k">class</span> <span class="nc">Grammar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="k">class</span> <span class="nc">Runtime</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>
<span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">splice</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="n">lists</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;    &quot;</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">compile_chain</span><span class="p">(</span><span class="n">grammars</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
</pre>
</div>
<p>To create a complete program, we also have to write a main function that instantiates the <code>ObjectCounter</code> grammar and invokes its <code>count</code> rule.</p>
<p>Here is an example that passes stdin as the input stream to the <code>count</code> rule and prints the result to stdout:</p>
<div class="highlight">
<pre><span></span>$ <span></span>cat object_counter_main.py
<span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ObjectCounter</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()))</span>
</pre>
</div>
<p>The <code>--copy</code> command of the RLMeta compiler can be used to copy this main file, as is, to the output.</p>
<p>Combining these pieces into a single compile command, we get this:</p>
<div class="highlight">
<pre><span></span>$ <span></span>python rlmeta.py --support --compile object_counter.rlmeta --copy object_counter_main.py &gt; object_counter.py
<span></span>
</pre>
</div>
<p>It will perform all commands in the given order and write all generated code concatenated into a single file.</p>
<p>Note that the support library comes before the grammar so that <code>Grammar</code> is defined by the time <code>ObjectCounter</code> is evaluated.</p>
<p>The object counter source code has now been compiled into a standalone Python program that can be run like this:</p>
<div class="highlight">
<pre><span></span>$ <span></span><span class="nb">echo</span> <span class="s1">'hello'</span> <span class="p">|</span> python object_counter.py
<span></span>number of objects = 6
</pre>
</div>
<div class="highlight">
<pre><span></span>$ <span></span><span class="nb">echo</span> <span class="s1">'this is longer'</span> <span class="p">|</span> python object_counter.py
<span></span>number of objects = 15
</pre>
</div>
<p>So programs in RLMeta are written mainly in grammar files with some support functions written in Python. The RLMeta compiler can process all these files to produce a single Python file which is the compiled program.</p>
<h3 id="compiling-rlmeta-itself">Compiling RLMeta itself</h3>
<p>Now that we have an understanding of RLMeta, letâ€™s look at the command that compiles the RLMeta compiler itself from the source code:</p>
<div class="highlight">
<pre><span></span>$ <span></span>python rlmeta.py --embed SUPPORT src/support.py --support --compile src/parser.rlmeta --compile src/codegenerator.rlmeta --compile src/assembler.rlmeta --copy src/main.py &gt; rlmeta-raw.py
<span></span>
</pre>
</div>
<p>The first command, <code>--embed SUPPORT src/support.py</code>, tells the compiler to generate a Python variable named <code>SUPPORT</code> containing the contents of the file <code>src/support.py</code>. The <code>--embed</code> command is the last command of the compiler that we have not yet seen. (The RLMeta compiler needs the support library in a variable so that it can generate it later with the <code>--support</code> command.)</p>
<p>Next, the <code>--support</code> command tells the compiler to generate the support library that is embedded in it.</p>
<p>The <code>--compile ...</code> commands tell the compiler to compile the given grammar files.</p>
<p>The last command, <code>--copy src/main.py</code>, tells the compiler to copy the main file verbatim. Similar to what we did to the main file in the object counter.</p>
<p>The make script can be called with the <code>--compile</code> command to perform this exact function:</p>
<div class="highlight">
<pre><span></span>$ <span></span>./make.py --compile &gt; rlmeta-compile.py
<span></span>[0;33mCompiling rlmeta using rlmeta.py[0m
[0;32m  O-----------------O[0m
[0;32m  | RLMeta compiled |[0m
[0;32m~~|     itself!     |[0m
[0;32m  O-----------------O[0m
</pre>
</div>
<p>And all these files are exactly the same:</p>
<div class="highlight">
<pre><span></span>$ <span></span>md5sum rlmeta.py rlmeta-compile.py rlmeta-raw.py
<span></span>504430e673ab5a117179667ee7e8c769  rlmeta.py
504430e673ab5a117179667ee7e8c769  rlmeta-compile.py
504430e673ab5a117179667ee7e8c769  rlmeta-raw.py
</pre>
</div>
<p>Thus, the RLMeta compiler reproduced itself exactly from the source code.</p>
<h3 id="a-tour-of-the-main-function">A tour of the main function</h3>
<p>Letâ€™s now look at how all commands of the RLMeta compiler are implemented. Here is the main function:</p>
<div class="highlight">
<pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;--compile&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;--support&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SUPPORT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;--copy&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;--embed&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
            <span class="p">))</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;--compile&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">compile_chain</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">Parser</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">CodeGenerator</span><span class="p">,</span> <span class="s2">&quot;asts&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">Assembler</span><span class="p">,</span> <span class="s2">&quot;asts&quot;</span><span class="p">)],</span>
                <span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: Unknown command '</span><span class="si">{}</span><span class="s2">'&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
</pre>
</div>
<p>It contains command line parsing and handles the basic cases.</p>
<p>The <code>--compile</code> is the most complex of them all. It calls the <code>compile_chain</code> method which runs the given grammars/rules in order (in this case the input will first be parsed, then passed to the code generator, and finally passed to the assembler) and prints a pretty error message to stderr upon failure:</p>
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">compile_chain</span><span class="p">(</span><span class="n">grammars</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">pprint</span>
    <span class="k">for</span> <span class="n">grammar</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">grammars</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">grammar</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MatchError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">MARKER</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0;31m&lt;ERROR POSITION&gt;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">stream_string</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">stream</span><span class="p">[:</span><span class="n">e</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">MARKER</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">stream</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">pos</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stream_string</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">POSITION: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">STREAM:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                <span class="n">e</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">indent</span><span class="p">(</span><span class="n">stream_string</span><span class="p">)</span>
            <span class="p">))</span>
    <span class="k">return</span> <span class="n">source</span>
</pre>
</div>
<p>This function might be useful for other grammars as well. That is why itâ€™s included in the support library and not only in the main file.</p>
<h3 id="following-a-compilation">Following a compilation</h3>
<p>Letâ€™s now follow a compilation of an example grammar to learn more about how a grammar file is turned into Python code. Here it is:</p>
<div class="highlight">
<pre><span></span>$ <span></span>cat example.rlmeta
<span></span>Example {
    main <span class="nb">=</span> <span class="nc">.</span>
}
</pre>
</div>
<p>And this is what it compiles to:</p>
<div class="highlight">
<pre><span></span>$ <span></span>python rlmeta.py --compile example.rlmeta
<span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Grammar</span><span class="p">):</span>
    <span class="n">rules</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'main'</span><span class="p">:</span> <span class="mi">0</span>
    <span class="p">}</span>
    <span class="n">code</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">PUSH_SCOPE</span><span class="p">,</span>
        <span class="n">MATCH</span><span class="p">,</span>
        <span class="s1">'any'</span><span class="p">,</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">POP_SCOPE</span><span class="p">,</span>
        <span class="n">RETURN</span>
    <span class="p">]</span>
</pre>
</div>
<p>The transformations that the grammar goes through are defined in the main function:</p>
<div class="highlight">
<pre><span></span><span class="p">[(</span><span class="n">Parser</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">CodeGenerator</span><span class="p">,</span> <span class="s2">&quot;asts&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">Assembler</span><span class="p">,</span> <span class="s2">&quot;asts&quot;</span><span class="p">)],</span>
</pre>
</div>
<p>So first the grammar file is passed to the <code>file</code> rule of the parser:</p>
<div class="highlight">
<pre><span></span>file <span class="nb">=</span>
  <span class="nb">|</span> (space grammar)<span class="nc">*</span><span class="nb">:</span>xs space <span class="nc">!.</span>            <span class="nb">-&gt;</span> xs
</pre>
</div>
<p>It it turn calls the <code>grammar</code> rule to parse all grammars in the file:</p>
<div class="highlight">
<pre><span></span>grammar <span class="nb">=</span>
  <span class="nb">|</span> name<span class="nb">:</span>x space <span class="sc">'{'</span> rule<span class="nc">*</span><span class="nb">:</span>ys space <span class="sc">'}'</span>     <span class="nb">-&gt;</span> [<span class="s">&quot;Grammar&quot;</span> x <span class="nc">~</span>ys]
</pre>
</div>
<p>This rule matches the name, the open curly brace, a set of rules, and the closing curly brace. It will then return an AST that looks like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a>[</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a>    <span class="st">&quot;Grammar&quot;</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>    <span class="st">&quot;Example&quot;</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>    ...</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>]</span></code></pre></div>
<p>All grammar AST nodes are handed off to the <code>asts</code> rule in the code generator:</p>
<div class="highlight">
<pre><span></span>asts          <span class="nb">=</span> ast<span class="nc">*</span><span class="nb">:</span>xs <span class="nc">!.</span>  <span class="nb">-&gt;</span> xs
</pre>
</div>
<p>It it turn calls the <code>ast</code> rule to process all AST nodes:</p>
<div class="highlight">
<pre><span></span>ast           <span class="nb">=</span> [<span class="nc">%</span><span class="nb">:</span>x]       <span class="nb">-&gt;</span> x
</pre>
</div>
<p>The <code>ast</code> rule treats the first argument in the AST as a rule name, and calls that rule. In this case <code>Grammar</code>:</p>
<div class="highlight">
<pre><span></span>Grammar       <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x ast<span class="nc">*</span><span class="nb">:</span>ys <span class="nb">-&gt;</span> [<span class="s">&quot;Grammar&quot;</span> x <span class="nc">~~</span>ys]
</pre>
</div>
<p>The code generator creates a new AST node representing a grammar. But this AST node is slightly different and meant to be processed by the assembler. The result is this:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>[</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>    <span class="st">&quot;Grammar&quot;</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>    <span class="st">&quot;Example&quot;</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>    ... ast nodes <span class="cf">for</span> consumption by assembler ...</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>]</span></code></pre></div>
<p>This AST node and all the others that the code generator produces are passed to the <code>asts</code> rule in the assembler:</p>
<div class="highlight">
<pre><span></span>asts     <span class="nb">=</span> ast<span class="nc">*</span><span class="nb">:</span>xs <span class="nc">!.</span>      <span class="nb">-&gt;</span> { xs }
</pre>
</div>
<p>It in turn calls the <code>ast</code> rule:</p>
<div class="highlight">
<pre><span></span>ast      <span class="nb">=</span> [<span class="nc">%</span><span class="nb">:</span>x]           <span class="nb">-&gt;</span> x
</pre>
</div>
<p>Which does the same trick again, now invoking the <code>Grammar</code> rule (in the assembler) which looks like this:</p>
<div class="highlight">
<pre><span></span>Grammar  <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x ast<span class="nc">*</span><span class="nb">:</span>ys     <span class="nb">-&gt;</span> list()<span class="nb">:</span>rules
                           <span class="nb">-&gt;</span> list()<span class="nb">:</span>code
                           <span class="nb">-&gt;</span> dict()<span class="nb">:</span>labels
                           <span class="nb">-&gt;</span> list()<span class="nb">:</span>patches
                           <span class="nb">-&gt;</span> ys
                           <span class="nb">-&gt;</span> run(<span class="s">&quot;asts&quot;</span> patches)
                           <span class="nb">-&gt;</span> { <span class="s">&quot;class &quot;</span> x <span class="s">&quot;(Grammar):</span><span class="se">\n</span><span class="s">&quot;</span> &gt;
                                  <span class="s">&quot;rules = {</span><span class="se">\n</span><span class="s">&quot;</span> &gt; join(rules <span class="s">&quot;,</span><span class="se">\n</span><span class="s">&quot;</span>) &lt; <span class="s">&quot;</span><span class="se">\n</span><span class="s">}</span><span class="se">\n</span><span class="s">&quot;</span>
                                  <span class="s">&quot;code = [</span><span class="se">\n</span><span class="s">&quot;</span> &gt; join(code  <span class="s">&quot;,</span><span class="se">\n</span><span class="s">&quot;</span>) &lt; <span class="s">&quot;</span><span class="se">\n</span><span class="s">]</span><span class="se">\n</span><span class="s">&quot;</span>
                                &lt; }
</pre>
</div>
<p>This rule can be read as follows:</p>
<ul>
<li>Match the grammar name and all AST nodes</li>
<li>Perform the following action
<ul>
<li>Define a variable called <code>rules</code> which is a list</li>
<li>Define a variable called <code>code</code> which is a list</li>
<li>Define a variable called <code>labels</code> which is a dictionary</li>
<li>Define a variable called <code>patches</code> which is a list</li>
<li>Evaluate the AST nodes (with possible side effects recorded in the above variables)</li>
<li>Tread the contents of the <code>code</code> variable as a list of AST nodes and process them with the <code>asts</code> rule of this grammar</li>
<li>Return a string which is generated Python code</li>
</ul></li>
</ul>
<p>The generated code from our example looks like this:</p>
<pre><code>class Example(Grammar):
    rules = {
        ...
    }
    code = [
        ...
    ]</code></pre>
<p>To understand how the <code>rule</code> and <code>code</code> sections are generated, we just have to follow a few more transformations.</p>
<p>Letâ€™s look at one more and see how the rule in our example grammar is transformed.</p>
<p>First, the rule is parsed by the <code>rule</code> rule in the parser:</p>
<div class="highlight">
<pre><span></span>rule <span class="nb">=</span>
  <span class="nb">|</span> name<span class="nb">:</span>x space <span class="sc">'='</span> choice<span class="nb">:</span>y               <span class="nb">-&gt;</span> [<span class="s">&quot;Rule&quot;</span> x y]
</pre>
</div>
<p>First the name is matched, then the equals sign, and then an expression representing the body of the rule.</p>
<p>It our case, this rule produces this AST node:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a>[</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    <span class="st">&quot;Rule&quot;</span>,</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    <span class="st">&quot;main&quot;</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>    ...</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>]</span></code></pre></div>
<p>That node is going to be processed by the <code>Rule</code> rule in the code generator:</p>
<div class="highlight">
<pre><span></span>Rule          <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x ast<span class="nb">:</span>y   <span class="nb">-&gt;</span> [[<span class="s">&quot;Rule&quot;</span> x]
                                <span class="nc">~</span>y
                                [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;RETURN&quot;</span>]]
</pre>
</div>
<p>Generating an AST node that looks like this:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>[</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>    [<span class="st">&quot;Rule&quot;</span>, <span class="st">&quot;main&quot;</span>],</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>    ...,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>    [<span class="st">&quot;OpCode&quot;</span>, <span class="st">&quot;RETURN&quot;</span>]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>]</span></code></pre></div>
<p>Here we can see that the AST from the code generator looks a bit more like assembly code than a representation of the syntax in the grammar.</p>
<p>The first child in this AST node is going to be handled the <code>Rule</code> rule in the assembler:</p>
<div class="highlight">
<pre><span></span>Rule     <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> add(rules { repr(x) <span class="s">&quot;: &quot;</span> len(code) })
                           <span class="nb">-&gt;</span> set(labels x len(code))
</pre>
</div>
<p>It does two things:</p>
<ol type="1">
<li>Adds a string value to the <code>rules</code> list</li>
<li>Adds an entry to the <code>labels</code> dictionary to map a label to an index in the <code>code</code> list</li>
</ol>
<p>At this point, the variables have the following values.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a>rules <span class="op">=</span> [</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>    <span class="st">&quot;'main': 0&quot;</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>]</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>labels <span class="op">=</span> {</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>    <span class="st">'main'</span>: <span class="dv">0</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>}</span></code></pre></div>
<p>The second child in the AST node is going to be handled by the <code>OpCode</code> rule in the assembler:</p>
<div class="highlight">
<pre><span></span>OpCode   <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> add(code x)
</pre>
</div>
<p>It adds the given op code to the <code>code</code> list, giving it this value:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>code <span class="op">=</span> [</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>    ...,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>    <span class="st">&quot;RETURN&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>]</span></code></pre></div>
<p>When the <code>rules</code> and <code>code</code> variables are expanded, the resulting class looks like this:</p>
<pre><code>class Example(Grammar):
    rules = {
        'main': 0
    }
    code = [
        ...,
        RETURN
    ]</code></pre>
<p>Hopefully you should now be comfortable to follow transformations yourself to understand how a compilation is done.</p>
<h3 id="the-purpose-of-the-make-script">The purpose of the make script</h3>
<p>When the make script is called without arguments, it performs a meta compilation and runs a few tests:</p>
<div class="highlight">
<pre><span></span>$ <span></span>./make.py
<span></span>[0;33mCompiling rlmeta using rlmeta.py[0m
[0;33mWriting rlmeta1.py[0m
[0;33mTest: Has its own support library[0m
[0;33mTest: Disallow semantic action in the middle[0m
ERROR: expected }
POSITION: 22
STREAM:
    Grammar { x = . -&gt; [] [0;31m&lt;ERROR POSITION&gt;[0m. }
[0;33mTest: Call unknown rule foo[0m
[0;33mMoving rlmeta1.py -&gt; rlmeta.py[0m
[0;32m  O-----------------O[0m
[0;32m  | RLMeta compiled |[0m
[0;32m~~|     itself!     |[0m
[0;32m  O-----------------O[0m
</pre>
</div>
<p>The meaning of a meta compilation is to create a new version of RLMeta that can still reproduce it self from the source code.</p>
<p>In the output above, we can see that it compiled RLMeta and wrote the result to <code>rlmeta1.py</code>. In this case, since it is exactly the same as <code>rlmeta.py</code>, the compilation stopped there and a few more tests were run using this compiler. But if we make changes to the source code, <code>rlmeta1.py</code> will most likely not be exactly the same as <code>rlmeta.py</code>, and a few more compilations might be needed. Iâ€™ve written about the details of meta compilation in a <a href="../../writing/modifying-rlmeta/index.html#5f6a1c91143146dbb3b865ac42562135">previous blog post</a>.</p>
<p>So the purpose of the make script is the ease meta compilations and also run a test suit on the newly generated metacompiler before accepting it.</p>
<h2 id="changes-from-the-previous-version">Changes from the previous version</h2>
<p>This section explains the most important changes in this version of RLMeta compared to the original poster version.</p>
<p>First of all, I wanted to work on the unresolved items which were the following:</p>
<ul>
<li>The label counter is incremented at match time, not at semantic action evaluation time.</li>
<li>Compilation depends on Bash.</li>
<li>Assembly code in code generator is hard to read.</li>
</ul>
<p>In the poster article, I also had a few notes about <a href="../../writing/creating-rlmeta-poster/index.html#b070abcd2f134cf894e33e63188a9fee">future versions</a>:</p>
<blockquote>
<p>The smaller it is, the easier it is to understand and therefore extend. The more flexible it is to extend the better. If I make another poster version it would therefore focus on being smaller and more flexible. Since all successive version of RLMeta have been faster than the ones before, performance is also important. But small size, clarity, and flexibility come first.</p>
</blockquote>
<p>I used these guidelines to decide if certain changes should go into the new version or not.</p>
<p>One interesting thing to note is that the guidelines are sometimes contradicting. Writing clear code might mean more lines of code which makes the code base larger. Perhaps thatâ€™s also why I got stuck chasing perfection. I thought I made something easier to read, but it ended up costing 10 extra lines of code. Should I include it?</p>
<h3 id="generate-labels-in-semantic-actions">Generate labels in semantic actions</h3>
<p>One thing that I left in the first version of the poster that still annoyed me was that labels were generated at match time, not at semantic action evaluation time. It would not produce incorrect results. At worst, some labels end up not being used because the counter value captured was in a rule that later failed. But dealing with labels at match time does not make sense. It should really happen at semantic action evaluation time.</p>
<p>Here is what the <code>Not</code> rule looks like in the first version of the poster:</p>
<div class="highlight">
<pre><span></span>Not <span class="nb">=</span> ast<span class="nb">:</span>x <span class="nc">#</span><span class="nb">:</span>a <span class="nc">#</span><span class="nb">:</span>b <span class="nb">-&gt;</span> { <span class="s">&quot;I('BACKTRACK', &quot;</span> b <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
                         x
                         <span class="s">&quot;I('COMMIT', &quot;</span> a <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
                         <span class="s">&quot;LABEL(&quot;</span> a <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
                         <span class="s">&quot;I('FAIL', 'no match expected')</span><span class="se">\n</span><span class="s">&quot;</span>
                         <span class="s">&quot;LABEL(&quot;</span> b <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>                   }
</pre>
</div>
<p>Here is what the <code>Not</code> rule looks like after the change:</p>
<div class="highlight">
<pre><span></span>Not <span class="nb">=</span> ast<span class="nb">:</span>x <span class="nb">-&gt;</span> label()<span class="nb">:</span>a <span class="nb">-&gt;</span> label()<span class="nb">:</span>b
            <span class="nb">-&gt;</span> { <span class="s">&quot;I('BACKTRACK', &quot;</span> b <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
                 x
                 <span class="s">&quot;I('COMMIT', &quot;</span> a <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
                 <span class="s">&quot;LABEL(&quot;</span> a <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
                 <span class="s">&quot;I('FAIL', 'no match expected')</span><span class="se">\n</span><span class="s">&quot;</span>
                 <span class="s">&quot;LABEL(&quot;</span> b <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>                   }
</pre>
</div>
<p>This change puts label generation where it belongs, in semantic actions, and thus makes the implementation <strong>more clear</strong>. The VM is no longer concerned with labels. It is only concerned with matching. It does make semantic actions a bit more complicated, but the bind syntax is familiar from match expressions and an action being a sequence of things should be familiar as well.</p>
<p>This change required a bit of rework how semantic actions work. Previously only one expression was allowed. Now multiple expressions are allowed. The result of expressions can also be bound to names which subsequent expressions can refer to. Furthermore, there are now also runtime variables that are set with bindings. <code>label</code> is a built in runtime function that generates increasing integers starting at 0.</p>
<p>The implementation of this change also <strong>increases the flexibility</strong> of RLMeta. For example, it is now possible to write a semantic action that generates code in different sections like this:</p>
<div class="highlight">
<pre><span></span>ExampleBuffers {
    program  <span class="nb">=</span> ast<span class="nb">:</span>x  <span class="nb">-&gt;</span> Buffer()<span class="nb">:</span>header
                      <span class="nb">-&gt;</span> { <span class="s">&quot;# HEADER</span><span class="se">\n</span><span class="s">&quot;</span>
                           header
                           <span class="s">&quot;# BODY</span><span class="se">\n</span><span class="s">&quot;</span>
                           x            }
    ast      <span class="nb">=</span> [<span class="nc">%</span><span class="nb">:</span>x]  <span class="nb">-&gt;</span> x
    Program  <span class="nb">=</span> ast<span class="nc">*</span>
    Function <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>name <span class="nb">-&gt;</span> header({ <span class="s">&quot;def &quot;</span> name <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> })
                      <span class="nb">-&gt;</span> { name <span class="s">&quot;()</span><span class="se">\n</span><span class="s">&quot;</span> }
}
</pre>
</div>
<p><code>Buffer</code> is a specialised list that appends an element when called as a function:</p>
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">Buffer</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</pre>
</div>
<p>Here is an example AST representing a program:</p>
<div class="highlight">
<pre><span></span><span class="n">AST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="s1">'Program'</span><span class="p">,</span>
        <span class="p">[</span><span class="s1">'Function'</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">'Function'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">]</span>
    <span class="p">]</span>
<span class="p">]</span>
</pre>
</div>
<p>When the <code>program</code> rule is run on the example input, the following is output:</p>
<div class="highlight">
<pre><span></span>$ <span></span>python example_buffers.py
<span></span># HEADER
def foo
def bar
# BODY
foo()
bar()
</pre>
</div>
<p>This type of thing is useful for example when generating C functions where definitions need to go in â€œheaderâ€ and declarations in â€œbodyâ€.</p>
<p>In summary, this change is as follows:</p>
<ul>
<li>Label syntax (<code>#</code>) in parser is removed</li>
<li>Actions can have multiple expressions</li>
<li>Expressions can be bound to names</li>
<li>A default <code>label</code> function to generate labels</li>
<li>Names in semantic actions refer to matches or results bound earlier</li>
</ul>
<p>The complete initial diff for this change can be found on <a href="https://github.com/rickardlindberg/rickardlindberg.me/commit/5154583e9d98c123630fb41664aa6906d4801d05">GitHub</a>. Note that later changes have been made that make the <code>Not</code> rule not look like above for example.</p>
<p>The increased clarity and flexibility come with a price. The size increases and the performance drops.</p>
<p>The parser and the code generator are mostly the same. The greatest addition is in the support library. Which is expected when semantic action evaluation becomes more complex. The drop in performance is likely due to more function calls when evaluating semantic actions. Even though size and performance got worse, I believe the clarity and flexibility gain is worth it.</p>
<h3 id="remove-dependency-on-bash">Remove dependency on Bash</h3>
<p>TODO: improve this section</p>
<p>To compile the previous version of RLMeta, you ran the following command:</p>
<pre><code>./compile.sh rlmeta.py</code></pre>
<p>In one way, the compiler could not compile itself, but relied on a Bash script for gluing things together. It would call the <code>rlmeta.py</code> compiler for certain tasks and use Bash and Python for other tasks.</p>
<p>As we have already seen, the new version of RLMeta compiles itself like this:</p>
<pre><code>python rlmeta.py \
    --embed SUPPORT src/support.py \
    --support \
    --compile src/parser.rlmeta \
    --compile src/codegenerator.rlmeta \
    --compile src/assembler.rlmeta \
    --copy src/main.py \
    &gt; rlmeta.py</code></pre>
<p>The <code>rlmeta.py</code> compiler now has support for doing what the Bash script previously did via <code>--embed</code>, <code>--copy</code>.</p>
<p>This makes the compiler slightly larger, but it feels so much cleaner.</p>
<p>In addition, the extra features are useful when writing programs in RLMeta. Those programs can now also be compiled with a single command, and there is no need to concatenate different pieces together.</p>
<p>The complete diff for this change can be found on <a href="https://github.com/rickardlindberg/rickardlindberg.me/commit/935bb77e1d5b88e09de64112aa2fb2f46dbcb7d9">GitHub</a>.</p>
<h3 id="extract-assembler">Extract assembler</h3>
<p>The third thing I had a problem with was the readability of the code generator. For example, the <code>Not</code> rule looked like this:</p>
<div class="highlight">
<pre><span></span>Not <span class="nb">=</span> ast<span class="nb">:</span>x <span class="nb">-&gt;</span> label()<span class="nb">:</span>a <span class="nb">-&gt;</span> label()<span class="nb">:</span>b
            <span class="nb">-&gt;</span> { <span class="s">&quot;I('BACKTRACK', &quot;</span> b <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
                 x
                 <span class="s">&quot;I('COMMIT', &quot;</span> a <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
                 <span class="s">&quot;LABEL(&quot;</span> a <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>
                 <span class="s">&quot;I('FAIL', 'no match expected')</span><span class="se">\n</span><span class="s">&quot;</span>
                 <span class="s">&quot;LABEL(&quot;</span> b <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span>                   }
</pre>
</div>
<p>It generates a string which outputs some Python code that calls some functions to create â€œassemblyâ€ code. It is mixed and messy.</p>
<p>The new <code>Not</code> rule looks like this:</p>
<div class="highlight">
<pre><span></span>Not           <span class="nb">=</span> ast<span class="nb">:</span>x       <span class="nb">-&gt;</span> label()<span class="nb">:</span>a <span class="nb">-&gt;</span> label()<span class="nb">:</span>b
                            <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;BACKTRACK&quot;</span>]
                                [<span class="s">&quot;Target&quot;</span> b]
                                <span class="nc">~</span>x
                                [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;COMMIT&quot;</span>]
                                [<span class="s">&quot;Target&quot;</span> a]
                                [<span class="s">&quot;Label&quot;</span> a]
                                [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;FAIL&quot;</span>]
                                [<span class="s">&quot;Value&quot;</span> <span class="s">&quot;no match&quot;</span>]
                                [<span class="s">&quot;Label&quot;</span> b]]
</pre>
</div>
<p>It now generates abstract assembly code. Much cleaner. And then an assembler turns that into Python code.</p>
<p>This adds another pass to the compiler. It also makes it possible to do optimizations on abstract assembly code.</p>
<p>[x] Move â€œassemblyâ€ out of support library. Grammar should generate labels/instructions.</p>
<p>[x] Split code generator into code generator and python assembler. That makes each phase more clear and allows for optimizations.</p>
<p>[x] Resolve labels in assembler.</p>
<p>[ ] Add one more pass in between parser and codegen that generates VM-instrucionts [ ] VM-instructions will be easier to read [ ] Possible for peephole optimizations before generating Python code</p>
<h3 id="clearer-vm">Clearer VM</h3>
<ul>
<li>Previously the VM was written for performance</li>
<li>Now the VM is written to be clear</li>
<li>Not sure size changed that much, but clarity did</li>
<li>Still not happy with the VM</li>
</ul>
<p>Before I ended up with the clear VM, I did another experiment with PyVM.</p>
<p>PyVM was a new language whose sole purpose was to express virtual machines that compiled to a Python function. It was basically a small macro language on top of Python.</p>
<pre><code>TODO: Example PyVM code

TODO: Example of what it turned it into</code></pre>
<p>I got this approach working, and the VM was expressed quite nicely, but it introduced complexity to the whole project:</p>
<ul>
<li>There were grammars for PyVM</li>
<li>The VM had to be generated before it could be included in the support library</li>
</ul>
<p>I decided that the complexity was not worth it and decided to not care about performance and instead write the VM as clean as I could in pure Python.</p>
<p>[x] Get rid of PyVM</p>
<pre><code>[x] Compilation was further complicated now when VM has to be generated and
    a combined support library created.

[x] Clean up PyVM grammars

[x] Write VM as clean as possible in Python. Then write a separate
    optimized VM?</code></pre>
<h3 id="ability-to-run-a-rule-in-semantic-action">Ability to run a rule in semantic action</h3>
<ul>
<li><p>Perhaps it originally came from PyVM?</p></li>
<li><p>Support recursive macros?</p>
<ul>
<li><p>Probably requires function to run grammar against an object.</p></li>
<li><p>Needed to get rid of duplicated call code.</p></li>
</ul></li>
</ul>
<h3 id="misc">Misc</h3>
<ul>
<li><p>Reformat to improve readability.</p></li>
<li><p>Rename to make intention more clear.</p></li>
<li><p>Join using support function</p>
<ul>
<li>Smaller and faster</li>
<li>https://github.com/rickardlindberg/rickardlindberg.me/commit/c7cde4ef64db9c871ee25ea7ec39d26a1adb6d7d</li>
</ul></li>
<li><p>Disallow semantic actions in the middle</p>
<ul>
<li>More clear</li>
<li>Before after</li>
<li>Test case</li>
<li>https://github.com/rickardlindberg/rickardlindberg.me/commit/4934b9105ec609de2d59fce955d41879ef57fcea</li>
</ul>
<p>$ echo â€œGrammar { rule = . -&gt;[] . }â€ | python rlmeta.py class Grammar(Grammar):</p>
<pre><code>  def assemble(self, I, LABEL):
      LABEL('rule')
      I('PUSH_SCOPE')
      I('MATCH_ANY')
      I('ACTION', lambda scope: concat([]))
      I('MATCH_ANY')
      I('POP_SCOPE')
      I('RETURN')</code></pre>
<p>$ echo â€œGrammar { rule = . -&gt;[] . }â€ | python rlmeta.py ERROR: expected â€˜}â€™ POSITION: 24 STREAM: Grammar { rule = . -&gt;[] <ERROR POSITION>. }</p></li>
<li><p>Allow indent prefix to be changed</p>
<ul>
<li>More flexible</li>
<li>Better flexibility at marginal cost. A little slower, but fixed by optimizing indent a little.</li>
<li>https://github.com/rickardlindberg/rickardlindberg.me/commit/ac6126b7ea6a8d38967d7cb5bcfe6784332f587a</li>
</ul>
<p>def indent(text): return join(join([" ", line]) for line in text.splitlines(True))</p>
<p>def indent(text, prefix=" â€œ): returnâ€".join(prefix + line for line in text.splitlines(True))</p></li>
<li><p>Runtime vars outside VM</p>
<ul>
<li>More stuff moved out of VM</li>
</ul></li>
<li><p>Adapt to Python 3.</p></li>
<li><p>Better error message than None if runtime/scope is not found.</p>
<ul>
<li>Rename match -&gt; matches in Scope</li>
<li>Immutable scope instead and fail if entry does not exist?</li>
</ul></li>
<li><p>Counter class is more clean</p></li>
<li><p>No need to wrap parser output in list for codegenerator in RLMeta</p></li>
<li><p>Put compile + error reporting function in support lib.</p></li>
<li><p>You can put any crap at end of file, and parsers donâ€™t care. Fix it!</p></li>
<li><p>VM should not know about runtime.</p></li>
<li><p>No failure if VM-compilation fails? (Swap Instruction arguments.)</p></li>
<li><p>Better AST for action expressions.</p></li>
<li><p>Can â€œnativeâ€ calls be removed by adding binding in runtime?</p></li>
<li><p>Put object match expr tree in parser instead of in codegen?</p>
<ul>
<li>This makes the VM more clean. There is only one instruction for matching and the matching is done with a Python lambda. The VM knows nothing about how to match a single object.</li>
</ul></li>
</ul>
<h2 id="the-future">The future</h2>
<p>On the one hand, Iâ€™m quite happy with the improvements to RLMeta that I was able to make. The code feels more clear and flexible. Definitely a better version of RLMeta.</p>
<p>On the other hand, this article turned out to have the same problem as the poster. It just kept growing and growing, and at some point I had to stop working on in, leave some issues unresolved, and call the article finished. For example, I am not happy with how the new VM looks. A mix between classes and functions and helpers.</p>
<p>I decided to set up a repo for RLMeta where it can continue to be improved.</p>
<p>I plan for it to contain the base version which is the minimal version to be able to compile itself and maintain properties such as flexible, easy to extend, easy to understand.</p>
<p>Then to show examples how you can extend it in various ways and show examples how RLMeta can be used.</p>
<h2 id="code-listings-for-rlmeta">Code listings for RLMeta</h2>
<p>Here is all the source code and also the make script for this version of RLMeta.</p>
<h3 id="srcparser.rlmeta">src/parser.rlmeta</h3>
<div class="highlight">
<pre><span></span>Parser {
  file <span class="nb">=</span>
    <span class="nb">|</span> (space grammar)<span class="nc">*</span><span class="nb">:</span>xs space <span class="nc">!.</span>            <span class="nb">-&gt;</span> xs
  grammar <span class="nb">=</span>
    <span class="nb">|</span> name<span class="nb">:</span>x space <span class="sc">'{'</span> rule<span class="nc">*</span><span class="nb">:</span>ys space <span class="sc">'}'</span>     <span class="nb">-&gt;</span> [<span class="s">&quot;Grammar&quot;</span> x <span class="nc">~</span>ys]
  rule <span class="nb">=</span>
    <span class="nb">|</span> name<span class="nb">:</span>x space <span class="sc">'='</span> choice<span class="nb">:</span>y               <span class="nb">-&gt;</span> [<span class="s">&quot;Rule&quot;</span> x y]
  choice <span class="nb">=</span>
    <span class="nb">|</span> (space <span class="sc">'|'</span>)<span class="nc">?</span>
      sequence<span class="nb">:</span>x (space <span class="sc">'|'</span> sequence)<span class="nc">*</span><span class="nb">:</span>xs     <span class="nb">-&gt;</span> [<span class="s">&quot;Or&quot;</span> x <span class="nc">~</span>xs]
  sequence <span class="nb">=</span>
    <span class="nb">|</span> expr<span class="nc">*</span><span class="nb">:</span>xs maybeAction<span class="nb">:</span>ys                 <span class="nb">-&gt;</span> [<span class="s">&quot;Scope&quot;</span> [<span class="s">&quot;And&quot;</span> <span class="nc">~</span>xs <span class="nc">~</span>ys]]
  expr <span class="nb">=</span>
    <span class="nb">|</span> expr1<span class="nb">:</span>x space <span class="sc">':'</span> name<span class="nb">:</span>y                <span class="nb">-&gt;</span> [<span class="s">&quot;Bind&quot;</span> y x]
    <span class="nb">|</span> expr1
  expr1 <span class="nb">=</span>
    <span class="nb">|</span> expr2<span class="nb">:</span>x space <span class="sc">'*'</span>                       <span class="nb">-&gt;</span> [<span class="s">&quot;Star&quot;</span> x]
    <span class="nb">|</span> expr2<span class="nb">:</span>x space <span class="sc">'?'</span>                       <span class="nb">-&gt;</span> [<span class="s">&quot;Or&quot;</span> x [<span class="s">&quot;And&quot;</span>]]
    <span class="nb">|</span> space <span class="sc">'!'</span> expr2<span class="nb">:</span>x                       <span class="nb">-&gt;</span> [<span class="s">&quot;Not&quot;</span> x]
    <span class="nb">|</span> space <span class="sc">'%'</span>                               <span class="nb">-&gt;</span> [<span class="s">&quot;MatchCallRule&quot;</span>]
    <span class="nb">|</span> expr2
  expr2 <span class="nb">=</span>
    <span class="nb">|</span> name<span class="nb">:</span>x <span class="nc">!</span>(space <span class="sc">'='</span>)                     <span class="nb">-&gt;</span> [<span class="s">&quot;MatchRule&quot;</span> x]
    <span class="nb">|</span> space char<span class="nb">:</span>x <span class="sc">'-'</span> char<span class="nb">:</span>y                 <span class="nb">-&gt;</span> [<span class="s">&quot;MatchObject&quot;</span> [<span class="s">&quot;Range&quot;</span> x y]]
    <span class="nb">|</span> space <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> (<span class="nc">!</span><span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> matchChar)<span class="nc">*</span><span class="nb">:</span>xs <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span>   <span class="nb">-&gt;</span> [<span class="s">&quot;And&quot;</span> <span class="nc">~</span>xs]
    <span class="nb">|</span> space <span class="sc">'.'</span>                               <span class="nb">-&gt;</span> [<span class="s">&quot;MatchObject&quot;</span> [<span class="s">&quot;Any&quot;</span>]]
    <span class="nb">|</span> space <span class="sc">'('</span> choice<span class="nb">:</span>x space <span class="sc">')'</span>            <span class="nb">-&gt;</span> x
    <span class="nb">|</span> space <span class="sc">'['</span> expr<span class="nc">*</span><span class="nb">:</span>xs space <span class="sc">']'</span>            <span class="nb">-&gt;</span> [<span class="s">&quot;MatchList&quot;</span> [<span class="s">&quot;And&quot;</span> <span class="nc">~</span>xs]]
  matchChar <span class="nb">=</span>
    <span class="nb">|</span> innerChar<span class="nb">:</span>x                             <span class="nb">-&gt;</span> [<span class="s">&quot;MatchObject&quot;</span> [<span class="s">&quot;Eq&quot;</span> x]]
  maybeAction <span class="nb">=</span>
    <span class="nb">|</span> actionExpr<span class="nb">:</span>x                            <span class="nb">-&gt;</span> [[<span class="s">&quot;Action&quot;</span> x]]
    <span class="nb">|</span>                                         <span class="nb">-&gt;</span> []
  actionExpr <span class="nb">=</span>
    <span class="nb">|</span> space <span class="sc">'-&gt;'</span> hostExpr<span class="nb">:</span>x
      (space <span class="sc">':'</span> name <span class="nb">|</span> <span class="nb">-&gt;</span> <span class="s">&quot;&quot;</span>)<span class="nb">:</span>y actionExpr<span class="nb">:</span>z <span class="nb">-&gt;</span> [<span class="s">&quot;Set&quot;</span> y x z]
    <span class="nb">|</span> space <span class="sc">'-&gt;'</span> hostExpr<span class="nb">:</span>x                   <span class="nb">-&gt;</span> x
  hostExpr <span class="nb">=</span>
    <span class="nb">|</span> space string<span class="nb">:</span>x                          <span class="nb">-&gt;</span> [<span class="s">&quot;String&quot;</span> x]
    <span class="nb">|</span> space <span class="sc">'['</span> hostListItem<span class="nc">*</span><span class="nb">:</span>xs space <span class="sc">']'</span>    <span class="nb">-&gt;</span> [<span class="s">&quot;List&quot;</span> <span class="nc">~</span>xs]
    <span class="nb">|</span> space <span class="sc">'{'</span> formatExpr<span class="nc">*</span><span class="nb">:</span>xs space <span class="sc">'}'</span>      <span class="nb">-&gt;</span> [<span class="s">&quot;Format&quot;</span> <span class="nc">~</span>xs]
    <span class="nb">|</span> var<span class="nb">:</span>x space <span class="sc">'('</span> hostExpr<span class="nc">*</span><span class="nb">:</span>ys space <span class="sc">')'</span>  <span class="nb">-&gt;</span> [<span class="s">&quot;Call&quot;</span> x <span class="nc">~</span>ys]
    <span class="nb">|</span> var<span class="nb">:</span>x
  hostListItem <span class="nb">=</span>
    <span class="nb">|</span> space <span class="sc">'~'</span><span class="nc">*</span><span class="nb">:</span>ys hostExpr<span class="nb">:</span>x                <span class="nb">-&gt;</span> [<span class="s">&quot;ListItem&quot;</span> len(ys) x]
  formatExpr <span class="nb">=</span>
    <span class="nb">|</span> space <span class="sc">'&gt;'</span> formatExpr<span class="nc">*</span><span class="nb">:</span>xs space <span class="sc">'&lt;'</span>      <span class="nb">-&gt;</span> [<span class="s">&quot;Indent&quot;</span> [<span class="s">&quot;Format&quot;</span> <span class="nc">~</span>xs]]
    <span class="nb">|</span> hostExpr
  var <span class="nb">=</span>
    <span class="nb">|</span> name<span class="nb">:</span>x <span class="nc">!</span>(space <span class="sc">'='</span>)                     <span class="nb">-&gt;</span> [<span class="s">&quot;Lookup&quot;</span> x]
  string    <span class="nb">=</span> <span class="sc">'&quot;'</span>  (<span class="nc">!</span><span class="sc">'&quot;'</span>  innerChar)<span class="nc">*</span><span class="nb">:</span>xs <span class="sc">'&quot;'</span>  <span class="nb">-&gt;</span> { xs }
  char      <span class="nb">=</span> <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span>  <span class="nc">!</span><span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> innerChar  <span class="nb">:</span>x  <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> <span class="nb">-&gt;</span> x
  innerChar <span class="nb">=</span> <span class="sc">'</span><span class="se">\\</span><span class="sc">'</span> escape <span class="nb">|</span> <span class="nc">.</span>
  escape    <span class="nb">=</span> <span class="sc">'</span><span class="se">\\</span><span class="sc">'</span> <span class="nb">-&gt;</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span> <span class="nb">|</span> <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> <span class="nb">-&gt;</span> <span class="s">&quot;'&quot;</span>
            <span class="nb">|</span> <span class="sc">'&quot;'</span>  <span class="nb">-&gt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="nb">|</span> <span class="sc">'n'</span>  <span class="nb">-&gt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
  name      <span class="nb">=</span> space nameStart<span class="nb">:</span>x nameChar<span class="nc">*</span><span class="nb">:</span>xs  <span class="nb">-&gt;</span> { x xs }
  nameStart <span class="nb">=</span> <span class="sc">'a'</span><span class="nc">-</span><span class="sc">'z'</span> <span class="nb">|</span> <span class="sc">'A'</span><span class="nc">-</span><span class="sc">'Z'</span>
  nameChar  <span class="nb">=</span> <span class="sc">'a'</span><span class="nc">-</span><span class="sc">'z'</span> <span class="nb">|</span> <span class="sc">'A'</span><span class="nc">-</span><span class="sc">'Z'</span> <span class="nb">|</span> <span class="sc">'0'</span><span class="nc">-</span><span class="sc">'9'</span>
  space     <span class="nb">=</span> (<span class="sc">' '</span> <span class="nb">|</span> <span class="sc">'</span><span class="se">\n</span><span class="sc">'</span>)<span class="nc">*</span>
}
</pre>
</div>
<h3 id="srccodegenerator.rlmeta">src/codegenerator.rlmeta</h3>
<div class="highlight">
<pre><span></span>CodeGenerator {
  Grammar       <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x ast<span class="nc">*</span><span class="nb">:</span>ys <span class="nb">-&gt;</span> [<span class="s">&quot;Grammar&quot;</span> x <span class="nc">~~</span>ys]
  Rule          <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x ast<span class="nb">:</span>y   <span class="nb">-&gt;</span> [[<span class="s">&quot;Rule&quot;</span> x]
                                  <span class="nc">~</span>y
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;RETURN&quot;</span>]]
  Or            <span class="nb">=</span>
    <span class="nb">|</span> ast<span class="nb">:</span>x Or<span class="nb">:</span>y              <span class="nb">-&gt;</span> label()<span class="nb">:</span>a <span class="nb">-&gt;</span> label()<span class="nb">:</span>b
                              <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;BACKTRACK&quot;</span>]
                                  [<span class="s">&quot;Target&quot;</span> a]
                                  <span class="nc">~</span>x
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;COMMIT&quot;</span>]
                                  [<span class="s">&quot;Target&quot;</span> b]
                                  [<span class="s">&quot;Label&quot;</span> a]
                                  <span class="nc">~</span>y
                                  [<span class="s">&quot;Label&quot;</span> b]]
    <span class="nb">|</span> ast
  Scope         <span class="nb">=</span> ast<span class="nb">:</span>x       <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;PUSH_SCOPE&quot;</span>]
                                  <span class="nc">~</span>x
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;POP_SCOPE&quot;</span>]]
  And           <span class="nb">=</span> ast<span class="nc">*</span><span class="nb">:</span>xs     <span class="nb">-&gt;</span> [<span class="nc">~~</span>xs]
  Bind          <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x ast<span class="nb">:</span>y   <span class="nb">-&gt;</span> [<span class="nc">~</span>y
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;BIND&quot;</span>]
                                  [<span class="s">&quot;Value&quot;</span> x]]
  Star          <span class="nb">=</span> ast<span class="nb">:</span>x       <span class="nb">-&gt;</span> label()<span class="nb">:</span>a <span class="nb">-&gt;</span> label()<span class="nb">:</span>b
                              <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;LIST_START&quot;</span>]
                                  [<span class="s">&quot;Label&quot;</span> a]
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;BACKTRACK&quot;</span>]
                                  [<span class="s">&quot;Target&quot;</span> b]
                                  <span class="nc">~</span>x
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;LIST_APPEND&quot;</span>]
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;COMMIT&quot;</span>]
                                  [<span class="s">&quot;Target&quot;</span> a]
                                  [<span class="s">&quot;Label&quot;</span> b]
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;LIST_END&quot;</span>]]
  Not           <span class="nb">=</span> ast<span class="nb">:</span>x       <span class="nb">-&gt;</span> label()<span class="nb">:</span>a <span class="nb">-&gt;</span> label()<span class="nb">:</span>b
                              <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;BACKTRACK&quot;</span>]
                                  [<span class="s">&quot;Target&quot;</span> b]
                                  <span class="nc">~</span>x
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;COMMIT&quot;</span>]
                                  [<span class="s">&quot;Target&quot;</span> a]
                                  [<span class="s">&quot;Label&quot;</span> a]
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;FAIL&quot;</span>]
                                  [<span class="s">&quot;Value&quot;</span> <span class="s">&quot;no match&quot;</span>]
                                  [<span class="s">&quot;Label&quot;</span> b]]
  MatchCallRule <span class="nb">=</span>             <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;MATCH_CALL_RULE&quot;</span>]]
  MatchRule     <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x         <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;CALL&quot;</span>]
                                  [<span class="s">&quot;Target&quot;</span> x]]
  MatchObject   <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x         <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;MATCH&quot;</span>]
                                  x]
  MatchList     <span class="nb">=</span> ast<span class="nb">:</span>x       <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;PUSH_STREAM&quot;</span>]
                                  <span class="nc">~</span>x
                                  [<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;POP_STREAM&quot;</span>]]
  Action        <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x         <span class="nb">-&gt;</span> [[<span class="s">&quot;OpCode&quot;</span> <span class="s">&quot;ACTION&quot;</span>]
                                  [<span class="s">&quot;Action&quot;</span> x]]
  asts          <span class="nb">=</span> ast<span class="nc">*</span><span class="nb">:</span>xs <span class="nc">!.</span>  <span class="nb">-&gt;</span> xs
  ast           <span class="nb">=</span> [<span class="nc">%</span><span class="nb">:</span>x]       <span class="nb">-&gt;</span> x
}
</pre>
</div>
<h3 id="srcassembler.rlmeta">src/assembler.rlmeta</h3>
<div class="highlight">
<pre><span></span>Assembler {
  Grammar  <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x ast<span class="nc">*</span><span class="nb">:</span>ys     <span class="nb">-&gt;</span> list()<span class="nb">:</span>rules
                             <span class="nb">-&gt;</span> list()<span class="nb">:</span>code
                             <span class="nb">-&gt;</span> dict()<span class="nb">:</span>labels
                             <span class="nb">-&gt;</span> list()<span class="nb">:</span>patches
                             <span class="nb">-&gt;</span> ys
                             <span class="nb">-&gt;</span> run(<span class="s">&quot;asts&quot;</span> patches)
                             <span class="nb">-&gt;</span> { <span class="s">&quot;class &quot;</span> x <span class="s">&quot;(Grammar):</span><span class="se">\n</span><span class="s">&quot;</span> &gt;
                                    <span class="s">&quot;rules = {</span><span class="se">\n</span><span class="s">&quot;</span> &gt; join(rules <span class="s">&quot;,</span><span class="se">\n</span><span class="s">&quot;</span>) &lt; <span class="s">&quot;</span><span class="se">\n</span><span class="s">}</span><span class="se">\n</span><span class="s">&quot;</span>
                                    <span class="s">&quot;code = [</span><span class="se">\n</span><span class="s">&quot;</span> &gt; join(code  <span class="s">&quot;,</span><span class="se">\n</span><span class="s">&quot;</span>) &lt; <span class="s">&quot;</span><span class="se">\n</span><span class="s">]</span><span class="se">\n</span><span class="s">&quot;</span>
                                  &lt; }
  Rule     <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> add(rules { repr(x) <span class="s">&quot;: &quot;</span> len(code) })
                             <span class="nb">-&gt;</span> set(labels x len(code))
  Label    <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> set(labels x len(code))
  Target   <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> add(patches [<span class="s">&quot;Patch&quot;</span> len(code) x])
                             <span class="nb">-&gt;</span> add(code <span class="s">&quot;placeholder&quot;</span>)
  Patch    <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x <span class="nc">.</span><span class="nb">:</span>y         <span class="nb">-&gt;</span> set(code x get(labels y))
  OpCode   <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> add(code x)
  Value    <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> add(code repr(x))
  Eq       <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> add(code repr(x))
                             <span class="nb">-&gt;</span> add(code { <span class="s">&quot;lambda x: x == &quot;</span> repr(x) })
  Range    <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x <span class="nc">.</span><span class="nb">:</span>y         <span class="nb">-&gt;</span> add(code repr({<span class="s">&quot;range &quot;</span> repr(x) <span class="s">&quot;-&quot;</span> repr(y)}))
                             <span class="nb">-&gt;</span> add(code { <span class="s">&quot;lambda x: &quot;</span> repr(x) <span class="s">&quot; &lt;= x &lt;= &quot;</span> repr(y) })
  Any      <span class="nb">=</span>                 <span class="nb">-&gt;</span> add(code repr(<span class="s">&quot;any&quot;</span>))
                             <span class="nb">-&gt;</span> add(code <span class="s">&quot;lambda x: True&quot;</span>)
  Action   <span class="nb">=</span> ast<span class="nb">:</span>x           <span class="nb">-&gt;</span> add(code {<span class="s">&quot;lambda self: &quot;</span> x})
  Set      <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x ast<span class="nb">:</span>y ast<span class="nb">:</span>z <span class="nb">-&gt;</span> { <span class="s">&quot;self.bind(&quot;</span> repr(x) <span class="s">&quot;, &quot;</span> y <span class="s">&quot;, lambda: &quot;</span> z <span class="s">&quot;)&quot;</span> }
  String   <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> repr(x)
  List     <span class="nb">=</span> astList<span class="nb">:</span>x       <span class="nb">-&gt;</span> { <span class="s">&quot;concat([&quot;</span> x <span class="s">&quot;])&quot;</span> }
  ListItem <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x ast<span class="nb">:</span>y       <span class="nb">-&gt;</span> { <span class="s">&quot;splice(&quot;</span> repr(x) <span class="s">&quot;, &quot;</span> y <span class="s">&quot;)&quot;</span> }
  Format   <span class="nb">=</span> astList<span class="nb">:</span>x       <span class="nb">-&gt;</span> { <span class="s">&quot;join([&quot;</span> x <span class="s">&quot;])&quot;</span> }
  Indent   <span class="nb">=</span> ast<span class="nb">:</span>x           <span class="nb">-&gt;</span> { <span class="s">&quot;indent(&quot;</span> x <span class="s">&quot;, &quot;</span>
                                  <span class="s">&quot;self.lookup('indentprefix'))&quot;</span> }
  Call     <span class="nb">=</span> ast<span class="nb">:</span>x astList<span class="nb">:</span>y <span class="nb">-&gt;</span> { x <span class="s">&quot;(&quot;</span> y <span class="s">&quot;)&quot;</span> }
  Lookup   <span class="nb">=</span> <span class="nc">.</span><span class="nb">:</span>x             <span class="nb">-&gt;</span> { <span class="s">&quot;self.lookup(&quot;</span> repr(x) <span class="s">&quot;)&quot;</span> }
  asts     <span class="nb">=</span> ast<span class="nc">*</span><span class="nb">:</span>xs <span class="nc">!.</span>      <span class="nb">-&gt;</span> { xs }
  astList  <span class="nb">=</span> ast<span class="nc">*</span><span class="nb">:</span>xs         <span class="nb">-&gt;</span> join(xs <span class="s">&quot;, &quot;</span>)
  ast      <span class="nb">=</span> [<span class="nc">%</span><span class="nb">:</span>x]           <span class="nb">-&gt;</span> x
}
</pre>
</div>
<h3 id="srcsupport.py">src/support.py</h3>
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">VM</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">rules</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rules</span> <span class="o">=</span> <span class="n">rules</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_rule</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">SemanticAction</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">start_rule</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">call_backtrack_stack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_rest</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scope_rest</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latest_fail_message</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">latest_fail_pos</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">()(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">pop_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pc</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">code</span>

<span class="k">def</span> <span class="nf">PUSH_SCOPE</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span><span class="p">)</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">POP_SCOPE</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span>

<span class="k">def</span> <span class="nf">BACKTRACK</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">call_backtrack_stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(),</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream_rest</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span>
    <span class="p">))</span>

<span class="k">def</span> <span class="nf">COMMIT</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">call_backtrack_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">CALL</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">CALL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">CALL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">pc</span><span class="p">):</span>
    <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span><span class="o">+</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">,))</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">vm</span><span class="o">.</span><span class="n">memo</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">FAIL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vm</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream_rest</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">call_backtrack_stack</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">vm</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">pc</span> <span class="o">=</span> <span class="n">pc</span>

<span class="k">def</span> <span class="nf">RETURN</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vm</span><span class="o">.</span><span class="n">call_backtrack_stack</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">vm</span><span class="o">.</span><span class="n">action</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">call_backtrack_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream_rest</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">MATCH</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">object_description</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">()</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">()</span>
    <span class="n">MATCH_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;expected </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">object_description</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">MATCH_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">fn</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">[</span><span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">]):</span>
        <span class="n">FAIL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">SemanticAction</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">[</span><span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">])</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="k">def</span> <span class="nf">MATCH_CALL_RULE</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">MATCH_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">vm</span><span class="o">.</span><span class="n">rules</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;expected rule name&quot;</span><span class="p">,)):</span>
        <span class="n">CALL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">vm</span><span class="o">.</span><span class="n">action</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">LIST_START</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span><span class="p">)</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">def</span> <span class="nf">LIST_APPEND</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">action</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">LIST_END</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">SemanticAction</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span>

<span class="k">def</span> <span class="nf">BIND</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="p">[</span><span class="n">vm</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">()]</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">action</span>

<span class="k">def</span> <span class="nf">ACTION</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">vm</span><span class="o">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">SemanticAction</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">())</span>

<span class="k">def</span> <span class="nf">PUSH_STREAM</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">[</span><span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">FAIL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;expected list&quot;</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">stream_rest</span> <span class="o">=</span> <span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream_rest</span><span class="p">)</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span> <span class="o">+</span> <span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">,)</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">[</span><span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">POP_STREAM</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">):</span>
        <span class="n">FAIL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;expected end of list&quot;</span><span class="p">,))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream_rest</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream_rest</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">FAIL</span><span class="p">(</span><span class="n">vm</span><span class="p">):</span>
    <span class="n">FAIL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">pop_arg</span><span class="p">(),))</span>

<span class="k">def</span> <span class="nf">FAIL_</span><span class="p">(</span><span class="n">vm</span><span class="p">,</span> <span class="n">fail_message</span><span class="p">):</span>
    <span class="n">fail_pos</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span><span class="o">+</span><span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">,)</span>
    <span class="k">if</span> <span class="n">fail_pos</span> <span class="o">&gt;=</span> <span class="n">vm</span><span class="o">.</span><span class="n">latest_fail_pos</span><span class="p">:</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">latest_fail_message</span> <span class="o">=</span> <span class="n">fail_message</span>
        <span class="n">vm</span><span class="o">.</span><span class="n">latest_fail_pos</span> <span class="o">=</span> <span class="n">fail_pos</span>
    <span class="n">call_backtrack_entry</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">vm</span><span class="o">.</span><span class="n">call_backtrack_stack</span><span class="p">:</span>
        <span class="n">call_backtrack_entry</span> <span class="o">=</span> <span class="n">vm</span><span class="o">.</span><span class="n">call_backtrack_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">call_backtrack_entry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vm</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="n">call_backtrack_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">fail_message</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">call_backtrack_entry</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">MatchError</span><span class="p">(</span>
            <span class="n">vm</span><span class="o">.</span><span class="n">latest_fail_message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">vm</span><span class="o">.</span><span class="n">latest_fail_message</span><span class="p">[</span><span class="mi">1</span><span class="p">:]),</span>
            <span class="n">vm</span><span class="o">.</span><span class="n">latest_fail_pos</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">vm</span><span class="o">.</span><span class="n">stream</span>
        <span class="p">)</span>
    <span class="p">(</span><span class="n">vm</span><span class="o">.</span><span class="n">pc</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">stream_rest</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">pos_rest</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span> <span class="n">vm</span><span class="o">.</span><span class="n">scope_rest</span><span class="p">)</span> <span class="o">=</span> <span class="n">call_backtrack_entry</span>

<span class="k">class</span> <span class="nc">SemanticAction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span>

    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runtime</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">runtime</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">continuation</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">continuation</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">runtime</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">MatchError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="ne">Exception</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span>

<span class="k">class</span> <span class="nc">Grammar</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">runtime</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">return</span> <span class="n">Runtime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">Counter</span><span class="p">(),</span>
            <span class="s2">&quot;indentprefix&quot;</span><span class="p">:</span> <span class="s2">&quot;    &quot;</span><span class="p">,</span>
            <span class="s2">&quot;list&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
            <span class="s2">&quot;dict&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="s2">&quot;add&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
            <span class="s2">&quot;get&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">y</span><span class="p">],</span>
            <span class="s2">&quot;set&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="fm">__setitem__</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span>
            <span class="s2">&quot;len&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">,</span>
            <span class="s2">&quot;repr&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">,</span>
            <span class="s2">&quot;join&quot;</span><span class="p">:</span> <span class="n">join</span><span class="p">,</span>
        <span class="p">}))</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Runtime</span><span class="p">(</span><span class="nb">dict</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grammar</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="nb">dict</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span> <span class="o">=</span> <span class="n">grammar</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Runtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="p">}))</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">VM</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">rules</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Counter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">splice</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">item</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">concat</span><span class="p">([</span><span class="n">splice</span><span class="p">(</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">subitem</span><span class="p">)</span> <span class="k">for</span> <span class="n">subitem</span> <span class="ow">in</span> <span class="n">item</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">concat</span><span class="p">(</span><span class="n">lists</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">xs</span> <span class="ow">in</span> <span class="n">lists</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">delimiter</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">indent</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;    &quot;</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="o">+</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">(</span><span class="kc">True</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">compile_chain</span><span class="p">(</span><span class="n">grammars</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">import</span> <span class="nn">pprint</span>
    <span class="k">for</span> <span class="n">grammar</span><span class="p">,</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">grammars</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">grammar</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MatchError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">MARKER</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0;31m&lt;ERROR POSITION&gt;</span><span class="se">\033</span><span class="s2">[0m&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stream</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">stream_string</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">stream</span><span class="p">[:</span><span class="n">e</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span> <span class="o">+</span> <span class="n">MARKER</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">stream</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">pos</span><span class="p">:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stream_string</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">stream</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">POSITION: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">STREAM:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">,</span>
                <span class="n">e</span><span class="o">.</span><span class="n">pos</span><span class="p">,</span>
                <span class="n">indent</span><span class="p">(</span><span class="n">stream_string</span><span class="p">)</span>
            <span class="p">))</span>
    <span class="k">return</span> <span class="n">source</span>
</pre>
</div>
<h3 id="srcmain.py">src/main.py</h3>
<div class="highlight">
<pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="ow">or</span> <span class="p">[</span><span class="s2">&quot;--compile&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]</span>
    <span class="k">while</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;--support&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SUPPORT</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;--copy&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;--embed&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
            <span class="p">))</span>
        <span class="k">elif</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">&quot;--compile&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">compile_chain</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">Parser</span><span class="p">,</span> <span class="s2">&quot;file&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">CodeGenerator</span><span class="p">,</span> <span class="s2">&quot;asts&quot;</span><span class="p">),</span> <span class="p">(</span><span class="n">Assembler</span><span class="p">,</span> <span class="s2">&quot;asts&quot;</span><span class="p">)],</span>
                <span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: Unknown command '</span><span class="si">{}</span><span class="s2">'&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
</pre>
</div>
<h3 id="make.py">make.py</h3>
<div class="highlight">
<pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">make_next_version</span><span class="p">():</span>
    <span class="n">final_compiler</span> <span class="o">=</span> <span class="n">meta_compile_rlmeta</span><span class="p">()</span>
    <span class="n">test</span><span class="p">(</span><span class="n">final_compiler</span><span class="p">)</span>
    <span class="n">mv</span><span class="p">(</span><span class="n">final_compiler</span><span class="p">,</span> <span class="s2">&quot;rlmeta.py&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">meta_compile_rlmeta</span><span class="p">():</span>
    <span class="n">compiler</span> <span class="o">=</span> <span class="s2">&quot;rlmeta.py&quot;</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">next_compiler</span> <span class="o">=</span> <span class="s2">&quot;rlmeta</span><span class="si">{}</span><span class="s2">.py&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">next_content</span> <span class="o">=</span> <span class="n">compile_rlmeta</span><span class="p">(</span><span class="n">compiler</span><span class="p">)</span>
        <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Writing </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">next_compiler</span><span class="p">))</span>
        <span class="n">write</span><span class="p">(</span><span class="n">next_compiler</span><span class="p">,</span> <span class="n">next_content</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">next_content</span> <span class="o">==</span> <span class="n">content</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">next_compiler</span>
        <span class="n">compiler</span> <span class="o">=</span> <span class="n">next_compiler</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">next_content</span>
    <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Unable to produce metacompiler.&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">compile_rlmeta</span><span class="p">(</span><span class="n">rlmeta</span><span class="p">):</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Compiling rlmeta using </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rlmeta</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">run_rlmeta</span><span class="p">(</span><span class="n">rlmeta</span><span class="p">,</span> <span class="p">[</span>
        <span class="s2">&quot;--embed&quot;</span><span class="p">,</span> <span class="s2">&quot;SUPPORT&quot;</span><span class="p">,</span> <span class="s2">&quot;src/support.py&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--support&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--compile&quot;</span><span class="p">,</span> <span class="s2">&quot;src/parser.rlmeta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--compile&quot;</span><span class="p">,</span> <span class="s2">&quot;src/codegenerator.rlmeta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--compile&quot;</span><span class="p">,</span> <span class="s2">&quot;src/assembler.rlmeta&quot;</span><span class="p">,</span>
        <span class="s2">&quot;--copy&quot;</span><span class="p">,</span> <span class="s2">&quot;src/main.py&quot;</span><span class="p">,</span>
    <span class="p">])</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">rlmeta</span><span class="p">):</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Test: Has its own support library&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">run_rlmeta</span><span class="p">(</span><span class="n">rlmeta</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;--support&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">read</span><span class="p">(</span><span class="s2">&quot;src/support.py&quot;</span><span class="p">)</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Test: Disallow semantic action in the middle&quot;</span><span class="p">)</span>
    <span class="n">run_rlmeta</span><span class="p">(</span><span class="n">rlmeta</span><span class="p">,</span> <span class="p">[],</span> <span class="sa">b</span><span class="s2">&quot;Grammar { x = . -&gt; [] . }&quot;</span><span class="p">,</span> <span class="n">expect_failure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Test: Call unknown rule foo&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">test_grammar</span><span class="p">(</span>
        <span class="n">rlmeta</span><span class="p">,</span>
        <span class="sa">b</span><span class="s2">&quot;Grammar { x = % | . }&quot;</span><span class="p">,</span>
        <span class="sa">b</span><span class="s2">&quot;print(compile_chain([(Grammar, 'x')], ['foo']))&quot;</span>
    <span class="p">)</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">&quot;foo</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="k">def</span> <span class="nf">test_grammar</span><span class="p">(</span><span class="n">rlmeta</span><span class="p">,</span> <span class="n">grammar</span><span class="p">,</span> <span class="n">main_code</span><span class="p">):</span>
    <span class="n">compiled</span> <span class="o">=</span> <span class="n">run_rlmeta</span><span class="p">(</span><span class="n">rlmeta</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;--support&quot;</span><span class="p">,</span> <span class="s2">&quot;--compile&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">],</span> <span class="n">grammar</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">compiled</span> <span class="o">+</span> <span class="n">main_code</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">],</span>
        <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="p">)</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stdout</span>

<span class="k">def</span> <span class="nf">run_rlmeta</span><span class="p">(</span><span class="n">rlmeta</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">expect_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">rlmeta</span><span class="p">]</span><span class="o">+</span><span class="n">args</span><span class="p">,</span>
        <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
    <span class="p">)</span>
    <span class="n">stdout</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="n">stdin</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">expect_failure</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Expected failure&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fail</span><span class="p">(</span><span class="s2">&quot;Expected success&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">stdout</span>

<span class="k">def</span> <span class="nf">mv</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">):</span>
    <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Moving </span><span class="si">{}</span><span class="s2"> -&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">cleanup</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;rlmeta1.py&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rlmeta2.py&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rlmeta3.py&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rlmeta4.py&quot;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0;33m</span><span class="si">{}</span><span class="se">\033</span><span class="s2">[0m</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">success</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0;32m</span><span class="si">{}</span><span class="se">\033</span><span class="s2">[0m</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">fail</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[0;31mERROR: </span><span class="si">{}</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">cleanup</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;--compile&quot;</span><span class="p">]:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">compile_rlmeta</span><span class="p">(</span><span class="s2">&quot;rlmeta.py&quot;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">make_next_version</span><span class="p">()</span>
    <span class="n">cleanup</span><span class="p">()</span>
    <span class="n">success</span><span class="p">(</span><span class="s2">&quot;  O-----------------O&quot;</span><span class="p">)</span>
    <span class="n">success</span><span class="p">(</span><span class="s2">&quot;  | RLMeta compiled |&quot;</span><span class="p">)</span>
    <span class="n">success</span><span class="p">(</span><span class="s2">&quot;~~|     itself!     |&quot;</span><span class="p">)</span>
    <span class="n">success</span><span class="p">(</span><span class="s2">&quot;  O-----------------O&quot;</span><span class="p">)</span>
</pre>
</div>

      <hr>
      <center>
      <p class="small">Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>.</p>
      </center>
    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../../static/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>
