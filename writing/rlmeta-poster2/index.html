<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>
      DRAFT: RLMeta Poster 2 | Rickard's personal homepage
    </title>

    <!-- Bootstrap -->
    <link href="../../static/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <meta name="keywords" content="programming, writing" />
    <meta name="description" content="Rickard's personal homepage.">
    <link rel="stylesheet" href="../../static/layout.css" type="text/css">
    <link rel="stylesheet" href="../../static/syntax.css" type="text/css">
    <link rel="alternate" href="../../atom.xml" type="application/atom+xml" title="Atom feed">
    <link rel="alternate" href="../../rss.xml" type="application/rss+xml" title="RSS feed">
  </head>
  <body>

    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../../">rickardlindberg.me</a>
        </div>
        <div id="navbar" class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li><a href="../../">Home</a></li>
            <li><a href="../../writing/">Writing</a></li>
            <li><a href="../../writing/newsletter/">Newsletter</a></li>
            <li><a href="../../projects/">Projects</a></li>
            <li><a href="../../contact/">Contact</a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
      <h1>DRAFT: RLMeta Poster 2</h1>

<p><em>Published on 10 October 2021.</em></p>

<p><strong>This is a work in progress that will change. Like to see it finished? Let me know by sending me an email.</strong></p>
<p>A while ago I created a <a href="../../writing/creating-rlmeta-poster/">poster</a> to showcase RLMeta. To be able to finish the poster, I had to stop polishing RLMeta at some point and put the source on a poster. This was difficult because I felt the need for it to be perfect. Eventually I did stop polishing, but I left a few items unresolved.</p>
<p>Recently, I picked up where I left off. Initially, my plan was to make a second version of the poster. I started to fix the unresolved items and I was making progress. But somehow imperfections kept creeping in. It felt like a never ending game of chasing perfection. That’s when I decided that a second poster would probably not be worth it. But I still liked the new version of RLMeta. What should I do?</p>
<p>I decided to attempt to write a more practical walk through and presentation of the new version of RLMeta. That is the remaining of this blog post. After the walk through there will be also be a section on the most important changes from the previous version and motivation for them.</p>
<p>The walk through will be another way to showcase RLMeta.</p>
<p>Compared to poster version, it could also be more easily improved. Not having to go to print.</p>
<p>Such a walk through might be a good way to structure a README for a project, and it might serve as a start fo.</p>
<h2 id="getting-the-source-code">Getting the source code</h2>
<p>In order to follow along on this walk through, you can download the source code here: <a href="rlmeta-poster-2.zip">rlmeta-poster-2.zip</a>.</p>
<h2 id="structure">Structure</h2>
<pre><code>$ tree --dirsfirst
.
├── src
│   ├── assembler.rlmeta
│   ├── codegenerator.rlmeta
│   ├── main.py
│   ├── parser.rlmeta
│   └── support.py
├── make.py
├── rlmeta.notes
└── rlmeta.py

1 directory, 8 files</code></pre>
<p>Looking at the source code, this is it:</p>
<pre><code>$ wc -l src/*
   39 src/assembler.rlmeta
   57 src/codegenerator.rlmeta
   26 src/main.py
   60 src/parser.rlmeta
  237 src/support.py
  419 total</code></pre>
<h2 id="do-a-meta-compilation">Do a meta-compilation</h2>
<h2 id="follow-transformation-of-a-simple-program">Follow transformation of a simple program</h2>
<h2 id="code">Code</h2>
<div class="highlight">
<pre><span></span>Parser {
  file <span class="nb">=</span>
    <span class="nb">|</span> (space grammar)<span class="nc">*</span><span class="nb">:</span>xs space <span class="nc">!.</span>            <span class="nb">-&gt;</span> xs
  grammar <span class="nb">=</span>
    <span class="nb">|</span> name<span class="nb">:</span>x space <span class="sc">'{'</span> rule<span class="nc">*</span><span class="nb">:</span>ys space <span class="sc">'}'</span>     <span class="nb">-&gt;</span> [<span class="s">&quot;Grammar&quot;</span> x <span class="nc">~</span>ys]
  rule <span class="nb">=</span>
    <span class="nb">|</span> name<span class="nb">:</span>x space <span class="sc">'='</span> choice<span class="nb">:</span>y               <span class="nb">-&gt;</span> [<span class="s">&quot;Rule&quot;</span> x y]
  choice <span class="nb">=</span>
    <span class="nb">|</span> (space <span class="sc">'|'</span>)<span class="nc">?</span>
      sequence<span class="nb">:</span>x (space <span class="sc">'|'</span> sequence)<span class="nc">*</span><span class="nb">:</span>xs     <span class="nb">-&gt;</span> [<span class="s">&quot;Or&quot;</span> x <span class="nc">~</span>xs]
  sequence <span class="nb">=</span>
    <span class="nb">|</span> expr<span class="nc">*</span><span class="nb">:</span>xs maybeAction<span class="nb">:</span>ys                 <span class="nb">-&gt;</span> [<span class="s">&quot;Scope&quot;</span> [<span class="s">&quot;And&quot;</span> <span class="nc">~</span>xs <span class="nc">~</span>ys]]
  expr <span class="nb">=</span>
    <span class="nb">|</span> expr1<span class="nb">:</span>x space <span class="sc">':'</span> name<span class="nb">:</span>y                <span class="nb">-&gt;</span> [<span class="s">&quot;Bind&quot;</span> y x]
    <span class="nb">|</span> expr1
  expr1 <span class="nb">=</span>
    <span class="nb">|</span> expr2<span class="nb">:</span>x space <span class="sc">'*'</span>                       <span class="nb">-&gt;</span> [<span class="s">&quot;Star&quot;</span> x]
    <span class="nb">|</span> expr2<span class="nb">:</span>x space <span class="sc">'?'</span>                       <span class="nb">-&gt;</span> [<span class="s">&quot;Or&quot;</span> x [<span class="s">&quot;And&quot;</span>]]
    <span class="nb">|</span> space <span class="sc">'!'</span> expr2<span class="nb">:</span>x                       <span class="nb">-&gt;</span> [<span class="s">&quot;Not&quot;</span> x]
    <span class="nb">|</span> space <span class="sc">'%'</span>                               <span class="nb">-&gt;</span> [<span class="s">&quot;MatchCallRule&quot;</span>]
    <span class="nb">|</span> expr2
  expr2 <span class="nb">=</span>
    <span class="nb">|</span> name<span class="nb">:</span>x <span class="nc">!</span>(space <span class="sc">'='</span>)                     <span class="nb">-&gt;</span> [<span class="s">&quot;MatchRule&quot;</span> x]
    <span class="nb">|</span> space char<span class="nb">:</span>x <span class="sc">'-'</span> char<span class="nb">:</span>y                 <span class="nb">-&gt;</span> [<span class="s">&quot;MatchObject&quot;</span> [<span class="s">&quot;Range&quot;</span> x y]]
    <span class="nb">|</span> space <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> (<span class="nc">!</span><span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> matchChar)<span class="nc">*</span><span class="nb">:</span>xs <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span>   <span class="nb">-&gt;</span> [<span class="s">&quot;And&quot;</span> <span class="nc">~</span>xs]
    <span class="nb">|</span> space <span class="sc">'.'</span>                               <span class="nb">-&gt;</span> [<span class="s">&quot;MatchObject&quot;</span> [<span class="s">&quot;Any&quot;</span>]]
    <span class="nb">|</span> space <span class="sc">'('</span> choice<span class="nb">:</span>x space <span class="sc">')'</span>            <span class="nb">-&gt;</span> x
    <span class="nb">|</span> space <span class="sc">'['</span> expr<span class="nc">*</span><span class="nb">:</span>xs space <span class="sc">']'</span>            <span class="nb">-&gt;</span> [<span class="s">&quot;MatchList&quot;</span> [<span class="s">&quot;And&quot;</span> <span class="nc">~</span>xs]]
  matchChar <span class="nb">=</span>
    <span class="nb">|</span> innerChar<span class="nb">:</span>x                             <span class="nb">-&gt;</span> [<span class="s">&quot;MatchObject&quot;</span> [<span class="s">&quot;Eq&quot;</span> x]]
  maybeAction <span class="nb">=</span>
    <span class="nb">|</span> actionExpr<span class="nb">:</span>x                            <span class="nb">-&gt;</span> [[<span class="s">&quot;Action&quot;</span> x]]
    <span class="nb">|</span>                                         <span class="nb">-&gt;</span> []
  actionExpr <span class="nb">=</span>
    <span class="nb">|</span> space <span class="sc">'-&gt;'</span> hostExpr<span class="nb">:</span>x
      (space <span class="sc">':'</span> name <span class="nb">|</span> <span class="nb">-&gt;</span> <span class="s">&quot;&quot;</span>)<span class="nb">:</span>y actionExpr<span class="nb">:</span>z <span class="nb">-&gt;</span> [<span class="s">&quot;Set&quot;</span> y x z]
    <span class="nb">|</span> space <span class="sc">'-&gt;'</span> hostExpr<span class="nb">:</span>x                   <span class="nb">-&gt;</span> x
  hostExpr <span class="nb">=</span>
    <span class="nb">|</span> space string<span class="nb">:</span>x                          <span class="nb">-&gt;</span> [<span class="s">&quot;String&quot;</span> x]
    <span class="nb">|</span> space <span class="sc">'['</span> hostListItem<span class="nc">*</span><span class="nb">:</span>xs space <span class="sc">']'</span>    <span class="nb">-&gt;</span> [<span class="s">&quot;List&quot;</span> <span class="nc">~</span>xs]
    <span class="nb">|</span> space <span class="sc">'{'</span> formatExpr<span class="nc">*</span><span class="nb">:</span>xs space <span class="sc">'}'</span>      <span class="nb">-&gt;</span> [<span class="s">&quot;Format&quot;</span> <span class="nc">~</span>xs]
    <span class="nb">|</span> var<span class="nb">:</span>x space <span class="sc">'('</span> hostExpr<span class="nc">*</span><span class="nb">:</span>ys space <span class="sc">')'</span>  <span class="nb">-&gt;</span> [<span class="s">&quot;Call&quot;</span> x <span class="nc">~</span>ys]
    <span class="nb">|</span> var<span class="nb">:</span>x
  hostListItem <span class="nb">=</span>
    <span class="nb">|</span> space <span class="sc">'~'</span><span class="nc">*</span><span class="nb">:</span>ys hostExpr<span class="nb">:</span>x                <span class="nb">-&gt;</span> [<span class="s">&quot;ListItem&quot;</span> len(ys) x]
  formatExpr <span class="nb">=</span>
    <span class="nb">|</span> space <span class="sc">'&gt;'</span> formatExpr<span class="nc">*</span><span class="nb">:</span>xs space <span class="sc">'&lt;'</span>      <span class="nb">-&gt;</span> [<span class="s">&quot;Indent&quot;</span> [<span class="s">&quot;Format&quot;</span> <span class="nc">~</span>xs]]
    <span class="nb">|</span> hostExpr
  var <span class="nb">=</span>
    <span class="nb">|</span> name<span class="nb">:</span>x <span class="nc">!</span>(space <span class="sc">'='</span>)                     <span class="nb">-&gt;</span> [<span class="s">&quot;Lookup&quot;</span> x]
  string    <span class="nb">=</span> <span class="sc">'&quot;'</span>  (<span class="nc">!</span><span class="sc">'&quot;'</span>  innerChar)<span class="nc">*</span><span class="nb">:</span>xs <span class="sc">'&quot;'</span>  <span class="nb">-&gt;</span> { xs }
  char      <span class="nb">=</span> <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span>  <span class="nc">!</span><span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> innerChar  <span class="nb">:</span>x  <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> <span class="nb">-&gt;</span> x
  innerChar <span class="nb">=</span> <span class="sc">'</span><span class="se">\\</span><span class="sc">'</span> escape <span class="nb">|</span> <span class="nc">.</span>
  escape    <span class="nb">=</span> <span class="sc">'</span><span class="se">\\</span><span class="sc">'</span> <span class="nb">-&gt;</span> <span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span> <span class="nb">|</span> <span class="sc">'</span><span class="se">\'</span><span class="sc">'</span> <span class="nb">-&gt;</span> <span class="s">&quot;'&quot;</span>
            <span class="nb">|</span> <span class="sc">'&quot;'</span>  <span class="nb">-&gt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span> <span class="nb">|</span> <span class="sc">'n'</span>  <span class="nb">-&gt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
  name      <span class="nb">=</span> space nameStart<span class="nb">:</span>x nameChar<span class="nc">*</span><span class="nb">:</span>xs  <span class="nb">-&gt;</span> { x xs }
  nameStart <span class="nb">=</span> <span class="sc">'a'</span><span class="nc">-</span><span class="sc">'z'</span> <span class="nb">|</span> <span class="sc">'A'</span><span class="nc">-</span><span class="sc">'Z'</span>
  nameChar  <span class="nb">=</span> <span class="sc">'a'</span><span class="nc">-</span><span class="sc">'z'</span> <span class="nb">|</span> <span class="sc">'A'</span><span class="nc">-</span><span class="sc">'Z'</span> <span class="nb">|</span> <span class="sc">'0'</span><span class="nc">-</span><span class="sc">'9'</span>
  space     <span class="nb">=</span> (<span class="sc">' '</span> <span class="nb">|</span> <span class="sc">'</span><span class="se">\n</span><span class="sc">'</span>)<span class="nc">*</span>
}
</pre>
</div>
<p>–</p>
<p>CHANGES:</p>
<p>It started with this goal:</p>
<pre><code>RLMeta Poster 2: Experiment with PyVM and see if it can improve &quot;assembly
code in code generator&quot;.</code></pre>
<p>Then continued with this:</p>
<ul>
<li><p>Import all current code into smart notes document.</p>
<ul>
<li>Added search of code notes to smart notes.</li>
</ul></li>
<li><p>Adapt to Python 3.</p></li>
<li><p>PyVM (first version)</p>
<ul>
<li><p>Split PyVM into parser and codegenerator.</p></li>
<li><p>Two passes (and thus two grammars) are needed if macros should be possible to define last.</p></li>
<li><p>What is a good AST for PyVM?</p></li>
</ul>
<p>[x] Continue to build parse tree.</p>
<p>[x] Figure out how to replace support library in make.py</p>
<p>$ wc -l rlmeta/<em>; echo; wc -l pyvm/</em> 66 rlmeta/codegenerator.rlmeta 46 rlmeta/main.py 58 rlmeta/parser.rlmeta 77 rlmeta/support.py 169 rlmeta/vm.pyvm 416 total</p>
<pre><code>22 pyvm/codegenerator.rlmeta
19 pyvm/parser.rlmeta
35 pyvm/support.py
76 total</code></pre></li>
</ul>
<p>[x] Better error message than None if runtime/scope is not found.</p>
<pre><code>* Rename match -&gt; matches in Scope
* Immutable scope instead and fail if entry does not exist?

$ wc -l rlmeta/*; echo; wc -l pyvm/*
   66 rlmeta/codegenerator.rlmeta
   46 rlmeta/main.py
   58 rlmeta/parser.rlmeta
   68 rlmeta/support.py
  169 rlmeta/vm.pyvm
  407 total

  22 pyvm/codegenerator.rlmeta
  19 pyvm/parser.rlmeta
  35 pyvm/support.py
  76 total</code></pre>
<p>[x] Generate instruction “enum” so that strings don’t have to be used</p>
<p>[x] Counter class is more clean</p>
<pre><code>$ wc -l rlmeta/*; echo; wc -l pyvm/*
   66 rlmeta/codegenerator.rlmeta
   46 rlmeta/main.py
   58 rlmeta/parser.rlmeta
   72 rlmeta/support.py
  169 rlmeta/vm.pyvm
  411 total

  22 pyvm/codegenerator.rlmeta
  19 pyvm/parser.rlmeta
  35 pyvm/support.py
  76 total</code></pre>
<ul>
<li>No need to wrap parser output in list for codegenerator in RLMeta</li>
</ul>
<p>[x] Put compile + error reporting function in support lib.</p>
<p>[x] No need to wrap parser output in list for codegenerator in PyVM</p>
<p>[x] You can put any crap at end of file, and parsers don’t care. Fix it!</p>
<p>[x] VM should not know about runtime.</p>
<p>[x] Move “assembly” out of support library. Grammar should generate labels/instructions.</p>
<p>[x] No failure if VM-compilation fails? (Swap Instruction arguments.)</p>
<p>[x] Support recursive macros?</p>
<pre><code>* Probably requires function to run grammar against an object.

* Needed to get rid of duplicated call code.</code></pre>
<p>[x] Split code generator into code generator and python assembler. That makes each phase more clear and allows for optimizations.</p>
<p>[x] Better AST for action expressions.</p>
<p>[x] Can “native” calls be removed by adding binding in runtime?</p>
<p>[x] Resolve labels in assembler.</p>
<p>[x] Get rid of PyVM</p>
<pre><code>[x] Compilation was further complicated now when VM has to be generated and
    a combined support library created.

[x] Clean up PyVM grammars

[x] Write VM as clean as possible in Python. Then write a separate
    optimized VM?</code></pre>
<p>[x] Put object match expr tree in parser instead of in codegen?</p>
<pre><code>- This makes the VM more clean. There is only one instruction for matching
  and the matching is done with a Python lambda. The VM knows nothing about
  how to match a single object.</code></pre>
<p>TODO:</p>
<p>[ ] Can support library (and new Runtime) become smaller?</p>
<p>[ ] Should memo be removed since it is an optimization?</p>
<p>[ ] VM</p>
<pre><code>[ ] Review VM and see if clarity can be improved.

    [ ] Can it be written with less optimizations in mind?

[ ] Can fail_pos be handled better?

[ ] MatchError probably has wrong stream if error occurs deep down

[ ] I am not happy with how the new VM looks. A mix between classes and
    functions and helpers.</code></pre>
<p>[ ] Add DEBUG flag that outputs source between passes.</p>
<p>[ ] Why not better error message when action wrong? Why index wrong?</p>
<pre><code>  Action        = .:xs
  Action        = .*:xs

[ ] Wrong pos is reported for &quot;Not&quot; instruction.

-   &quot;Not&quot; messes up latest_fail_pos in general. It should perhaps be
    disabled during a &quot;Not&quot;?</code></pre>
<p>[ ] Poster with intermediate versions shown.</p>
<pre><code>* Interactive on the web. (Requires JS version.)</code></pre>
<p>[ ] Try to port to JS to see how flexible it is?</p>
<p>[ ] Rename ast to tree?</p>
<p>[ ] Lists can be repeated and xs refers to last match?</p>
<pre><code>echo 'G{x=[.:xs]*}' | python rlmeta.py</code></pre>
<p>[ ] Lookup concat/splice/join/indent?</p>

      <hr>
      <center>
      <p class="small">Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>.</p>
      </center>
    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../../static/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>
