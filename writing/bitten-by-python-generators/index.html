<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>
      Bitten by Python generators | Rickard's personal homepage
    </title>

    <meta name="keywords" content="programming, writing" />
    <meta name="description" content="Rickard's personal homepage.">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel="stylesheet" href="../../css/blueprint/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="../../css/blueprint/print.css" type="text/css" media="print">
    <!--[if lt IE 8]>
      <link rel="stylesheet" href="/css/blueprint/ie.css" type="text/css" media="screen, projection">
    <![endif]-->
    <link rel="stylesheet" href="../../css/layout.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="../../css/syntax.css" type="text/css">
  </head>
  <body>
    <div class="container noshowgrid">
      <div class="span-18 prepend-3 append-3">
        <div>
            <center>
            <strong>
            <a href="../../" class="small">rickardlindberg.me</a>
            </strong>
            </center>
        </div>
        <hr>
        <h1>Bitten by Python generators</h1>

<p><em>Published on 11 March 2017.</em></p>

<p>Today I found a bug in a piece of Python code that I had written. The buggy code was the result of not taking into consideration how generators in Python work. It looked like this:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> main():
    <span class="cf">try</span>:
        logging.info(<span class="st">&quot;Processing items&quot;</span>)
        items <span class="op">=</span> get_the_items()
    <span class="cf">except</span>:
        logging.exception(<span class="st">&quot;Could not get items&quot;</span>)
    <span class="cf">else</span>:
        <span class="cf">for</span> item <span class="op">in</span> items:
            process_item(item)</code></pre></div>
<p>Can you spot the error? What could possible go wrong with this code?</p>
<p>When I was debugging it, it was printing the info message, but did not log an exception. Execution continued in the else-clause, but suddenly an exception was raised when looping over the items (outside of <code>process_item</code>). How can that happen? The except-clause should catch all exceptions. And just iterating over a collection should not raise an exception.</p>
<p>The answer is that <code>get_the_items</code> returned a generator. It looked like this:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> get_the_items():
    <span class="cf">for</span> item <span class="op">in</span> read_items_from_disk():
        <span class="cf">if</span> item.is_good():
            <span class="cf">yield</span> item</code></pre></div>
<p>The exception actually came from <code>read_items_from_disk</code>, but since this code creates a generator, it is not executed until the collection is accessed (which happened in the else-clause). So the exception was actually raised when starting looping over items.</p>
<h2 id="what-about-skipping-the-else-caluse">What about skipping the else-caluse?</h2>
<p>To ensure that an exception from the generator is caught, the <code>main</code> function could be written like this:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> main():
    <span class="cf">try</span>:
        logging.info(<span class="st">&quot;Processing items&quot;</span>)
        <span class="cf">for</span> item <span class="op">in</span> get_the_items():
            process_item(item)
    <span class="cf">except</span>:
        logging.exception(<span class="st">&quot;Could not get items&quot;</span>)</code></pre></div>
<p>I don’t like this version because it also catches exceptions from <code>process_item</code>. I like the try-except-else syntax because it allows narrower exception regions in a nice looking way.</p>
<h2 id="why-did-i-use-a-generator">Why did I use a generator?</h2>
<p>I made <code>get_the_items</code> return a generator mainly because I thought it read better. The alternative I came up with looked like this:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> get_the_items():
    items <span class="op">=</span> []
    <span class="cf">for</span> item <span class="op">in</span> read_items_from_disk():
        <span class="cf">if</span> item.is_good():
            items.append(item)
    <span class="cf">return</span> items</code></pre></div>
<p>I didn’t like the temporary <code>items</code> variable. And it is two lines longer than the generator version.</p>
<h2 id="what-about-list-comprehensions">What about list comprehensions?</h2>
<p>Another way to write <code>get_the_items</code>, avoiding the temporary variable, is to use list comprehensions. It would look like this:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="kw">def</span> get_the_items():
    <span class="cf">return</span> [
        item
        <span class="cf">for</span> item <span class="op">in</span> read_items_from_disk()
        <span class="cf">if</span> item.is_good()
    ]</code></pre></div>
<p>I find this code reads as good as the generator version (even though it is two lines longer). This is what I ended up using. But <code>get_the_items</code> was a bit more complicated than in the example, so I had to divide it into two list comprehensions.</p>
<h2 id="what-about-memory-consumption">What about memory consumption?</h2>
<p>One argument for using generators is that they consume less memory. The whole collection of items do not have to fit in memory at once, only the one currently being processed.</p>
<p>In my case I had already read all items into memory in a previous step. The <code>get_the_items</code> function was mainly used to transform and filter the items. So I would not have used much less memory by using generators. Also, my collections were small, so having them in memory was not a problem.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Generators have some nice properties that can be useful. However, after being bitten by them I now think they should only be used if those properties are absolutely needed. I will favor list comprehensions over generators if I can afford to keep the whole collection in memory.</p>

        <hr>

        <div class="span-6">

          <p><strong>Navigation</strong></p>
          <ul>
          <li><a href="../../">Home</a></li>
          <li><a href="../../writing/">Writing</a></li>
          <li><a href="../../contact/">Contact</a></li>
          <li><a href="../../cv-rickard-lindberg.pdf">CV</a></li>
          </ul>

        </div>

        <div class="span-6">

          <p><strong>Me elsewhere</strong></p>
          <ul>
          <li><a href="https://github.com/rickardlindberg">GitHub</a> (<a href="https://gist.github.com/rickardlindberg">my gists</a>)</li>
          <li><a href="http://twitter.com/ricli85">Twitter</a></li>
          </ul>

        </div>

        <div class="span-6 last">

          <p><strong>Projects</strong></p>
          <ul>
          <li><a href="http://thetimelineproj.sourceforge.net">Timeline</a></li>
          </ul>

        </div>
        <hr>
        <p class="small">Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>.</p>
      </div>
    </div>
  </body>
</html>
