<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>
      Search and replace in Vim | Rickard's personal homepage
    </title>

    <meta name="keywords" content="programming, writing" />
    <meta name="description" content="Rickard's personal homepage.">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <link rel="stylesheet" href="../../css/blueprint/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="../../css/blueprint/print.css" type="text/css" media="print">
    <!--[if lt IE 8]>
      <link rel="stylesheet" href="/css/blueprint/ie.css" type="text/css" media="screen, projection">
    <![endif]-->
    <link rel="stylesheet" href="../../css/layout.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="../../css/syntax.css" type="text/css">
  </head>
  <body>
    <div class="container noshowgrid">
      <div class="span-18 prepend-3 append-3">
        <h1>Search and replace in Vim</h1>

<p><em>Published on 21 March 2015.</em></p>

<p><strong>This article is a draft.</strong></p>
<p>In this article I explain how I do search and replace in Vim.</p>
<p>As a programmer, I constantly rename variables, functions, and classes. The easier it is to rename something, the more likely I am to do it. I think renaming is probably one of the most important refactorings.</p>
<p>At the heart of my workflow is the substitute command. I’ll show you how I use it to do renames in a single file and then show you how I have extended it to work across multiple files.</p>
<h2 id="in-a-single-file">In a single file</h2>
<p>The basic substitute pattern I use is the following:</p>
<pre><code>:%s/\&lt;Foo\&gt;/Bar/gc</code></pre>
<ul>
<li><code>%</code> makes the substitute work in the whole file.</li>
<li>The brackets around <code>Foo</code> (<code>\&lt;</code> and <code>\&gt;</code>) ensure that it only matches <code>Foo</code> if it is not part of another word. For example, it matches <code>Foo</code>, but not <code>FooBar</code> or <code>GetFoo</code>. This is almost always what I want. Say I want to rename a function called <code>getCategory</code>, then I want to avoid renaming something called <code>getCategoryId</code>.</li>
<li><code>g</code> makes it replace all occurances on a line.</li>
<li><code>c</code> makes me confirm each substituation. Textual search and replace is not 100% accurate, and therefore I like to manually confirm each substitution.</li>
</ul>
<p>Usually I want to rename the thing that is under the cursor. When I enter the substitute command I can hit <code>&lt;C-r&gt;&lt;C-w&gt;</code> to insert the word that is under the cursor, like this:</p>
<pre><code>:%s/\&lt;&lt;C-r&gt;&lt;C-w&gt;\&gt;/replacement/gc</code></pre>
<p>This type of search and replace I do very often. I have automated the process with Vim script. Let’s start with the mapping:</p>
<pre><code>map ,rw :call SubstituteInFile(expand(&quot;&lt;cword&gt;&quot;))&lt;CR&gt;</code></pre>
<p>The first thing that happens when I hit <code>,rw</code> (rename word) is that <code>expand(&quot;&lt;cword&gt;&quot;)</code> is evaluated. It returns the word that is under the cursor. (In the same way that typing <code>&lt;C-r&gt;&lt;C-w&gt;</code> does.) That word gets passed to <code>SubstituteInFile</code>:</p>
<pre><code>function! SubstituteInFile(text)
    execute GetSubstituteCommand(&quot;%&quot;, a:text)
endfunction</code></pre>
<p>It calls <code>GetSubstituteCommand</code> with the <code>%</code> range and the passed in text. The search command that is returned gets executed. This is the equivalent of typing the following:</p>
<pre><code>:%s/\&lt;Foo\&gt;/Bar/gc</code></pre>
<p>Here is <code>GetSubstituteCommand</code>:</p>
<pre><code>function! GetSubstituteCommand(range, term)
  return a:range . &quot;s&quot; . input(&quot;:s&quot;, &quot;/\\&lt;&quot; . a:term . &quot;\\&gt;/&quot; . a:term . &quot;/gc\&lt;C-f&gt;F/F/l&quot;)
endfunction</code></pre>
<p>The call to <code>input</code> makes it possible for me to edit the substitute command before I proceed. Usually I just need to modify the replacement. The last bit in the input <code>\&lt;C-f&gt;F/F/l</code> drops me into the command-line window and moves the cursor to the first character of the replacement. That way I can quickly edit it. Say I make the following call: <code>GetSubstituteCommand(&quot;%&quot;, &quot;getCategory&quot;)</code>. The command-line window shows the following with the cursor placed over <code>g</code> in the replacement:</p>
<pre><code>/\&lt;getCategory\&gt;/getCategory/gc</code></pre>
<p>Say I type <code>cwfetchCategory&lt;CR&gt;</code> (change word, type <code>fetchCategory</code>, hit enter). The return value is then:</p>
<pre><code>%s/\&lt;getCategory\&gt;/fetchCategory/gc</code></pre>
<p>That’s the basics. Whenever I want to rename something in a file, I do the following:</p>
<ul>
<li>Place the cursor somewhere on the word I want to rename.</li>
<li>Hit <code>,rw</code>.</li>
<li>Edit the replacement and customize the substitute command if needed.</li>
<li>Hit enter.</li>
<li>Hit y/n to confirm each substitution.</li>
</ul>
<h2 id="across-multiple-files">Across multiple files</h2>
<p>The problem with renames is that they are not always local to the file. If I rename a function I also need to use the new name in all files where that function is called.</p>
<p>Vim’s substitute command does not work across files, so I use <a href="http://beyondgrep.com/">ack</a> from within Vim to find all matches. In my <code>.vimrc</code> I have this:</p>
<pre><code>set grepprg=ack</code></pre>
<p>Then I find all matches like this:</p>
<pre><code>:grep -w 'getCategory'</code></pre>
<p>The <code>-w</code> flag is the equivalent of Vim’s <code>\&lt;</code> and <code>\&gt;</code>.</p>
<p>When grep have run, the cursor is placed on the line of the first match. Then I run the following substitute command:</p>
<pre><code>s/\&lt;getCategory\&gt;/fetchCategory/gc</code></pre>
<p>This is the same substitute command as previously, except there is no percent sign here. Here I want the substitute command to work only on the line where ack found a match, not on the whole file.</p>
<p>Then I go to the next match and run the substitute command again and repeat that process until all matches have been processed.</p>
<p>This is of course a lot of manual work that can be automated with Vim script. Let’s start with the mapping:</p>
<pre><code>map ,mrw :call SubstituteInCodebase(expand(&quot;&lt;cword&gt;&quot;))&lt;CR&gt;</code></pre>
<p>When I hit <code>,mrw</code> (multiple rename word), the word under the cursor is passed to <code>SubstituteInCodebase</code>:</p>
<pre><code>function! SubstituteInCodebase(text)
    let grepCommand = GetGrepCommand(a:text)
    let substituteCommand = GetSubstituteCommand(&quot;&quot;, a:text)
    execute grepCommand
    call QuickfixDo(substituteCommand . &quot; | update&quot;)
endfunction</code></pre>
<p>The first thing that happens here is that I build the grep command. It looks like this:</p>
<pre><code>function! GetGrepCommand(term)
  return &quot;grep &quot; . input(&quot;:grep &quot;, &quot;-w '&quot; . a:term . &quot;'\&lt;C-f&gt;F'F'l&quot;)
endfunction</code></pre>
<p>Similar to <code>GetSubstituteCommand</code> it drops me into command-line window so that I can customize the search. Typical customizations that I do:</p>
<ul>
<li>Add <code>--python</code> or equivalent to only search in Python files.</li>
<li>Add a directory to only do the substitution in certain directories.</li>
</ul>
<p>After the grep command is created, the search command is created in the same way as before. But notice the lack of the <code>%</code> range. After both commands have been created, the grep command is executed. This is the equivalent of typing the following:</p>
<pre><code>:grep -w 'getCategory'</code></pre>
<p>Now the quickfix lis is populated with the search results and I can step through it and do the substitution on each matched line. That is what <code>QuickfixDo</code> is for: It will run an arbitrary command on each line in the quickfix list. In this case I pass the search command plus the update command. That ensures that I save the file if the substitution did any changes before I move on to the next match. <code>QuickfixDo</code> looks like this:</p>
<pre><code>function! QuickfixDo(command)
    let itemCount = len(getqflist())
    let itemNr = 1
    while itemNr &lt;= itemCount
        exe &quot;cc &quot; . itemNr
        exe a:command
        let itemNr = itemNr + 1
    endwhile
endfunction</code></pre>
<p>That’s it. Whenever I want to rename something across files, I do the following:</p>
<ul>
<li>Place the cursor somewhere on the word I want to rename.</li>
<li>Hit <code>,mrw</code>.</li>
<li>Customize the grep command if needed.</li>
<li>Hit enter.</li>
<li>Edit the replacement and customize the substitute command if needed.</li>
<li>Hit enter.</li>
<li>Hit y/n to confirm each substitution.</li>
</ul>
<h2 id="resouces">Resouces</h2>
<p>The latest version of my search and replace configuration can be found at <a href="https://github.com/rickardlindberg/dotfiles/blob/master/.vim/vimrc_search_replace.vim">vimrc_search_replace.vim</a>.</p>
<p>Other articles on the subject of search and replace in Vim that I found interesting:</p>
<ul>
<li><p><a href="http://vimcasts.org/episodes/project-wide-find-and-replace/">Vimcasts - Project-wide find and replace</a></p></li>
<li><p><a href="http://www.ibrahim-ahmed.com/2008/01/find-and-replace-in-multiple-files-in.html">Ibrahim Ahmed - Vim: Find and replace text across files</a></p></li>
<li><p><a href="http://www.thegeekstuff.com/2009/04/vi-vim-editor-search-and-replace-examples/">The Geek Stuff - Vi and Vim Editor: 12 Powerful Find and Replace Examples</a></p></li>
</ul>

        <hr>
        <p><a href="../../">Home</a></p>
        <hr>
        <p>Site proudly generated by <a href="http://jaspervdj.be/hakyll">Hakyll</a>.</p>
      </div>
    </div>
  </body>
</html>
