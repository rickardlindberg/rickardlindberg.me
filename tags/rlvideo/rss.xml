<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:dc="http://purl.org/dc/elements/1.1/">
    <channel>
        <title>Rickard's personal homepage: latest posts tagged rlvideo</title>
        <link>http://rickardlindberg.me</link>
        <description><![CDATA[Rickard's personal homepage: latest posts tagged rlvideo]]></description>
        <atom:link href="http://rickardlindberg.me/tags/rlvideo/rss.xml" rel="self"
                   type="application/rss+xml" />
        <lastBuildDate>Sat, 29 Jul 2023 00:00:00 UT</lastBuildDate>
        <item>
    <title>DevLog 003: Clarify GUI separation</title>
    <link>http://rickardlindberg.me/writing/devlog-003-clarify-gui-separation/</link>
    <description><![CDATA[<h1>DevLog 003: Clarify GUI separation</h1>

<p><em>Published on 29 July 2023.</em></p>

<p>In the <a href="/projects/rlvideo/index.html">video editor</a>, there is the idea that we want to isolate the GTK code and have as few classes as possible depend on it. However, this idea is not clearly expressed in the code. So new readers of the code base will not necessarily understand that this separation is intentional and something that we want to do.</p>
<p>In this episode I want to refactor the code to make that more clear.</p>
<h2 id="current-state">Current state</h2>
<p>The current layout of the Python files looks like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>.
├── rlvideolib
│   ├── asciicanvas.py
│   ├── debug.py
│   ├── domain
│   │   ├── cut.py
│   │   ├── __init__.py
│   │   ├── project.py
│   │   ├── region.py
│   │   ├── section.py
│   │   └── source.py
│   ├── events.py
│   ├── graphics
│   │   ├── __init__.py
│   │   └── rectangle.py
│   ├── __init__.py
│   ├── jobs.py
│   └── testing.py
└── rlvideo.py
</pre>
</div>
</div>
</div>
<p>There is the “main” file <code>rlvideo.py</code> and the <code>rlvideolib</code> package.</p>
<p>The main file is sort of the default place where new things go that don’t fit anywhere else. It currently has a mix of classes with different areas of responsibility:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">FakeGui</span><span class="p">:</span>
<span class="k">class</span> <span class="nc">GtkGui</span><span class="p">:</span>
<span class="k">class</span> <span class="nc">MenuItem</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;MenuItem&quot;</span><span class="p">,</span> <span class="s2">&quot;label,action&quot;</span><span class="p">)):</span>
<span class="k">class</span> <span class="nc">App</span><span class="p">:</span>
<span class="k">class</span> <span class="nc">MltPlayer</span><span class="p">:</span>
<span class="k">class</span> <span class="nc">Timeline</span><span class="p">:</span>
<span class="k">class</span> <span class="nc">Scrollbar</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Scrollbar&quot;</span><span class="p">,</span> <span class="s2">&quot;content_length,one_length_in_pixels,ui_size,content_desired_start&quot;</span><span class="p">)):</span>
</pre>
</div>
</div>
</div>
<p>Some of these classes deal with GTK. Others with GUI code that does not depend on GTK directly.</p>
<p>I would like to create a new <code>rlvideolib.gui</code> package that has three modules:</p>
<ul>
<li>gtk</li>
<li>generic</li>
<li>testing</li>
</ul>
<h2 id="testing">Testing</h2>
<p>I extract a new testing module like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ mkdir rlvideolib/gui
$ touch rlvideolib/gui/__init__.py
$ touch rlvideolib/gui/testing.py
</pre>
</div>
</div>
</div>
<p>Then I move the <code>FakeGui</code> class to that module and also rename it to <code>TestGui</code> as I think that is a more descriptive name. I also make sure to import it from <code>rlvideo.py</code>.</p>
<p>Let’s commit:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;Extract rlvideolib.gui.testing.&#39;</span>
................................................
----------------------------------------------------------------------
Ran <span class="m">48</span> tests <span class="k">in</span> <span class="m">1</span>.931s

OK
<span class="o">[</span>main 91b63c2<span class="o">]</span> Extract rlvideolib.gui.testing.
 <span class="m">4</span> files changed, <span class="m">14</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">12</span> deletions<span class="o">(</span>-<span class="o">)</span>
 create mode <span class="m">100644</span> rlvideolib/gui/__init__.py
 create mode <span class="m">100644</span> rlvideolib/gui/testing.py
</pre>
</div>
</div>
</div>
<h2 id="generic">Generic</h2>
<p>Let’s do the same thing for generic GUI code:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ touch rlvideolib/gui/generic.py
</pre>
</div>
</div>
</div>
<p>I move over the following classes:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">Timeline</span><span class="p">:</span>
<span class="k">class</span> <span class="nc">Scrollbar</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Scrollbar&quot;</span><span class="p">,</span> <span class="s2">&quot;content_length,one_length_in_pixels,ui_size,content_desired_start&quot;</span><span class="p">)):</span>
<span class="k">class</span> <span class="nc">MenuItem</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;MenuItem&quot;</span><span class="p">,</span> <span class="s2">&quot;label,action&quot;</span><span class="p">)):</span>
</pre>
</div>
</div>
</div>
<p>If we look at the imports for the generic GUI module, we see this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>

<span class="kn">import</span> <span class="nn">cairo</span>
<span class="kn">import</span> <span class="nn">mlt</span>

<span class="kn">from</span> <span class="nn">rlvideolib.debug</span> <span class="kn">import</span> <span class="n">timeit</span>
<span class="kn">from</span> <span class="nn">rlvideolib.domain.project</span> <span class="kn">import</span> <span class="n">Project</span>
<span class="kn">from</span> <span class="nn">rlvideolib.graphics.rectangle</span> <span class="kn">import</span> <span class="n">RectangleMap</span>
<span class="kn">from</span> <span class="nn">rlvideolib.graphics.rectangle</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">rlvideolib.events</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">rlvideolib.domain.region</span> <span class="kn">import</span> <span class="n">Region</span>
<span class="kn">from</span> <span class="nn">rlvideolib.gui.testing</span> <span class="kn">import</span> <span class="n">TestGui</span>
<span class="kn">from</span> <span class="nn">rlvideolib.domain.cut</span> <span class="kn">import</span> <span class="n">Cut</span>
</pre>
</div>
</div>
</div>
<p>We can see that it depends on Cairo. That is ok. The drawing of generic GUI components is done with Cairo. I don’t see as big a reason to abstract that compared to GTK. Cairo can also most likely be used with other GUI frameworks. The important thing here is that there is no import of GTK.</p>
<p>Let’s commit this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;Extract timelinelib.gui.generic.&#39;</span>
................................................
----------------------------------------------------------------------
Ran <span class="m">48</span> tests <span class="k">in</span> <span class="m">1</span>.937s

OK
<span class="o">[</span>main e392173<span class="o">]</span> Extract timelinelib.gui.generic.
 <span class="m">3</span> files changed, <span class="m">220</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">819</span> deletions<span class="o">(</span>-<span class="o">)</span>
 rewrite rlvideo.py <span class="o">(</span><span class="m">64</span>%<span class="o">)</span>
 copy rlvideo.py <span class="o">=</span>&gt; rlvideolib/gui/generic.py <span class="o">(</span><span class="m">65</span>%<span class="o">)</span>
</pre>
</div>
</div>
</div>
<p>We should probably also run the application to see that I didn’t mess up anything major. I get this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>Traceback (most recent call last):
  File &quot;/home/rick/rlvideo/rlvideo.py&quot;, line 213, in &lt;module&gt;
    App().run()
  File &quot;/home/rick/rlvideo/rlvideo.py&quot;, line 156, in run
    self.timeline = Timeline(project=self.project, player=mlt_player)
NameError: name &#39;Timeline&#39; is not defined
</pre>
</div>
</div>
</div>
<p>Woopsie.</p>
<p>I add the missing import to <code>rlvideo.py</code>:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">rlvideolib.gui.generic</span> <span class="kn">import</span> <span class="n">Timeline</span>
</pre>
</div>
</div>
</div>
<p>If we want to catch this error in the test suite, we must run the whole application which incudes starting the GTK main loop.</p>
<p>I’m thinking that we can separate the construction of the GUI from the actual main loop, something like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">App</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
        <span class="n">Gtk</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>

    <span class="o">...</span>
</pre>
</div>
</div>
</div>
<p>And then we can run <code>App().init()</code> in a test to make sure that construction of the GUI works.</p>
<p>I try this, but run into all kinds of issues.</p>
<p>I decide to leave this as is for now.</p>
<h2 id="gui">GUI</h2>
<p>All classes that are left in <code>rlvideo.py</code> are now related to GTK. Let’s move them to its own module, leaving only this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="kn">from</span> <span class="nn">rlvideolib.gui.gtk</span> <span class="kn">import</span> <span class="n">App</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">App</span><span class="p">()</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre>
</div>
</div>
</div>
<p>Let’s commit:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m &#39;Extract timelinelib.gui.gtk.&#39;
................................................
----------------------------------------------------------------------
Ran 48 tests in 1.941s

OK
[main c4702cc] Extract timelinelib.gui.gtk.
 3 files changed, 5 insertions(+), 217 deletions(-)
 rewrite rlvideo.py (99%)
 copy rlvideo.py =&gt; rlvideolib/gui/gtk.py (99%)
</pre>
</div>
</div>
</div>
<h2 id="summary">Summary</h2>
<p>The new structure looks like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="n">rlvideolib</span><span class="o">/</span><span class="n">gui</span><span class="o">/</span><span class="n">testing</span><span class="o">.</span><span class="n">py</span>
<span class="mi">1</span><span class="p">:</span><span class="k">class</span> <span class="nc">TestGui</span><span class="p">:</span>

<span class="n">rlvideolib</span><span class="o">/</span><span class="n">gui</span><span class="o">/</span><span class="n">generic</span><span class="o">.</span><span class="n">py</span>
<span class="mi">17</span><span class="p">:</span><span class="k">class</span> <span class="nc">Timeline</span><span class="p">:</span>
<span class="mi">312</span><span class="p">:</span><span class="k">class</span> <span class="nc">Scrollbar</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Scrollbar&quot;</span><span class="p">,</span> <span class="s2">&quot;content_length,one_length_in_pixels,ui_size,content_desired_start&quot;</span><span class="p">)):</span>
<span class="mi">400</span><span class="p">:</span><span class="k">class</span> <span class="nc">MenuItem</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;MenuItem&quot;</span><span class="p">,</span> <span class="s2">&quot;label,action&quot;</span><span class="p">)):</span>

<span class="n">rlvideolib</span><span class="o">/</span><span class="n">gui</span><span class="o">/</span><span class="n">gtk</span><span class="o">.</span><span class="n">py</span>
<span class="mi">16</span><span class="p">:</span><span class="k">class</span> <span class="nc">GtkGui</span><span class="p">:</span>
<span class="mi">41</span><span class="p">:</span><span class="k">class</span> <span class="nc">App</span><span class="p">:</span>
<span class="mi">163</span><span class="p">:</span><span class="k">class</span> <span class="nc">MltPlayer</span><span class="p">:</span>
</pre>
</div>
</div>
</div>
<p>I think this structure tells the reader that there is a clear separation between GTK related GUI code and generic GUI code and that this separation is intentional.</p>
<p>The <code>MltPlayer</code> that we see in the GTK module has only very little to do with GTK. Most of it just works with an MLT producer. GTK is needed for the embedding of the video display from the MLT consumer inside a GTK window.</p>
<p>I think part of <code>MltPlayer</code> should probably be extracted to a new class and be put in the generic GUI module or somewhere else. This refactoring to separate the different GUI modules revealed that to me. I find that is often the case. You make one refactoring to clarify something and you discover something else that is unclear.</p>
]]></description>
    <pubDate>Sat, 29 Jul 2023 00:00:00 UT</pubDate>
    <guid>http://rickardlindberg.me/writing/devlog-003-clarify-gui-separation/</guid>
    <dc:creator>Rickard Lindberg</dc:creator>
</item>
<item>
    <title>DevLog 002: Change mix strategy for cuts in GUI</title>
    <link>http://rickardlindberg.me/writing/devlog-002-selecting-cut-type-in-gui/</link>
    <description><![CDATA[<h1>DevLog 002: Change mix strategy for cuts in GUI</h1>

<p><em>Published on 29 July 2023.</em></p>

<p>In the <a href="/writing/devlog-001-jcut-lcut/index.html">previous devlog</a> we worked on adding the concept of a cut type to a clip in the <a href="/projects/rlvideo/index.html">video editor</a>. That is, how should two overlapping clips be mixed together? Which one should be on top? Should it be a <a href="https://en.wikipedia.org/wiki/J_cut">J-cut</a>?</p>
<p>I’ve since added support for two types of cuts: over and under. So we can (programmatically) set this property on clips and they will render in the correct order.</p>
<p>The default cut is under so that later clips will be mixed under the previous clips:</p>
<p>
<center>
<img src="under.png" title="fig:" alt="Default under cut." />
</center>
</p>
<p>There is not yet a way to change this default from the GUI, so that’s what we will work on in this episode.</p>
<h2 id="aside-clips-and-cuts">Aside: clips and cuts</h2>
<p>When writing about this and when looking at the source code, I’m a bit confused by the terminology. I write about clips och cuts, but in the source code there is no concept of a clip, only a cut and a source.</p>
<p>A source represents a file on disk or some generator of frames. A cut represents a region of a source.</p>
<p>A cut has a property called <code>cut</code> which is how to mix this cut with the previous cut on the timeline. That confuses things further.</p>
<p>Let’s rename it to <code>mix_strategy</code> to lessen the confusion.</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;Rename Cut.cut to Cut.mix_strategy.&#39;</span>
...............................................
----------------------------------------------------------------------
Ran <span class="m">47</span> tests <span class="k">in</span> <span class="m">1</span>.918s

OK
<span class="o">[</span>main 425909a<span class="o">]</span> Rename Cut.cut to Cut.mix_strategy.
 <span class="m">1</span> file changed, <span class="m">11</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">11</span> deletions<span class="o">(</span>-<span class="o">)</span>
</pre>
</div>
</div>
</div>
<p>That’s better.</p>
<h2 id="two-possible-ways">Two possible ways</h2>
<p>I can think of two possible ways to set the mix strategy for a cut in the GUI. Either we can right click on a cut and have a context menu pop up where we can select the mix strategy. Or we can select a clip and have a “set mix strategy” operation applied to the selected clip.</p>
<p>Currently, there is no concept of a selected clip. You can’t select anything. But there is a concept of clicking and dragging a clip. Therefore I think a context menu is easier to get started with.</p>
<h2 id="reviewing-mouse-click-code">Reviewing mouse click code</h2>
<p>Let’s look at how click and drag is handled today.</p>
<p>I see this GTK event is connected:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="n">timeline</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;button-press-event&quot;</span><span class="p">,</span> <span class="n">timeline_button</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
<p>And <code>timeline_button</code> is defined like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">timeline_button</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">mouse_down</span><span class="p">(</span><span class="o">*</span><span class="n">timeline</span><span class="o">.</span><span class="n">translate_coordinates</span><span class="p">(</span>
        <span class="n">main_window</span><span class="p">,</span>
        <span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
        <span class="n">event</span><span class="o">.</span><span class="n">y</span>
    <span class="p">))</span>
</pre>
</div>
</div>
</div>
<p>This code does not seem to distinguish between left and right mouse button click. Interesting.</p>
<p>Does that mean that we can move a cut on the timeline by clicking and dragging with the right mouse button? I try it in the application. And it indeed works. That was really not my intention. Let’s see if we can fix that.</p>
<p>I add a debug print to see what properties of the event might indicate the button:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">timeline_button</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">dir</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
    <span class="o">...</span>
</pre>
</div>
</div>
</div>
<p>I find this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>[..., &#39;button&#39;, ..., &#39;get_button&#39;, ...]
</pre>
</div>
</div>
</div>
<p>Let’s try this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">timeline_button</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
<p>When I press the left button, it prints 1, and when I press the right button, it prints 3. There must be some constants for these. I search the GTK documentation and find <a href="https://docs.gtk.org/gdk3/struct.EventButton.html">this</a>:</p>
<blockquote>
<p>The button which was pressed or released, numbered from 1 to 5. Normally button 1 is the left mouse button, 2 is the middle button, and 3 is the right button.</p>
</blockquote>
<p>Maybe there are no constants?</p>
<p>Let’s codify our new knowledge like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">timeline_button</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">left_mouse_down</span><span class="p">(</span><span class="o">*</span><span class="n">timeline</span><span class="o">.</span><span class="n">translate_coordinates</span><span class="p">(</span>
            <span class="n">main_window</span><span class="p">,</span>
            <span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">event</span><span class="o">.</span><span class="n">y</span>
        <span class="p">))</span>
    <span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">right_mouse_down</span><span class="p">(</span><span class="o">*</span><span class="n">timeline</span><span class="o">.</span><span class="n">translate_coordinates</span><span class="p">(</span>
            <span class="n">main_window</span><span class="p">,</span>
            <span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="n">event</span><span class="o">.</span><span class="n">y</span>
        <span class="p">))</span>
</pre>
</div>
</div>
</div>
<p>We rename the previous <code>mouse_down</code> to <code>left_mouse_down</code> and add a new empty method for <code>right_mouse_down</code>.</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;Timeline receives both left and right mouse down events.&#39;</span>
...............................................
----------------------------------------------------------------------
Ran <span class="m">47</span> tests <span class="k">in</span> <span class="m">1</span>.923s

OK
<span class="o">[</span>main 0fc6fb1<span class="o">]</span> Timeline receives both left and right mouse down events.
 <span class="m">1</span> file changed, <span class="m">17</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">7</span> deletions<span class="o">(</span>-<span class="o">)</span>
</pre>
</div>
</div>
</div>
<h2 id="review">Review</h2>
<p>It’s a little unnclear to me what the translation of coordinates are doing. I think the coordinates received in the event are relative to the whole GTK window and the timeline expects coordinates relative to itself.</p>
<p>I don’t really want to focus on this now, but I add a TODO in the code that I should clarify this.</p>
<p>In this project I’ve tried to keep my “backlog” in the source code in the form of TODO comments. Some I will probably never get back to, and others will serve as a reminder. But so far I kind of like this approach.</p>
<h2 id="separation-of-timeline-and-gtk">Separation of timeline and GTK</h2>
<p>The timeline component is unaware of GTK. So when it receives the right mouse down event, it can find the cut that we clicked on, but it doesn’t have the ability to show a context menu, because it needs to use GTK for that.</p>
<p>This separation is intentional. I’ve tried to isolate GTK code to the outermost layer to keep the inner layers free from those details and make them easier to test.</p>
<p>But this presents a problem now.</p>
<p>The only solution that comes to mind if we want to maintain this separation is to create some kind of abstraction. Something like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">GtkGuiAbstraction</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">show_context_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">generic_menu_description</span><span class="p">):</span>
        <span class="c1"># Create GTK context menu from generic_menu_description</span>
</pre>
</div>
</div>
</div>
<p>And then pass that to the timeline so that it can do something like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">right_mouse_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gui</span><span class="o">.</span><span class="n">show_context_menu</span><span class="p">([</span>
        <span class="n">MenuItem</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;over&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="o">...</span><span class="p">),</span>
        <span class="n">MenuItem</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;under&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="o">...</span><span class="p">),</span>
    <span class="p">])</span>
</pre>
</div>
</div>
</div>
<p>I’m not sure what I think about this. On the one hand it feels like a complex extra layer. On the other hand I really want to isolate GTK code. My experience tells me that GUI code can easily leak in to every part of the application and it just makes everything more messy.</p>
<p>I will try to create the simplest possible solution of this design and see what it feels like.</p>
<h2 id="gtk-gui-abstraction">GTK GUI abstraction</h2>
<p>Let’s start with a test:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">GtkGui</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">show_context_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">menu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &gt;&gt;&gt; GtkGui().show_context_menu([</span>
<span class="sd">        ...     MenuItem(label=&quot;over&quot;, action=lambda: print(&quot;over&quot;)),</span>
<span class="sd">        ...     MenuItem(label=&quot;under&quot;, action=lambda: print(&quot;under&quot;)),</span>
<span class="sd">        ... ])</span>
<span class="sd">        &quot;&quot;&quot;</span>
</pre>
</div>
</div>
</div>
<p>This fails with</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>NameError: name &#39;MenuItem&#39; is not defined
</pre>
</div>
</div>
</div>
<p>I define <code>MenuItem</code> and we are green:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">MenuItem</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;MenuItem&quot;</span><span class="p">,</span> <span class="s2">&quot;label,action&quot;</span><span class="p">)):</span>
    <span class="k">pass</span>
</pre>
</div>
</div>
</div>
<p>Let’s commit:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;The start of GtkGui and its show_context_menu method.&#39;</span>
................................................
----------------------------------------------------------------------
Ran <span class="m">48</span> tests <span class="k">in</span> <span class="m">1</span>.923s

OK
<span class="o">[</span>main e64b93e<span class="o">]</span> The start of GtkGui and its show_context_menu method.
 <span class="m">1</span> file changed, <span class="m">13</span> insertions<span class="o">(</span>+<span class="o">)</span>
</pre>
</div>
</div>
</div>
<p>The test so far does not assert anything. It just checks that the code does not crash. But that is enough to experiment with the GTK API. Let’s try to create the menu and the test will tell is if we use the GKT API wrong.</p>
<p>I try this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="n">menu</span> <span class="o">=</span> <span class="n">gtk</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
</pre>
</div>
</div>
</div>
<p>Test immediately fails:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>NameError: name &#39;gtk&#39; is not defined
</pre>
</div>
</div>
</div>
<p>Ah, it should be <code>Gtk</code> I see in the imports at the top of the file. Thank you test.</p>
<p>I search the web for examples how to show a context menu in GTK. After a bit of reading and trying, I end up with this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">show_context_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">menu</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; event = namedtuple(&quot;FakeEvent&quot;, &quot;button,time&quot;)(3, 0)</span>
<span class="sd">    &gt;&gt;&gt; GtkGui(event).show_context_menu([</span>
<span class="sd">    ...     MenuItem(label=&quot;over&quot;, action=lambda: print(&quot;over&quot;)),</span>
<span class="sd">    ...     MenuItem(label=&quot;under&quot;, action=lambda: print(&quot;under&quot;)),</span>
<span class="sd">    ... ])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">create_gtk_handler</span><span class="p">(</span><span class="n">menu_item</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">widget</span><span class="p">):</span>
            <span class="n">menu_item</span><span class="o">.</span><span class="n">action</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">handler</span>
    <span class="n">gtk_menu</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">Menu</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">menu_item</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">:</span>
        <span class="n">gtk_menu_item</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">MenuItem</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">menu_item</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
        <span class="n">gtk_menu_item</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;activate&quot;</span><span class="p">,</span> <span class="n">create_gtk_handler</span><span class="p">(</span><span class="n">menu_item</span><span class="p">))</span>
        <span class="n">gtk_menu_item</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="n">gtk_menu</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gtk_menu_item</span><span class="p">)</span>
    <span class="n">gtk_menu</span><span class="o">.</span><span class="n">popup</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">button</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
<p>The <code>Gtk.Menu</code> seems to need an event to show itself according to examples. So I pass that along to <code>GtkGui</code> and use a fake one in the test. The event handler looks like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">right_mouse_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">gui</span><span class="p">):</span>
    <span class="n">gui</span><span class="o">.</span><span class="n">show_context_menu</span><span class="p">([</span>
        <span class="n">MenuItem</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;over&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;over&quot;</span><span class="p">)),</span>
        <span class="n">MenuItem</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;under&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;under&quot;</span><span class="p">)),</span>
    <span class="p">])</span>
</pre>
</div>
</div>
</div>
<p>I decide to pass the <code>gui</code> along in the method call. That way, it can more easily be constructed with the right click event in the outer layer:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">elif</span> <span class="n">event</span><span class="o">.</span><span class="n">button</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">timeline</span><span class="o">.</span><span class="n">right_mouse_down</span><span class="p">(</span><span class="o">*</span><span class="n">timeline</span><span class="o">.</span><span class="n">translate_coordinates</span><span class="p">(</span>
        <span class="n">main_window</span><span class="p">,</span>
        <span class="n">event</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
        <span class="n">event</span><span class="o">.</span><span class="n">y</span>
    <span class="p">),</span> <span class="n">GtkGui</span><span class="p">(</span><span class="n">event</span><span class="p">))</span>
</pre>
</div>
</div>
</div>
<p>This works fine and when I click the menu items, the corresponding text is shown in the console:</p>
<p>
<center>
<img src="popup.png" title="fig:" alt="Context menu popup." />
</center>
</p>
<p>Let’s commit:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;Show a context menu when right clicking in timeline.&#39;</span>
................................................
----------------------------------------------------------------------
Ran <span class="m">48</span> tests <span class="k">in</span> <span class="m">1</span>.954s

OK
<span class="o">[</span>main <span class="m">4201621</span><span class="o">]</span> Show a context menu when right clicking <span class="k">in</span> timeline.
 <span class="m">1</span> file changed, <span class="m">22</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">4</span> deletions<span class="o">(</span>-<span class="o">)</span>
</pre>
</div>
</div>
</div>
<h2 id="modify-cut">Modify cut</h2>
<p>I continue to modify <code>right_mouse_down</code> to this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">right_mouse_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">gui</span><span class="p">):</span>
    <span class="n">cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cut</span><span class="p">,</span> <span class="n">Cut</span><span class="p">):</span>
        <span class="n">gui</span><span class="o">.</span><span class="n">show_context_menu</span><span class="p">([</span>
            <span class="n">MenuItem</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;over&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;over&quot;</span><span class="p">)),</span>
            <span class="n">MenuItem</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;under&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;under&quot;</span><span class="p">)),</span>
        <span class="p">])</span>
</pre>
</div>
</div>
</div>
<p>I want to show the context menu only if we right click on a cut. We can use the rectangle map for that.</p>
<p>All tests pass, but when I try this in the application, it fails with this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>NameError: name &#39;Cut&#39; is not defined
</pre>
</div>
</div>
</div>
<p>I should have started with a test. Let’s move a little slower.</p>
<p>I add this line in a larger timeline test where we have some objects setup:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&gt;&gt;&gt; timeline.right_mouse_down(5, 25, FakeGui(click_context_menu=&quot;over&quot;))</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre>
</div>
</div>
</div>
<p>And here comes one benefit of the GUI abstraction: easier testing. In the test we can pass a <code>FakeGui</code> that will simulate that we click a context menu item. We implement it like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">FakeGui</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">click_context_menu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">click_context_menu</span> <span class="o">=</span> <span class="n">click_context_menu</span>

    <span class="k">def</span> <span class="nf">show_context_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">menu</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">menu_item</span> <span class="ow">in</span> <span class="n">menu</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">menu</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">click_context_menu</span><span class="p">:</span>
                <span class="n">menu</span><span class="o">.</span><span class="n">action</span><span class="p">()</span>
                <span class="k">return</span>
</pre>
</div>
</div>
</div>
<p>Now we get the same error about <code>Cut</code> not being defined. But this time, we get it when running the test suite. Success!</p>
<p>I import <code>Cut</code> and get an error that ‘list’ object has no attribute ‘label’. Ah. I made a mistake in the fake GUI. <code>label</code> and <code>action</code> should be accessed on the item, not the menu.</p>
<p>The current context menu just prints its label, so to make the test pass, let’s assert on that:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&gt;&gt;&gt; timeline.right_mouse_down(5, 25, FakeGui(click_context_menu=&quot;over&quot;))</span>
<span class="sd">over</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre>
</div>
</div>
</div>
<p>And we are back to green. Let’s commit:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;Test right clicking a cut.&#39;</span>
................................................
----------------------------------------------------------------------
Ran <span class="m">48</span> tests <span class="k">in</span> <span class="m">1</span>.957s

OK
<span class="o">[</span>main 7bf3e14<span class="o">]</span> Test right clicking a cut.
 <span class="m">1</span> file changed, <span class="m">33</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">7</span> deletions<span class="o">(</span>-<span class="o">)</span>
</pre>
</div>
</div>
</div>
<p>But we don’t want to print the menu item label. We want to change the <code>mix_strategy</code> of the clicked cut. Let’s assert on that instead:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&gt;&gt;&gt; timeline.right_mouse_down(5, 25, FakeGui(click_context_menu=&quot;over&quot;))</span>
<span class="sd">&gt;&gt;&gt; timeline.get_cut(cut_id).mix_strategy</span>
<span class="sd">&#39;over&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre>
</div>
</div>
</div>
<p>This fails because <code>right_mouse_down</code> still prints its label. I remove the print and it now fails because <code>Timeline.get_cut</code> is not defined. I add it and get the correct failure:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>Failed example:
    timeline.get_cut(cut_id).mix_strategy
Differences (ndiff with -expected +actual):
    - &#39;over&#39;
    + &#39;under&#39;
</pre>
</div>
</div>
</div>
<p>The original mix strategy is <code>over</code> and this test should have changed it to <code>under</code>, but it didn’t. Let’s fix that. As I try to get this test to pass, I get many test failures. The failures guide me what to do next. This method is not defined. Define it. This name does not exist. Fix spell error. I eventually end up with this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">right_mouse_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">gui</span><span class="p">):</span>
    <span class="n">cut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rectangle_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cut</span><span class="p">,</span> <span class="n">Cut</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">mix_strategy_updater</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">update</span><span class="p">():</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">new_transaction</span><span class="p">()</span> <span class="k">as</span> <span class="n">transaction</span><span class="p">:</span>
                    <span class="n">transaction</span><span class="o">.</span><span class="n">modify</span><span class="p">(</span><span class="n">cut</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">cut</span><span class="p">:</span>
                        <span class="n">cut</span><span class="o">.</span><span class="n">with_mix_strategy</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">update</span>
        <span class="n">gui</span><span class="o">.</span><span class="n">show_context_menu</span><span class="p">([</span>
            <span class="n">MenuItem</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;over&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">mix_strategy_updater</span><span class="p">(</span><span class="s2">&quot;over&quot;</span><span class="p">)),</span>
            <span class="n">MenuItem</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;under&quot;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">mix_strategy_updater</span><span class="p">(</span><span class="s2">&quot;under&quot;</span><span class="p">)),</span>
        <span class="p">])</span>
</pre>
</div>
</div>
</div>
<p>This makes the test pass and also works beautifully in the application. Let’s commit:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;Can change mix strategy of clip with context menu.&#39;</span>
................................................
----------------------------------------------------------------------
Ran <span class="m">48</span> tests <span class="k">in</span> <span class="m">1</span>.956s

OK
<span class="o">[</span>main 776171a<span class="o">]</span> Can change mix strategy of clip with context menu.
 <span class="m">3</span> files changed, <span class="m">26</span> insertions<span class="o">(</span>+<span class="o">)</span>, <span class="m">4</span> deletions<span class="o">(</span>-<span class="o">)</span>
</pre>
</div>
</div>
</div>
<h2 id="summary">Summary</h2>
<p>We now have a way to change the mix strategy of a cut in the GUI. The application is a little more useful now.</p>
<p>Working with third party frameworks, like GTK, I find often slows you down. You need to learn the details of it and it is often difficult to write tests. Therefore I’m quite happy with the abstraction that we created. I want to keep as many classes as possible away from messy GTK code.</p>
]]></description>
    <pubDate>Sat, 29 Jul 2023 00:00:00 UT</pubDate>
    <guid>http://rickardlindberg.me/writing/devlog-002-selecting-cut-type-in-gui/</guid>
    <dc:creator>Rickard Lindberg</dc:creator>
</item>
<item>
    <title>Writing my own video editor</title>
    <link>http://rickardlindberg.me/writing/writing-my-own-video-editor/</link>
    <description><![CDATA[<h1>Writing my own video editor</h1>

<p><em>Published on 28 July 2023.</em></p>

<p>On May 28 I write <a href="https://hachyderm.io/@rickardlindberg/110447282439624451">this</a>:</p>
<blockquote>
<p>Got the urge to write my own video editor. Tired of kdenlive’s instability. And I don’t need something that advanced. Reading a bit about the MLT framework makes me think that it might actually be possible to do in a reasonable time.</p>
<p>Sometimes I feel bad for starting more projects than i finish. On the other hand, every project I do teach me something. And I do this (believe it or not) for my enjoyment.</p>
</blockquote>
<p>It happens to me from time to time. I get an idea for something that I want to build. Sometimes the urge goes away. This time it doesn’t.</p>
<h2 id="why-write-a-video-editor">Why write a video editor?</h2>
<p>I like to build things. In particular I like to build things that I have a use for myself.</p>
<p>Currently, I use <a href="https://kdenlive.org/en/">Kdenlive</a> as my video editor. It has served me well. However, every time I work with it, I get a little frustrated. It often crashes on me, it often feels slow, and there are certain things that I want to do that I don’t know how.</p>
<p>The normal way of solving those problems I think would include</p>
<ul>
<li>Trying the latest version of Kdenlive (would require me to upgrade Fedora version as well)</li>
<li>Buying a faster computer</li>
<li>Learning Kdenlive better</li>
</ul>
<p>But I can program, and I like to build things. So from that point of view, the obvious solution is to build my own video editor specifically for my needs.</p>
<p>Even if it ends up being unusable as my video editor, I will have had a good time working on it and most likely learned a thing or two.</p>
<h2 id="more-ideas">More ideas</h2>
<p>On June 16 I sketch the following in my notebook:</p>
<p>
<center>
<img src="sketch-initial.png" title="fig:" alt="Initial sketch of a timeline." />
</center>
</p>
<p>I think about how to represent clips on a timeline in my ideal video editor. This sketch also tells me that the urge has not gone away.</p>
<h2 id="researching-mlt">Researching MLT</h2>
<p>Writing a video editor seems like a daunting task. The only reason that I think it will be possible is with help from <a href="https://www.mltframework.org/">MLT</a>. From their website:</p>
<blockquote>
<p>MLT is an open source multimedia framework, designed and developed for television broadcasting. It provides a toolkit for broadcasters, video editors, media players, transcoders, web streamers and many more types of applications.</p>
</blockquote>
<p>So a lot of the heavy lifting of a video editor can be done by MLT. That is my guess and hope anyway. What I can focus on is writing a nice frontend for it.</p>
<p>Instead of speculating, I do some spikes to learn how to use MLT from Python.</p>
<p>Here is one example how to put two clips next to each other on a timeline and preview the result:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">mlt</span>

<span class="n">mlt</span><span class="o">.</span><span class="n">Factory</span><span class="p">()</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>
<span class="n">profile</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
<span class="n">playlist</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Playlist</span><span class="p">()</span>
<span class="n">playlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Producer</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="s2">&quot;VID_20230611_120041.mp4&quot;</span><span class="p">))</span>
<span class="n">playlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mlt</span><span class="o">.</span><span class="n">Producer</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="s2">&quot;VID_20230611_115932.mp4&quot;</span><span class="p">))</span>
<span class="n">consumer</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Consumer</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="s2">&quot;sdl&quot;</span><span class="p">)</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;rescale&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">)</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">playlist</span><span class="p">)</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">while</span> <span class="n">consumer</span><span class="o">.</span><span class="n">is_stopped</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
<p>More examples from my spikes can be found <a href="https://github.com/rickardlindberg/rlvideo/blob/91dd25a0d39cbe25e8ce85157115d023b4d2c78c/spikes/mlt_hello_world.py">here</a>.</p>
<p>To help me do the spikes, I use the following resources:</p>
<ul>
<li><p><a href="https://www.mltframework.org/docs/framework/">MLT Framework Design</a>: A good introduction to how MLT works.</p></li>
<li><p><a href="https://github.com/mltframework/mlt/tree/master/src/swig/python">Python examples</a>: Examples how to use MLT from Python. They are quite limited, but give you a good starting point.</p></li>
<li><p><a href="https://www.mltframework.org/doxygen/annotated.html">MLT API documentation</a>: The C API documentation. Translating this to Python has been mostly straight forward.</p></li>
<li><p><a href="https://github.com/jliljebl/flowblade">Flowblade</a>: Another video editor that is written in Python and MLT.</p></li>
</ul>
<h2 id="design-idea">Design idea</h2>
<p>By doing the spikes, I have a basic understanding of how to use MLT and how it could be used to build a video editor.</p>
<p>The design I have in mind for the video editor looks something like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">class</span> <span class="nc">Timeline</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clips</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clip</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clips</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">clip</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_mlt_producer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="o">...</span>
</pre>
</div>
</div>
</div>
<p>That is, I want to use custom data structures for representing clips on a timeline. I think that will give us a design which is clean and easy to work with. We can design those structures to be good for the kinds of operations that we want to perform.</p>
<p>However, somehow those structures must be turned into an MLT producer. That is what <code>to_mlt_producer</code> is for. Transforming from our world into the MLT world. When we have an MLT producer, we can preview the composition and render a final result. But all the edit operations will be done on our custom data structures.</p>
<h2 id="timeline-representation">Timeline representation</h2>
<p>So what representation of clips is best? It depends on how it’s going to be used. How do I want to work with clips on a timeline in my ideal video editor?</p>
<p>On June 28 I sketch this:</p>
<p>
<center>
<img src="sketch-timeline-visualization.png" title="fig:" alt="Sketch of a timeline visualization of overlap." />
</center>
</p>
<p>And on June 30 I sketch this:</p>
<p>
<center>
<img src="sketch-split-sections.png" title="fig:" alt="Sketch of a timeline splits." />
</center>
</p>
<p>I don’t think that I want to have multiple tracks in the timeline. There should only be one track. When clips overlap, multiple tracks might be created in the background, but the user should not need to create tracks manually.</p>
<p>The sketches help me figure this out.</p>
<p>I think that we can have one structure with all the clips and their positions. Then we can split those up into sections. One type of section has no overlaps, and the other do. Overlaps must be handled differently. They both render differently (stacked on top of each other) and they must produce multiple MLT tracks in the background.</p>
<p>I work on this section splitting code and end up with this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&gt;&gt;&gt; a = Source(&quot;A&quot;).create_cut(0, 20).at(0)</span>
<span class="sd">&gt;&gt;&gt; b = Source(&quot;b&quot;).create_cut(0, 20).at(10)</span>
<span class="sd">&gt;&gt;&gt; cuts = Cuts()</span>
<span class="sd">&gt;&gt;&gt; cuts = cuts.add(a)</span>
<span class="sd">&gt;&gt;&gt; cuts = cuts.add(b)</span>
<span class="sd">&gt;&gt;&gt; cuts.split_into_sections().to_ascii_canvas()</span>
<span class="sd">|&lt;-A0------|--A10----&gt;|--b10----&gt;|</span>
<span class="sd">|          |&lt;-b0------|          |</span>
<span class="sd">&gt;&gt;&gt; cuts.modify(b, lambda cut: cut.move(1)).split_into_sections().to_ascii_canvas()</span>
<span class="sd">|&lt;-A0-------|--A11---&gt;|--b9------&gt;|</span>
<span class="sd">|           |&lt;-b0-----|           |</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre>
</div>
</div>
</div>
<p>The <code>to_ascii_canvas</code> is only used in tests to give me faster feedback on the splitting code. It also documents quite nicely what the timeline would look like in different situations.</p>
<h2 id="putting-it-together">Putting it together</h2>
<p>I spend quite some time getting the splitting of cuts to work. Even before I know if this design will work out. (Not very smart.) We know if it will work out when we put everything together.</p>
<p>I first try to put everything together in a Pygame application, but it gives me all kinds of problems, so I decide to try GTK instead.</p>
<p>The application has two parts: one that shows the timeline, and one that shows the preview window.</p>
<p>The timeline is created something like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">timeline_draw</span><span class="p">(</span><span class="n">widget</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="n">sections</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
<span class="n">timeline</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">DrawingArea</span><span class="p">()</span>
<span class="n">timeline</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;draw&quot;</span><span class="p">,</span> <span class="n">timeline_draw</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
<p>It hooks up the draw event and lets the sections (created by <code>split_into_sections</code>) do all the drawing.</p>
<p>The preview window is created something like this:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="n">preview</span> <span class="o">=</span> <span class="n">Gtk</span><span class="o">.</span><span class="n">DrawingArea</span><span class="p">()</span>
<span class="n">os</span><span class="o">.</span><span class="n">putenv</span><span class="p">(</span><span class="s2">&quot;SDL_WINDOWID&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">preview</span><span class="o">.</span><span class="n">get_window</span><span class="p">()</span><span class="o">.</span><span class="n">get_xid</span><span class="p">()))</span>
<span class="n">consumer</span> <span class="o">=</span> <span class="n">mlt</span><span class="o">.</span><span class="n">Consumer</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="s2">&quot;sdl&quot;</span><span class="p">)</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">consumer</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sections</span><span class="o">.</span><span class="n">to_mlt_producer</span><span class="p">(</span><span class="n">profile</span><span class="p">))</span>
</pre>
</div>
</div>
</div>
<p>It connects the SDL consumer to the preview window and the producer (created by <code>to_mlt_producer</code>) to the consumer. I learn how to make the SDL consumer draw its output inside a GTK window by looking at the Flowblade source code.</p>
<p>I get a basic version of <code>Sections.draw</code> and <code>Sections.to_mlt_producer</code> and end up with this on July 3:</p>
<p>
<center>
<img src="current-status.png" title="fig:" alt="Current look of application." />
</center>
</p>
<h2 id="future">Future</h2>
<p>At this point we have a sort of proof of concept of the design. We can now</p>
<ul>
<li>Programmaticlly load clips into a timeline data structure.</li>
<li>This structure can draw itself onto a Cairo context which we can use to render it inside a GTK application.</li>
<li>This structure can also generate an MLT producer which we can use to preview the composition using the SDL consumer and have the output shown in a window in our GTK application via <code>SDL_WINDOWID</code>.</li>
</ul>
<p>One thing that I worry about with this design is performance. Every time we modify the timeline, we have to generate a new sections object and from that generate a new MLT producer. That might take time. My hope and guess is that we can do smart things to get good enough performance. But it is worth looking into to quite soon to ensure that this design will hold even for larger projects.</p>
<p>There for sure are many, many more details to flesh out before we have a functioning video editor. But I’m quite pleased that we have gotten this far in this quite short amount of time.</p>
<p>You can find the source code on <a href="https://github.com/rickardlindberg/rlvideo">GitHub</a>.</p>
]]></description>
    <pubDate>Fri, 28 Jul 2023 00:00:00 UT</pubDate>
    <guid>http://rickardlindberg.me/writing/writing-my-own-video-editor/</guid>
    <dc:creator>Rickard Lindberg</dc:creator>
</item>
<item>
    <title>How to get fast feedback on graphical code?</title>
    <link>http://rickardlindberg.me/writing/fast-feedback-on-graphical-code/</link>
    <description><![CDATA[<h1>How to get fast feedback on graphical code?</h1>

<p><em>Published on 28 July 2023.</em></p>

<p>I am working on <a href="/writing/writing-my-own-video-editor/index.html">my own video editor</a>. It currently looks like this:</p>
<p>
<center>
<img src="rlvideo.png" title="fig:" alt="Current state of video editor." />
</center>
</p>
<p>The bottom pane shows the timeline with all the clips. It is a <code>Gtk.DrawingArea</code> where all the drawing is done using Cairo.</p>
<p>When I work on the drawing code, I want fast feedback on it. Does it look good? Does it draw as intended?</p>
<p>Usually I use TDD for this kind of feedback, but graphical output it hard to test.</p>
<p>In the beginning, I used to run the application after every change. This was quite fast because the application is still small and I can start it up with a sample timeline quite quickly. However, it still takes a few seconds and a couple of keystrokes.</p>
<p>Then I came up with a much better workflow.</p>
<p>I added a (doc)test to my test suite that does something like this (some details removed):</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&gt;&gt;&gt; surface = cairo.ImageSurface(cairo.FORMAT_ARGB32, width, height)</span>
<span class="sd">&gt;&gt;&gt; context = cairo.Context(surface)</span>
<span class="sd">&gt;&gt;&gt; project = Project.new()</span>
<span class="sd">&gt;&gt;&gt; with project.new_transaction() as transaction:</span>
<span class="sd">...     _ = transaction.add_text_clip(&quot;hello&quot;, length=30)</span>
<span class="sd">...     x = transaction.add_text_clip(&quot;world&quot;, length=35)</span>
<span class="sd">...     _ = transaction.add_text_clip(&quot;end&quot;, length=20)</span>
<span class="sd">...     _ = transaction.add_text_clip(&quot;end&quot;, length=20)</span>
<span class="sd">...     transaction.modify(x, lambda cut: cut.move(-10))</span>
<span class="sd">&gt;&gt;&gt; timeline = Timeline(project)</span>
<span class="sd">&gt;&gt;&gt; timeline.draw_cairo(</span>
<span class="sd">...     context=context,</span>
<span class="sd">...     playhead_position=40,</span>
<span class="sd">...     width=width,</span>
<span class="sd">...     height=height</span>
<span class="sd">... )</span>
<span class="sd">&gt;&gt;&gt; surface.write_to_png(&quot;timeline.png&quot;)</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre>
</div>
</div>
</div>
<p>The <code>Timeline</code> class is what does the drawing of the timeline. Fortunately, it is separated from the GTK component onto which it is drawn. This allows us to create our own Cairo surface, let the timeline draw itself on that, and in the end, write that surface to a file.</p>
<p>Every time we run the test suite (which I like to do automatically on every save) we get a new <code>timeline.png</code> file where the example clips that we populated in the test are drawn. If we open this file in the GNOME image viewer (<code>eog timeline.png</code>) it will automatically reload the image when it changes.</p>
<p>In this workflow, this is my typical setup:</p>
<p>
<center>
<img src="workflow1.png" title="fig:" alt="Workflow setup." />
</center>
</p>
<p>I have my editor to the right, the automatic test suite runner in the top left, and the timeline image in the bottom left.</p>
<p>In this example I draw two timelines with different zoom levels so that I can quickly see how that looks.</p>
<p>Then I can make a change to some color for example, and within a second or two, my test suite has automatically run and my desktop looks like this:</p>
<p>
<center>
<img src="workflow2.png" title="fig:" alt="Workflow after a change." />
</center>
</p>
<p>I can tweak numbers until I think it looks good and I never have to leave my editor.</p>
]]></description>
    <pubDate>Fri, 28 Jul 2023 00:00:00 UT</pubDate>
    <guid>http://rickardlindberg.me/writing/fast-feedback-on-graphical-code/</guid>
    <dc:creator>Rickard Lindberg</dc:creator>
</item>
<item>
    <title>DevLog 001: J-cuts and L-cuts in my video editor?</title>
    <link>http://rickardlindberg.me/writing/devlog-001-jcut-lcut/</link>
    <description><![CDATA[<h1>DevLog 001: J-cuts and L-cuts in my video editor?</h1>

<p><em>Published on 28 July 2023.</em></p>

<h2 id="about-devlogs">About DevLogs</h2>
<p>DevLogs is an experiment to try to document development that I do on various projects. I will try to write what is going on in my head as I do various development tasks.</p>
<h2 id="todays-problem">Today’s problem</h2>
<p>In my video editor, there is a problem with overlapping clips. How they overlap appears to be almost random.</p>
<p>In this edit, the <code>two.mp4</code> clip is rendered below:</p>
<p>
<center>
<img src="edit1.png" title="fig:" alt="Alternative text." />
</center>
</p>
<p>If we edit the <code>one.mp4</code> clip, then the two switch order.</p>
<p>
<center>
<img src="edit2.png" title="fig:" alt="Alternative text." />
</center>
</p>
<p>So the order depends on the modification times of clips.</p>
<p>That is not very good.</p>
<h2 id="plan">Plan</h2>
<p>My idea for how to solve this is that each clip can specify how it should be cut into the previous one.</p>
<p>I imagine a library of cuts such as:</p>
<ul>
<li>over</li>
<li>under</li>
<li>j-cut</li>
<li>l-cut</li>
<li>overlay (with priority)</li>
<li>background (with priority)</li>
</ul>
<p>To make progress on this, we can probably assume a default cut (maybe under) and make sure it works. Then we can extend the library of cuts.</p>
<h2 id="writing-a-test">Writing a test</h2>
<p>The relevant code for this is mostly here:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">extract_mix_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &gt;&gt;&gt; cuts = Cuts.from_list([</span>
<span class="sd">    ...     Cut.test_instance(name=&quot;A&quot;, start=0, end=8, position=1),</span>
<span class="sd">    ...     Cut.test_instance(name=&quot;B&quot;, start=0, end=8, position=5),</span>
<span class="sd">    ... ])</span>
<span class="sd">    &gt;&gt;&gt; cuts.to_ascii_canvas()</span>
<span class="sd">    | &lt;-A0---&gt;    |</span>
<span class="sd">    |     &lt;-B0---&gt;|</span>
<span class="sd">    &gt;&gt;&gt; cuts.extract_mix_section(Region(start=0, end=15)).to_ascii_canvas()</span>
<span class="sd">    %&lt;-A0---&gt;%%%%%%</span>
<span class="sd">    %%%%%&lt;-B0---&gt;%%</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: sort based on cut (j-cut, l-cut, overlay, background).</span>
    <span class="n">playlists</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_cut</span><span class="p">(</span><span class="n">region</span><span class="p">)</span><span class="o">.</span><span class="n">cut_map</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">playlists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Cuts</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span><span class="o">.</span><span class="n">extract_playlist_section</span><span class="p">(</span><span class="n">region</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">MixSection</span><span class="p">(</span><span class="n">length</span><span class="o">=</span><span class="n">region</span><span class="o">.</span><span class="n">length</span><span class="p">,</span> <span class="n">playlists</span><span class="o">=</span><span class="n">playlists</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
<p>Let’s write a test that shows the current behavior first:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&gt;&gt;&gt; region = Region(start=0, end=15)</span>
<span class="sd">&gt;&gt;&gt; a_cut = Cut.test_instance(name=&quot;A&quot;, start=0, end=8, position=1)</span>
<span class="sd">&gt;&gt;&gt; b_cut = Cut.test_instance(name=&quot;B&quot;, start=0, end=8, position=5)</span>

<span class="sd">&gt;&gt;&gt; Cuts.from_list([</span>
<span class="sd">...     a_cut,</span>
<span class="sd">...     b_cut,</span>
<span class="sd">... ]).extract_mix_section(region).to_ascii_canvas()</span>
<span class="sd">%&lt;-A0---&gt;%%%%%%</span>
<span class="sd">%%%%%&lt;-B0---&gt;%%</span>

<span class="sd">&gt;&gt;&gt; Cuts.from_list([</span>
<span class="sd">...     b_cut,</span>
<span class="sd">...     a_cut,</span>
<span class="sd">... ]).extract_mix_section(region).to_ascii_canvas()</span>
<span class="sd">%%%%%&lt;-B0---&gt;%%</span>
<span class="sd">%&lt;-A0---&gt;%%%%%%</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre>
</div>
</div>
</div>
<p>So depending on the order in which cuts are added, they mix differently. This is exactly the behavior that we want to change. We want them to mix the same no matter what order they are added in.</p>
<p>Let’s commit this as a baseline:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;Pinpoint current behavior of mixing cuts.&#39;</span>
</pre>
</div>
</div>
</div>
<p>The <code>./make.py commit</code> script is a wrapper around <code>git commit</code> that also runs the tests and makes sure there are no untracked files. A real handy tool to make sure we don’t commit “bad” code.</p>
<h2 id="cut-the-same">Cut the same</h2>
<p>I modify the test above to assert that the same mix is created even when the cuts are in the reverse order.</p>
<p>I make it pass by sorting the clips by start time, making “later” clips appear below which would be the equivalent of having the cut on the second b clip set to “under”:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span><span class="k">def</span> <span class="nf">sort_cuts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cuts</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cuts</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">cut</span><span class="p">:</span> <span class="n">cut</span><span class="o">.</span><span class="n">get_source_cut</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
</pre>
</div>
</div>
</div>
<p>That works as intended in the application as well. Let’s commit:</p>
<div class="rliterate-code">
<div class="rliterate-code-body">
<div class="highlight">
<pre><span></span>$ ./make.py commit -m <span class="s1">&#39;Always mix cuts below previous cut.&#39;</span>
</pre>
</div>
</div>
</div>
<h2 id="clips-with-the-same-start">Clips with the same start</h2>
<p>If two cuts have the same start, the sorting will have no effect and we still have the same problem.</p>
<p>First of all, I don’t think this scenario will be that common in a real situation.</p>
<p>I’m thinking we can handle it with a warning. If such situation appears, the user has to resolve the issue by hinting how the mix should be done.</p>
<p>We can also take the end position into account. Then only cuts with the same start and end has the problem. In which case the user must explicitly tell which should be on top somehow.</p>
<h2 id="summary">Summary</h2>
<p>We made progress towards mixing cuts in a better way. Next step in this area I think is to allow the type of cut to be specified per clip and take that into account when sorting cuts. I think it should be quite easy to write tests for this and we should be able to move steady and carefully using TDD.</p>
]]></description>
    <pubDate>Fri, 28 Jul 2023 00:00:00 UT</pubDate>
    <guid>http://rickardlindberg.me/writing/devlog-001-jcut-lcut/</guid>
    <dc:creator>Rickard Lindberg</dc:creator>
</item>

    </channel>
</rss>
