<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:dc="http://purl.org/dc/elements/1.1/">
    <channel>
        <title>Rickard's personal homepage: latest posts tagged wxpython</title>
        <link>http://rickardlindberg.me</link>
        <description><![CDATA[Rickard's personal homepage: latest posts tagged wxpython]]></description>
        <atom:link href="http://rickardlindberg.me/tags/wxpython/rss.xml" rel="self"
                   type="application/rss+xml" />
        <lastBuildDate>Fri, 03 Apr 2020 00:00:00 UT</lastBuildDate>
        <item>
    <title>Layout/Update problem in wxPython</title>
    <link>http://rickardlindberg.me/writing/wx-layout-update/</link>
    <description><![CDATA[<h1>Layout/Update problem in wxPython</h1>

<p><em>Published on  3 April 2020.</em></p>

<p>When working on <a href="/projects/rliterate/index.html">RLiterate</a> I wanted to speed up drawing to make characters appear faster on the screen after a key press. The <a href="https://docs.wxpython.org/wx.Window.html#wx.Window.Update">Update</a> method seemed to be what I wanted:</p>
<blockquote>
<p>Calling this method immediately repaints the invalidated area of the window and all of its children recursively (this normally only happens when the flow of control returns to the event loop).</p>
</blockquote>
<p>However, using it turned out to be problematic. In this post I present a test program that demonstrates the problem and then discuss a solution.</p>
<ul>
<li><a href="#d72b284e97a449ed9a66e227cd8c3a57">Overview</a></li>
<li><a href="#a4dfb24232ad4cbba0231c02ee01ac05">Test program</a></li>
<li><a href="#7bc0a753f4b74abca1ce3667a620d138">Results</a></li>
<li><a href="#82457fb8605149e6a5e1b079971cbf9e">Discussion</a></li>
<li><a href="#3e79fd9904854dc2bd273d633931b05d">Complete test program</a></li>
</ul>
<h2 id="overview"><span id="d72b284e97a449ed9a66e227cd8c3a57"></span>Overview</h2>
<p>The test program lays out a few widgets vertically. First a button that triggers a change in layout, then a text widget surrounded by two panels to more clearly indicate the size of the text widget. It looks like this:</p>
<p><img src="image1.png" /></p>
<!-- image text -->
<center>
Tests program.
</center>
<p>When the button is clicked, the size of the text widget is increased followed by a call to <code>Layout</code> and <code>Update</code> on the frame. I would expect the frame to redraw immediately at this point, but it doesn't. At least not correctly.</p>
<h2 id="test-program"><span id="a4dfb24232ad4cbba0231c02ee01ac05"></span>Test program</h2>
<p>The structure of the test program looks like this:</p>
<pre><code>1.  testlayout.py</code></pre>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="im">import</span> wx</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a><span class="im">import</span> time</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="kw">class</span> TestFrame(wx.Frame):</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    <span class="op">&lt;&lt;</span>TestFrame<span class="op">&gt;&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a><span class="kw">class</span> Text(wx.Panel):</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>    <span class="op">&lt;&lt;</span>Text<span class="op">&gt;&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">&quot;__main__&quot;</span>:</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>    app <span class="op">=</span> wx.App()</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>    frame <span class="op">=</span> TestFrame()</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>    frame.Show()</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>    app.MainLoop()</span></code></pre></div>
<p>If you prefer the read the complete test program, go to <a href="#3e79fd9904854dc2bd273d633931b05d"><em>Complete test program</em></a>.</p>
<p>The <code>__init__</code> method of the test frame lays out the widgets using a vertical sizer and hooks up the click event.</p>
<pre><code>1.  testlayout.py
2.  [TestFrame]{.cp}</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>    wx.Frame.<span class="fu">__init__</span>(<span class="va">self</span>, <span class="va">None</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>    <span class="va">self</span>.button <span class="op">=</span> wx.Button(<span class="va">self</span>, label<span class="op">=</span><span class="st">&quot;increase text size&quot;</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>    <span class="va">self</span>.button.Bind(wx.EVT_BUTTON, <span class="va">self</span>._on_increase_size_click)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>    <span class="va">self</span>.top <span class="op">=</span> wx.Panel(<span class="va">self</span>, size<span class="op">=</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">20</span>))</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>    <span class="va">self</span>.top.SetBackgroundColour(<span class="st">&quot;yellow&quot;</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>    <span class="va">self</span>.text <span class="op">=</span> Text(<span class="va">self</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>    <span class="va">self</span>.bottom <span class="op">=</span> wx.Panel(<span class="va">self</span>, size<span class="op">=</span>(<span class="op">-</span><span class="dv">1</span>, <span class="dv">20</span>))</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>    <span class="va">self</span>.bottom.SetBackgroundColour(<span class="st">&quot;pink&quot;</span>)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>    <span class="va">self</span>.Sizer <span class="op">=</span> wx.BoxSizer(wx.VERTICAL)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>    <span class="va">self</span>.Sizer.Add(</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a>        <span class="va">self</span>.button,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>        border<span class="op">=</span><span class="dv">5</span>, proportion<span class="op">=</span><span class="dv">0</span>, flag<span class="op">=</span>wx.EXPAND<span class="op">|</span>wx.ALL</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>    )</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>    <span class="va">self</span>.Sizer.Add(</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>        <span class="va">self</span>.top,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>        border<span class="op">=</span><span class="dv">5</span>, proportion<span class="op">=</span><span class="dv">0</span>, flag<span class="op">=</span>wx.EXPAND<span class="op">|</span>wx.ALL</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a>    )</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>    <span class="va">self</span>.Sizer.Add(</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>        <span class="va">self</span>.text,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>        border<span class="op">=</span><span class="dv">5</span>, proportion<span class="op">=</span><span class="dv">0</span>, flag<span class="op">=</span>wx.EXPAND<span class="op">|</span>wx.ALL</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a>    )</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a>    <span class="va">self</span>.Sizer.Add(</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a>        <span class="va">self</span>.bottom,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a>        border<span class="op">=</span><span class="dv">5</span>, proportion<span class="op">=</span><span class="dv">0</span>, flag<span class="op">=</span>wx.EXPAND<span class="op">|</span>wx.ALL</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>    )</span></code></pre></div>
<p>The click event handler increases the size of the text widget and tries to do an immediate update. The sleep is there to see if the update is delayed or not.</p>
<pre><code>1.  testlayout.py
2.  [TestFrame]{.cp}</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">def</span> _on_increase_size_click(<span class="va">self</span>, event):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;Click&quot;</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a>    <span class="va">self</span>.text.increase_size()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>    <span class="va">self</span>.Layout()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;Update&quot;</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>    <span class="va">self</span>.Update()</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>    time.sleep(<span class="dv">2</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;Update done&quot;</span>)</span></code></pre></div>
<p>The <code>__init__</code> method of the text widget sets an initial size and hooks up paint and size events.</p>
<pre><code>1.  testlayout.py
2.  [Text]{.cp}</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, parent):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>    wx.Panel.<span class="fu">__init__</span>(<span class="va">self</span>, parent)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>    <span class="va">self</span>.min_h <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>    <span class="va">self</span>.increase_size()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>    <span class="va">self</span>.Bind(wx.EVT_PAINT, <span class="va">self</span>._on_paint)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>    <span class="va">self</span>.Bind(wx.EVT_SIZE, <span class="va">self</span>._on_size)</span></code></pre></div>
<p>The <code>increase_size</code> method increases the height and sets a new min size.</p>
<pre><code>1.  testlayout.py
2.  [Text]{.cp}</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">def</span> increase_size(<span class="va">self</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a>    <span class="va">self</span>.min_h <span class="op">+=</span> <span class="dv">10</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>    <span class="va">self</span>.SetMinSize((<span class="op">-</span><span class="dv">1</span>, <span class="va">self</span>.min_h))</span></code></pre></div>
<p>The paint event handler draws a bunch of lines of text and also prints the rectangles that were invalidated.</p>
<pre><code>1.  testlayout.py
2.  [Text]{.cp}</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">def</span> _on_paint(<span class="va">self</span>, event):</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;repaint text&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>    upd <span class="op">=</span> wx.RegionIterator(<span class="va">self</span>.GetUpdateRegion())</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>    <span class="cf">while</span> upd.HaveRects():</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>        <span class="bu">print</span>(<span class="st">&quot;  </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(upd.GetRect()))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>        upd.Next()</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>    dc <span class="op">=</span> wx.PaintDC(<span class="va">self</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>    y <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>    <span class="cf">for</span> x <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">20</span>):</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>        line <span class="op">=</span> <span class="st">&quot;line </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(x)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a>        dc.DrawText(line, <span class="dv">5</span>, y)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a>        y <span class="op">+=</span> dc.GetTextExtent(line)[<span class="dv">1</span>]</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>    event.Skip()</span></code></pre></div>
<p>The size event just prints the new size.</p>
<pre><code>1.  testlayout.py
2.  [Text]{.cp}</code></pre>
<div class="sourceCode" id="cb14"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="kw">def</span> _on_size(<span class="va">self</span>, event):</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>    <span class="bu">print</span>(<span class="st">&quot;resize text </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(event.GetSize()))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>    event.Skip()</span></code></pre></div>
<h2 id="bc0a753f4b74abca1ce3667a620d138results">[]{#7bc0a753f4b74abca1ce3667a620d138}Results</h2>
<p>Here is the output of a button click:</p>
<pre class="text"><code>Click
resize text (396, 20)
Update
repaint text
  (0, 0, 396, 10)
Update done
repaint text
  (0, 0, 396, 20)</code></pre>
<ul>
<li>First, the click event hander is entered.</li>
<li>The text widget properly gets a resize event. (My guess is as a result of the <code>Layout</code> call.)</li>
<li>Then <code>Update</code> is called.</li>
<li>A repaint of the text widget is then done, but the invalidated rectangle is only 10px high. The new height is 20.</li>
<li>After the <code>sleep</code> call, a repaint of the text widget is done again, now with the correct rectangle.</li>
</ul>
<p>So in practice, nothing is changed on the screen until after the sleep call.</p>
<p>It seems to me that the <code>Layout</code> call depends on something happening by following events. Adding a <code>Refresh</code> call immediately after <code>Layout</code> does not seem to have any effect.</p>
<p><strong>Why does the immediate repaint don't get the correct size?</strong></p>
<h2 id="fb8605149e6a5e1b079971cbf9ediscussion">[]{#82457fb8605149e6a5e1b079971cbf9e}Discussion</h2>
<p>I asked about this problem in the <a href="https://discuss.wxpython.org/t/problem-updating-widget-immediately-with-layout-and-update">wxPython discussion forum</a> and got the following response from Robin Dunn:</p>
<blockquote>
<p>Almost all of time using <code>Update</code> is not needed, and sometimes it can be a little detrimental. For example, on OSX there is a pipeline of operations to move display details from all of the running applications to the screen. This is highly optimized and works to keep the screen updated and appearing very smooth and crisp and keeping the applications efficient. When an application does something like drawing to a DC without a paint event, or forcing a paint event at the wrong moment, then that pipeline is interrupted to do that drawing and then has to be restarted again to redo processing what was interrupted before.</p>
</blockquote>
<blockquote>
<p>So, in other words, in almost all cases using <code>Refresh</code> or <code>RefreshRect</code> when needed, and letting the drawing happen in naturally occurring paint events is usually the best choice. The platforms are already highly optimized for this and have been fine tuned for decades to make it the best it can be.</p>
</blockquote>
<p>So it seems like <code>Update</code> is platform dependant and it's best to just don't use it.</p>
<p>My solution for a faster redraw instead became to only draw the part where the cursor is first, and draw everything else a few milliseconds later if there are no additional input events. For example, if a title is edited in the workspace, the table of contents might have to be redrawn as well. But it can wait, since the focus is not on it right now.</p>
<p>As a bonus, I found this wiki page that was quite useful: <a href="https://wiki.wxpython.org/WhenAndHowToCallLayout">WhenAndHowToCallLayout</a>.</p>
<h2 id="e79fd9904854dc2bd273d633931b05dcomplete-test-program">[]{#3e79fd9904854dc2bd273d633931b05d}Complete test program</h2>
<pre class="text"><code>import wx
import time

class TestFrame(wx.Frame):

    def __init__(self):
        wx.Frame.__init__(self, None)
        self.button = wx.Button(self, label=&quot;increase text size&quot;)
        self.button.Bind(wx.EVT_BUTTON, self._on_increase_size_click)
        self.top = wx.Panel(self, size=(-1, 20))
        self.top.SetBackgroundColour(&quot;yellow&quot;)
        self.text = Text(self)
        self.bottom = wx.Panel(self, size=(-1, 20))
        self.bottom.SetBackgroundColour(&quot;pink&quot;)
        self.Sizer = wx.BoxSizer(wx.VERTICAL)
        self.Sizer.Add(
            self.button,
            border=5, proportion=0, flag=wx.EXPAND|wx.ALL
        )
        self.Sizer.Add(
            self.top,
            border=5, proportion=0, flag=wx.EXPAND|wx.ALL
        )
        self.Sizer.Add(
            self.text,
            border=5, proportion=0, flag=wx.EXPAND|wx.ALL
        )
        self.Sizer.Add(
            self.bottom,
            border=5, proportion=0, flag=wx.EXPAND|wx.ALL
        )

    def _on_increase_size_click(self, event):
        print(&quot;&quot;)
        print(&quot;Click&quot;)
        self.text.increase_size()
        self.Layout()
        print(&quot;Update&quot;)
        self.Update()
        time.sleep(2)
        print(&quot;Update done&quot;)

class Text(wx.Panel):

    def __init__(self, parent):
        wx.Panel.__init__(self, parent)
        self.min_h = 0
        self.increase_size()
        self.Bind(wx.EVT_PAINT, self._on_paint)
        self.Bind(wx.EVT_SIZE, self._on_size)

    def increase_size(self):
        self.min_h += 10
        self.SetMinSize((-1, self.min_h))

    def _on_paint(self, event):
        print(&quot;repaint text&quot;)
        upd = wx.RegionIterator(self.GetUpdateRegion())
        while upd.HaveRects():
            print(&quot;  {}&quot;.format(upd.GetRect()))
            upd.Next()
        dc = wx.PaintDC(self)
        y = 0
        for x in range(20):
            line = &quot;line {}&quot;.format(x)
            dc.DrawText(line, 5, y)
            y += dc.GetTextExtent(line)[1]
        event.Skip()

    def _on_size(self, event):
        print(&quot;resize text {}&quot;.format(event.GetSize()))
        event.Skip()

if __name__ == &quot;__main__&quot;:
    app = wx.App()
    frame = TestFrame()
    frame.Show()
    app.MainLoop()</code></pre>
]]></description>
    <pubDate>Fri, 03 Apr 2020 00:00:00 UT</pubDate>
    <guid>http://rickardlindberg.me/writing/wx-layout-update/</guid>
    <dc:creator>Rickard Lindberg</dc:creator>
</item>

    </channel>
</rss>
